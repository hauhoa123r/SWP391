<!doctype html>
<html class="theme-fs-sm" data-bs-theme="light" data-bs-theme-color="default" dir="ltr" lang="vi"
      layout:decorate="~{/dashboard/layouts/main-layout}"
      th:with="breadCrumbTitle = ${'Danh sách nhân viên'}, navItem= ${'staff'}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
>
<head>
    <title>Danh sách nhân viên</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="card">
        <div class="card-header">
            <form id="filter" th:object="${staffDTO}">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" for="fullName">Họ tên</label>
                        <input class="form-control" id="fullName" placeholder="Nhập họ tên" th:field="*{fullName}"
                               type="text">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="email">Email</label>
                        <input class="form-control" id="email" placeholder="Nhập email" th:field="*{email}"
                               type="email">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="phoneNumber">Số điện thoại</label>
                        <input class="form-control" id="phoneNumber" placeholder="Nhập số điện thoại"
                               th:field="*{phoneNumber}" type="text">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="departmentEntityId">Phòng ban</label>
                        <select class="form-select" id="departmentEntityId" th:field="*{departmentEntityId}">
                            <option value="">-- Tất cả --</option>
                            <option th:each="dept : ${departments}" th:text="${dept.name}"
                                    th:value="${dept.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="hospitalEntityId">Bệnh viện</label>
                        <select class="form-select" id="hospitalEntityId" th:field="*{hospitalEntityId}">
                            <option value="">-- Tất cả --</option>
                            <option th:each="hos : ${hospitals}" th:text="${hos.name}" th:value="${hos.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="managerFullName">Quản lý</label>
                        <input class="form-control" id="managerFullName" placeholder="Nhập tên quản lý"
                               th:field="*{managerFullName}" type="text">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="staffRole">Vai trò</label>
                        <select class="form-select" id="staffRole" th:field="*{staffRole}">
                            <option value="">-- Tất cả --</option>
                            <option value="DOCTOR">Bác sĩ</option>
                            <option value="TECHNICIAN">Kỹ thuật viên</option>
                            <option value="NURSE">Y tá</option>
                            <option value="SCHEDULING_COORDINATOR">Điều phối lịch</option>
                            <option value="PHARMACIST">Dược sĩ</option>
                            <option value="INVENTORY_MANAGER">Quản lý kho</option>
                            <option value="LAB_RECEIVER">Nhận mẫu xét nghiệm</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="sortField">Sắp xếp theo</label>
                        <select class="form-select" id="sortField" th:field="*{sortFieldName}">
                            <option value="">-- Chọn trường --</option>
                            <option value="fullName">Họ tên</option>
                            <option value="email">Email</option>
                            <option value="phoneNumber">Số điện thoại</option>
                            <option value="departmentEntityId">Phòng ban</option>
                            <option value="hospitalEntityId">Bệnh viện</option>
                            <option value="staffRole">Vai trò</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="sortDirection">Thứ tự</label>
                        <select class="form-select" id="sortDirection" th:field="*{sortDirection}">
                            <option value="ASC">Tăng dần</option>
                            <option value="DESC">Giảm dần</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end justify-content-center text-end">
                        <button class="btn btn-outline-secondary me-2" type="reset">
                            <i class="fas fa-undo me-1"></i> Đặt lại
                        </button>
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search me-1"></i> Tìm kiếm
                        </button>
                    </div>
                </div>
            </form>
            <button aria-controls="addForm" class="btn btn-primary "
                    data-bs-target="#addForm"
                    data-bs-toggle="offcanvas" type="button">
                <span class="btn-inner">
                    <span class="text d-inline-block align-middle">Thêm mới</span>
                    <span class="icon d-inline-block align-middle ms-1 ps-2">
                       <svg fill="none" height="8" viewBox="0 0 8 8" width="8" xmlns="http://www.w3.org/2000/svg">
                          <path
                                  d="M7.32046 4.70834H4.74952V7.25698C4.74952 7.66734 4.41395 8 4 8C3.58605 8 3.25048 7.66734 3.25048 7.25698V4.70834H0.679545C0.293423 4.6687 0 4.34614 0 3.96132C0 3.5765 0.293423 3.25394 0.679545 3.21431H3.24242V0.673653C3.28241 0.290878 3.60778 0 3.99597 0C4.38416 0 4.70954 0.290878 4.74952 0.673653V3.21431H7.32046C7.70658 3.25394 8 3.5765 8 3.96132C8 4.34614 7.70658 4.6687 7.32046 4.70834Z"
                                  fill="currentColor"/>
                       </svg>
                    </span>
                </span>
            </button>
        </div>
        <div class="card-body pt-0">
            <div class="table-responsive">
                <table class="table border-end border-start align-middle mb-0 rounded">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Tên</th>
                        <th>Email</th>
                        <th>Số điện thoại</th>
                        <th>Ngày vào làm</th>
                        <th>Phòng ban</th>
                        <th>Bệnh viện</th>
                        <th>Vai trò</th>
                        <th>Quản lý</th>
                        <th>Hành động</th>
                    </tr>
                    </thead>
                    <tbody id="list"></tbody>
                </table>
            </div>
        </div>
        <div id="pagination"></div>
    </div>

    <!-- Form Sửa -->
    <!-- Form Sửa -->
    <form aria-labelledby="editFormLabel" class="offcanvas offcanvas-end" enctype="multipart/form-data" id="editForm"
          method="post" tabindex="-1" th:object="${staffDTO}">
        <div class="offcanvas-header border-bottom">
            <h3 class="offcanvas-title" id="editFormLabel">Sửa nhân viên</h3>
            <button aria-label="Close" class="btn-close text-reset" data-bs-dismiss="offcanvas" type="button"></button>
        </div>
        <div class="offcanvas-body">
            <input name="id" type="hidden"/>
            <div class="form-group">
                <label class="form-label" for="edit_fullName">Họ tên <span class="text-danger">*</span></label>
                <input class="form-control" id="edit_fullName" placeholder="Nhập họ tên" required th:field="*{fullName}"
                       type="text">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit_email">Email <span class="text-danger">*</span></label>
                <input class="form-control" id="edit_email" placeholder="Nhập email" required
                       th:field="*{email}"
                       type="email">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit_phoneNumber">Số điện thoại <span
                        class="text-danger">*</span></label>
                <input class="form-control" id="edit_phoneNumber" placeholder="Nhập số điện thoại" required
                       th:field="*{phoneNumber}" type="text">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit_departmentEntityId">Phòng ban <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="edit_departmentEntityId" required th:field="*{departmentEntityId}">
                    <option value="">-- Chọn phòng ban --</option>
                    <!-- Lặp phòng ban ở đây -->
                    <option th:each="dept : ${departments}" th:text="${dept.name}" th:value="${dept.id}"></option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit_hospitalEntityId">Bệnh viện <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="edit_hospitalEntityId" required th:field="*{hospitalEntityId}">
                    <option value="">-- Chọn bệnh viện --</option>
                    <!-- Lặp bệnh viện ở đây -->
                    <option th:each="hos : ${hospitals}" th:text="${hos.name}" th:value="${hos.id}"></option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit_staffRole">Vai trò <span class="text-danger">*</span></label>
                <select class="form-select" id="edit_staffRole" required th:field="*{staffRole}">
                    <option value="">-- Chọn vai trò --</option>
                    <option value="DOCTOR">Bác sĩ</option>
                    <option value="TECHNICIAN">Kỹ thuật viên</option>
                    <option value="NURSE">Y tá</option>
                    <option value="SCHEDULING_COORDINATOR">Điều phối lịch</option>
                    <option value="PHARMACIST">Dược sĩ</option>
                    <option value="INVENTORY_MANAGER">Quản lý kho</option>
                    <option value="LAB_RECEIVER">Nhận mẫu xét nghiệm</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit_staffType">Hình thức làm việc <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="edit_staffType" required th:field="*{staffType}">
                    <option value="">-- Chọn hình thức --</option>
                    <option value="PART_TIME_CONTRACT">Hợp đồng bán thời gian</option>
                    <option value="INTERN">Thực tập</option>
                    <option value="CONSULTANT">Tư vấn</option>
                    <option value="FULL_TIME">Toàn thời gian</option>
                </select>
            </div>
        </div>
        <div class="offcanvas-footer border-top">
            <div class="d-grid d-md-flex gap-3 p-3">
                <button class="btn btn-primary d-block" type="submit">Cập nhật</button>
                <button class="btn btn-secondary d-block" data-bs-dismiss="offcanvas" type="button">Đóng</button>
            </div>
        </div>
    </form>

    <!-- Form Thêm mới -->
    <form aria-labelledby="addFormLabel" class="offcanvas offcanvas-end" enctype="multipart/form-data" id="addForm"
          method="post" tabindex="-1" th:object="${staffDTO}">
        <div class="offcanvas-header border-bottom">
            <h3 class="offcanvas-title" id="addFormLabel">Thêm nhân viên</h3>
            <button aria-label="Close" class="btn-close text-reset" data-bs-dismiss="offcanvas" type="button"></button>
        </div>
        <div class="offcanvas-body">
            <div class="form-group">
                <label class="form-label" for="add_fullName">Họ tên <span class="text-danger">*</span></label>
                <input class="form-control" id="add_fullName" placeholder="Nhập họ tên" required th:field="*{fullName}"
                       type="text">
            </div>
            <div class="form-group">
                <label class="form-label" for="add_email">Email <span class="text-danger">*</span></label>
                <input class="form-control" id="add_email" placeholder="Nhập email" required
                       th:field="*{email}"
                       type="email">
            </div>
            <div class="form-group">
                <label class="form-label" for="add_phoneNumber">Số điện thoại <span class="text-danger">*</span></label>
                <input class="form-control" id="add_phoneNumber" placeholder="Nhập số điện thoại" required
                       th:field="*{phoneNumber}" type="text">
            </div>
            <div class="form-group">
                <label class="form-label" for="add_departmentEntityId">Phòng ban <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="add_departmentEntityId" required th:field="*{departmentEntityId}">
                    <option value="">-- Chọn phòng ban --</option>
                    <!-- Lặp phòng ban ở đây -->
                    <option th:each="dept : ${departments}" th:text="${dept.name}" th:value="${dept.id}"></option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="add_hospitalEntityId">Bệnh viện <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="add_hospitalEntityId" required th:field="*{hospitalEntityId}">
                    <option value="">-- Chọn bệnh viện --</option>
                    <!-- Lặp bệnh viện ở đây -->
                    <option th:each="hos : ${hospitals}" th:text="${hos.name}" th:value="${hos.id}"></option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="add_staffRole">Vai trò <span class="text-danger">*</span></label>
                <select class="form-select" id="add_staffRole" required th:field="*{staffRole}">
                    <option value="">-- Chọn vai trò --</option>
                    <option value="DOCTOR">Bác sĩ</option>
                    <option value="TECHNICIAN">Kỹ thuật viên</option>
                    <option value="NURSE">Y tá</option>
                    <option value="SCHEDULING_COORDINATOR">Điều phối lịch</option>
                    <option value="PHARMACIST">Dược sĩ</option>
                    <option value="INVENTORY_MANAGER">Quản lý kho</option>
                    <option value="LAB_RECEIVER">Nhận mẫu xét nghiệm</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="add_staffType">Hình thức làm việc <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="add_staffType" required th:field="*{staffType}">
                    <option value="">-- Chọn hình thức --</option>
                    <option value="PART_TIME_CONTRACT">Hợp đồng bán thời gian</option>
                    <option value="INTERN">Thực tập</option>
                    <option value="CONSULTANT">Tư vấn</option>
                    <option value="FULL_TIME">Toàn thời gian</option>
                </select>
            </div>
        </div>
        <div class="offcanvas-footer border-top">
            <div class="d-grid d-md-flex gap-3 p-3">
                <button class="btn btn-primary d-block" type="submit">Tạo</button>
                <button class="btn btn-secondary d-block" data-bs-dismiss="offcanvas" type="button">Đóng</button>
            </div>
        </div>
    </form>
</th:block>
<th:block layout:fragment="custom-js">
    <script type="module">
        import {CrudUtils} from "/templates/shared/assets/js/utils/crud-utils.js";
        import {
            StaffResponse, renderStaffResponseForAdmin
        } from "/templates/shared/assets/js/model/response/StaffResponse.js";
        import toast from "/templates/shared/assets/js/plugins/toast.js";
        import {FetchingUtils} from "/templates/shared/assets/js/utils/fetching-utils.js";

        async function setStaffToManager(itemElement) {
            const id = itemElement.querySelector("input[name='id']").value;
            const data = await FetchingUtils.fetch(`/api/admin/staff/upgrade/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                }
            }, "text");
            if (data !== null) {
                toast.success("Cập nhật thành công!", {
                    icon: true,
                    progress: true,
                    duration: 3000
                });
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const crudUtils = new CrudUtils({
                apiUrl: "/api/admin/staff",
                responseClass: StaffResponse,
                renderStrategy: renderStaffResponseForAdmin,
                customButtonSelector: ".upgrade-button",
                customButtonEvent: setStaffToManager
            });
            crudUtils.init();
        });
    </script>
</th:block>
</body>
</html>