<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>G√°n Ca Tr·ª±c</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary mb-1">‚ûï G√°n Ca Tr·ª±c M·ªõi</h3>
            <p class="text-muted mb-0">Ph√¢n c√¥ng ca tr·ª±c cho nh√¢n vi√™n</p>
        </div>
        <a href="/admin/staff-shifts" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
        </a>
    </div>

    <!-- Flash Messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Main Form Card -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-clock"></i> Th√¥ng tin ca tr·ª±c
                    </h5>
                </div>
                <div class="card-body">
                    <form action="/admin/staff-shifts/assign" method="post">
                        <div class="row">
                            <!-- Ch·ªçn b·ªánh vi·ªán -->
                            <div class="col-md-4 mb-3">
                                <label for="hospitalId" class="form-label fw-bold">
                                    <i class="fas fa-hospital text-primary"></i> Ch·ªçn B·ªánh Vi·ªán
                                </label>
                                <select class="form-select" id="hospitalId" name="hospitalId" required onchange="filterByHospital()">
                                    <option value="">-- Ch·ªçn b·ªánh vi·ªán --</option>
                                    <option th:each="hospital : ${allHospitals}" 
                                            th:value="${hospital.id}" 
                                            th:text="${hospital.name}"
                                            th:selected="${selectedHospitalId != null && selectedHospitalId == hospital.id}"></option>
                                </select>
                            </div>

                            <!-- Ch·ªçn ph√≤ng ban -->
                            <div class="col-md-4 mb-3">
                                <label for="departmentId" class="form-label fw-bold">
                                    <i class="fas fa-building text-primary"></i> Ch·ªçn Ph√≤ng Ban
                                </label>
                                <select class="form-select" id="departmentId" name="departmentId" required onchange="filterByDepartment()">
                                    <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                                    <option th:each="department : ${allDepartments}" 
                                            th:value="${department.id}" 
                                            th:text="${department.name}"
                                            th:selected="${selectedDepartmentId != null && selectedDepartmentId == department.id}"></option>
                                </select>
                            </div>

                            <!-- Ch·ªçn nh√¢n vi√™n -->
                            <div class="col-md-4 mb-3">
                                <label for="staffId" class="form-label fw-bold">
                                    <i class="fas fa-user-md text-primary"></i> Ch·ªçn Nh√¢n Vi√™n
                                </label>
                                <select class="form-select" id="staffId" name="staffId" required>
                                    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                                    <option th:each="staff : ${allStaff}" 
                                            th:value="${staff.id}" 
                                            th:text="${staff.fullName}"
                                            th:attr="data-department-id=${staff.departmentEntity?.id}, data-hospital-id=${staff.hospitalEntity?.id}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Ch·ªçn ng√†y -->
                            <div class="col-md-6 mb-3">
                                <label for="date" class="form-label fw-bold">
                                    <i class="fas fa-calendar text-primary"></i> Ng√†y L√†m Vi·ªác
                                </label>
                                <input type="date" class="form-control" id="date" name="date" 
                                       th:value="${selectedDate}" required>
                            </div>

                            <!-- Ch·ªçn ca tr·ª±c -->
                            <div class="col-md-6 mb-3">
                                <label for="shiftSlot" class="form-label fw-bold">
                                    <i class="fas fa-clock text-primary"></i> Ca Tr·ª±c
                                </label>
                                <select class="form-select" id="shiftSlot" name="shiftSlot" required>
                                    <option value="">-- Ch·ªçn ca tr·ª±c --</option>
                                    <option th:each="slot : ${shiftSlots}" 
                                            th:value="${slot}" 
                                            th:text="${slot == T(org.project.enums.StaffShiftSlot).MORNING ? 'üåÖ Ca S√°ng (6:00 - 12:00)' : 
                                                     slot == T(org.project.enums.StaffShiftSlot).AFTERNOON ? '‚òÄÔ∏è Ca Chi·ªÅu (12:00 - 18:00)' : 
                                                     slot == T(org.project.enums.StaffShiftSlot).EVENING ? 'üåÜ Ca T·ªëi (18:00 - 24:00)' : 
                                                     'üåô Ca ƒê√™m (24:00 - 6:00)'}"></option>
                                </select>
                            </div>
                        </div>

                        <!-- Th√¥ng tin b·ªï sung -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>L∆∞u √Ω:</strong> 
                            <ul class="mb-0 mt-2">
                                <li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra v√† kh√¥ng cho ph√©p g√°n tr√πng ca tr·ª±c cho c√πng m·ªôt nh√¢n vi√™n trong c√πng ng√†y.</li>
                                <li>M·ªói ca tr·ª±c c√≥ th·ªùi gian c·ªë ƒë·ªãnh nh∆∞ ƒë√£ hi·ªÉn th·ªã.</li>
                                <li>Sau khi g√°n th√†nh c√¥ng, b·∫°n c√≥ th·ªÉ xem l·ªãch th√°ng c·ªßa nh√¢n vi√™n ƒë·ªÉ ki·ªÉm tra.</li>
                            </ul>
                        </div>

                        <!-- Action buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="/admin/staff-shifts" class="btn btn-secondary">
                                <i class="fas fa-times"></i> H·ªßy
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> G√°n Ca Tr·ª±c
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Card -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt"></i> Thao t√°c nhanh
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="/admin/staff-shifts" class="btn btn-outline-primary w-100">
                                <i class="fas fa-list"></i><br>
                                <small>Danh s√°ch ca tr·ª±c</small>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="/admin/staff-shifts/monthly-details" class="btn btn-outline-info w-100">
                                <i class="fas fa-calendar-alt"></i><br>
                                <small>Chi ti·∫øt th√°ng</small>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="/admin/users" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-users"></i><br>
                                <small>Qu·∫£n l√Ω nh√¢n vi√™n</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Store original data for filtering
let originalDepartments = [];
let originalStaff = [];

// Auto-focus on staff selection when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Store original data
    const departmentSelect = document.getElementById('departmentId');
    const staffSelect = document.getElementById('staffId');
    
    if (departmentSelect) {
        originalDepartments = Array.from(departmentSelect.options).map(option => ({
            value: option.value,
            text: option.text
        }));
    }
    
    if (staffSelect) {
        originalStaff = Array.from(staffSelect.options).map(option => ({
            value: option.value,
            text: option.text,
            departmentId: option.getAttribute('data-department-id') || '',
            hospitalId: option.getAttribute('data-hospital-id') || ''
        }));
        staffSelect.focus();
    }
    
    // Set minimum date to today
    const dateInput = document.getElementById('date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);
    }
});

// Filter departments by selected hospital (simplified - show all departments)
function filterByHospital() {
    // Since departments don't have direct hospital relationship,
    // we'll just trigger staff filtering
    filterByDepartment();
}

// Filter staff by selected department and hospital
function filterByDepartment() {
    const hospitalSelect = document.getElementById('hospitalId');
    const departmentSelect = document.getElementById('departmentId');
    const staffSelect = document.getElementById('staffId');
    
    if (!staffSelect) return;
    
    const selectedHospitalId = hospitalSelect ? hospitalSelect.value : '';
    const selectedDepartmentId = departmentSelect ? departmentSelect.value : '';
    
    // Clear staff selection
    staffSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
    
    // Filter and add staff for selected hospital and department
    originalStaff.forEach(staff => {
        let shouldInclude = true;
        
        if (selectedHospitalId && staff.hospitalId !== selectedHospitalId) {
            shouldInclude = false;
        }
        
        if (selectedDepartmentId && staff.departmentId !== selectedDepartmentId) {
            shouldInclude = false;
        }
        
        if (shouldInclude) {
            const option = document.createElement('option');
            option.value = staff.value;
            option.text = staff.text;
            option.setAttribute('data-department-id', staff.departmentId);
            option.setAttribute('data-hospital-id', staff.hospitalId);
            staffSelect.appendChild(option);
        }
    });
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const staffId = document.getElementById('staffId').value;
    const date = document.getElementById('date').value;
    const shiftSlot = document.getElementById('shiftSlot').value;
    
    if (!staffId || !date || !shiftSlot) {
        e.preventDefault();
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return false;
    }
    
    // Confirm before submit
    const staffName = document.getElementById('staffId').selectedOptions[0].text;
    const shiftName = document.getElementById('shiftSlot').selectedOptions[0].text;
    
    if (!confirm(`X√°c nh·∫≠n g√°n ${shiftName} cho ${staffName} v√†o ng√†y ${date}?`)) {
        e.preventDefault();
        return false;
    }
});
</script>

</body>
</html>
