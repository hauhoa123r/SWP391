<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastkart - Quản lý thiết bị y tế</title>

    <!-- CSS Files -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/font-awesome.css}">
    <link rel="stylesheet" th:href="@{/templates_storage/assets/css/linearicon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/themify.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/feather-icon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/remixicon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/datatables.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/bootstrap.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/style.css}">

    <!-- Custom CSS -->
    <style>
        .warehouse-logo {
            font-family: 'Public Sans', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #2e8b57; /* Màu xanh lá cây */
            text-align: center;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        .product-card { border: 1px solid #e0e0e0; border-radius: 8px; transition: all 0.3s; }
        .product-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .stock-low { color: #ff6b6b; font-weight: bold; }
        .stock-normal { color: #51cf66; }
        .workflow-tabs { margin-bottom: 20px; }
        .tab-content { min-height: 400px; }
        .order-item { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; padding: 15px; }
        .order-pending { border-left: 4px solid #ffc107; }
        .order-preparing { border-left: 4px solid #17a2b8; }
        .order-ready { border-left: 4px solid #28a745; }
    </style>
</head>

<body>
<div class="tap-top"><span class="lnr lnr-chevron-up"></span></div>

<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Bắt đầu tiêu đề trang -->
    <div class="page-header">
        <div class="header-wrapper m-0">
            <div class="header-logo-wrapper p-0">
                <div class="logo-wrapper">
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img class="img-fluid main-logo" th:src="@{/templates_storage/assets/images/logo/1.png}" alt="logo">
                        <img class="img-fluid white-logo" th:src="@{/templates_storage/assets/images/logo/1-white.png}" alt="logo">
                    </a>
                </div>
                <div class="toggle-sidebar">
                    <i class="status_toggle middle sidebar-toggle" data-feather="align-center"></i>
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img th:src="@{/templates_storage/assets/images/logo/1.png}" class="img-fluid" alt="">
                    </a>
                </div>
            </div>

            <!-- Tiêu đề mới -->
            <h1 class="warehouse-logo text-center mb-0">Kho Quản Lý</h1>
            <div class="nav-right col-6 pull-right right-header p-0">
                <ul class="nav-menus">
                    <li>
                        <span class="header-search">
                            <i class="ri-search-line"></i>
                        </span>
                    </li>
                    <li class="onhover-dropdown">
                        <div class="notification-box">
                            <i class="ri-notification-line"></i>
                            <span class="badge rounded-pill badge-theme">4</span>
                        </div>
                        <ul class="notification-dropdown onhover-show-div">
                            <li>
                                <i class="ri-notification-line"></i>
                                <h6 class="f-18 mb-0">Thông báo</h6>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-primary"></i>Đang xử lý giao hàng <span
                                        class="pull-right">10 phút</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-success"></i>Hoàn thành đơn hàng <span
                                        class="pull-right">1 giờ</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-info"></i>Tạo vé hỗ trợ <span
                                        class="pull-right">3 giờ</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-danger"></i>Hoàn thành giao hàng <span
                                        class="pull-right">6 giờ</span>
                                </p>
                            </li>
                            <li>
                                <a class="btn btn-primary" href="#">Xem tất cả thông báo</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <div class="mode">
                            <i class="ri-moon-line"></i>
                        </div>
                    </li>
                    <li class="profile-nav onhover-dropdown pe-0 me-0">
                        <div class="media profile-media">
                            <img class="user-profile rounded-circle" th:src="@{/templates_storage/assets/images/users/4.jpg}" alt="">
                            <div class="user-name-hide media-body">
                                <span th:text="${currentUser?.fullName ?: 'Người dùng'}">Người dùng</span>
                                <p class="mb-0 font-roboto"><span th:text="${currentUser?.roleName ?: 'Người dùng'}">Vai trò</span><i class="middle ri-arrow-down-s-line"></i></p>
                            </div>
                        </div>
                        
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Kết thúc tiêu đề trang -->

    <!-- Sidebar -->
    <div class="page-body-wrapper">
        <!-- Bắt đầu thanh bên -->
        <div class="sidebar-wrapper">
            <div id="sidebarEffect"></div>
            <div>
                <div class="logo-wrapper logo-wrapper-center">
                    <a th:href="@{/warehouse/dashboard/main}" data-bs-original-title="" title="">
                        <img class="img-fluid for-white" th:src="@{/templates_storage/assets/images/logo/full-white.png}" alt="logo">
                    </a>
                    <div class="back-btn">
                        <i class="fa fa-angle-left"></i>
                    </div>
                    <div class="toggle-sidebar">
                        <i class="ri-apps-line status_toggle middle sidebar-toggle"></i>
                    </div>
                </div>
                <div class="logo-icon-wrapper">
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img class="img-fluid main-logo main-white" th:src="@{/templates_storage/assets/images/logo/1-white.png}" alt="logo">
                        <img class="img-fluid main-logo main-dark" th:src="@{/templates_storage/assets/images/logo/logo-white.png}"
                             alt="logo">
                    </a>
                </div>
                
                <nav class="sidebar-main">
                    <div class="left-arrow" id="left-arrow">
                        <i data-feather="arrow-left"></i>
                    </div>

                    <div id="sidebar-menu">
                        <ul class="sidebar-links" id="simple-bar">
                            <li class="back-btn"></li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/warehouse/dashboard/main}">
                                    <i class="ri-home-line"></i>
                                    <span>Bảng điều khiển</span>
                                </a>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-store-3-line"></i>
                                    <span>Giao dịch</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/stock-in}">Nhập kho</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/stock-out}">Xuất kho</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-list-check-2"></i>
                                    <span>Hóa đơn</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/invoices/in}">Hóa đơn nhập kho</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/invoices/out}">Hóa đơn xuất kho</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-list-settings-line"></i>
                                    <span>Kho hàng</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/medical-equipment}">Thiết bị y tế</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/medicines}">Thuốc</a>
                                    </li>
                                </ul>
                            </li>
                            
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-price-tag-3-line"></i>
                                    <span>Mã giảm giá</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/coupon-list}">Danh sách mã giảm giá</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/create-coupon}">Tạo mã giảm giá</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/product-review}">
                                    <i class="ri-star-line"></i>
                                    <span>Đánh giá sản phẩm</span>
                                </a>
                            </li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/reports}">
                                    <i class="ri-file-chart-line"></i>
                                    <span>Báo cáo</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="right-arrow" id="right-arrow">
                        <i data-feather="arrow-right"></i>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Kết thúc thanh bên -->

        <!-- Main Content -->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Quản lý thiết bị y tế</h5>
                                <div class="btn-group">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                        <i class="ri-add-line"></i> Thêm thiết bị
                                    </button>
                                </div>
                            </div>

                            <!-- Workflow Tabs -->
                            <div class="workflow-tabs">
                                <ul class="nav nav-tabs" id="workflowTabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="products-tab" data-bs-toggle="tab" href="#products" role="tab">
                                            <i class="ri-box-line"></i> Sản phẩm <span class="badge bg-primary" id="productCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="stock-in-tab" data-bs-toggle="tab" href="#stock-in" role="tab">
                                            <i class="ri-download-line"></i> Đơn nhập <span class="badge bg-success" id="stockInCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="stock-out-tab" data-bs-toggle="tab" href="#stock-out" role="tab">
                                            <i class="ri-upload-line"></i> Đơn xuất <span class="badge bg-warning" id="stockOutCount">0</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <div class="tab-content">
                                <!-- Products Tab -->
                                <div class="tab-pane fade show active" id="products" role="tabpanel">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" id="searchProducts" placeholder="Tìm kiếm thiết bị...">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="categoryFilter">
                                                    <option value="">Tất cả danh mục</option>
                                                    <option value="diagnostic">Chẩn đoán</option>
                                                    <option value="surgical">Phẫu thuật</option>
                                                    <option value="monitoring">Theo dõi</option>
                                                    <option value="laboratory">Phòng thí nghiệm</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="stockFilter">
                                                    <option value="">Tất cả</option>
                                                    <option value="low">Sắp hết hàng</option>
                                                    <option value="normal">Còn hàng</option>
                                                    <option value="out">Hết hàng</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createStockInModal">
                                                    <i class="ri-add-circle-line"></i> Tạo đơn nhập
                                                </button>
                                            </div>
                                        </div>

                                        <div class="row" id="productsGrid">
                                            <!-- Display medical equipment from database -->
                                            <div th:each="equipment : ${equipments}" class="col-md-4 col-sm-6 mb-4">
                                                <div class="card product-card h-100">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <h6 class="card-title" th:text="${equipment.name}">Máy đo huyết áp</h6>
                                                            <span th:class="${equipment.stockQuantities <= 5 ? 'stock-low' : 'stock-normal'}"
                                                                  th:text="${equipment.stockQuantities + ' ' + equipment.unit}">10 Cái</span>
                                                        </div>
                                                        <p class="card-text small" th:text="${equipment.description}">Thiết bị đo huyết áp tự động</p>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold" th:text="${#numbers.formatDecimal(equipment.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">1,500,000 VNĐ</span>
                                                            <div class="btn-group">
                                                                <button class="btn btn-sm btn-outline-primary" onclick="viewEquipmentDetails(this)" th:data-id="${equipment.id}">
                                                                    <i class="ri-eye-line"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-success" onclick="editEquipment(this)" th:data-id="${equipment.id}">
                                                                    <i class="ri-edit-line"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Show message if no equipment -->
                                            <div th:if="${#lists.isEmpty(equipments)}" class="col-12 text-center py-5">
                                                <i class="ri-stethoscope-line fs-1 text-muted"></i>
                                                <p class="mt-3">Không có thiết bị y tế nào trong kho. Hãy thêm thiết bị mới.</p>
                                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                                    <i class="ri-add-line"></i> Thêm thiết bị
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock In Tab -->
                                <div class="tab-pane fade" id="stock-in" role="tabpanel">
                                    <div class="card-body">
                                        <h6>Đơn nhập từ StockIn cần xử lý</h6>
                                        <div id="stockInOrders">
                                            <!-- Stock in orders will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock Out Tab -->
                                <div class="tab-pane fade" id="stock-out" role="tabpanel">
                                    <div class="card-body">
                                        <h6>Đơn xuất từ StockOut cần chuẩn bị</h6>
                                        <div id="stockOutOrders">
                                            <!-- Stock out orders will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm thiết bị y tế</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="mb-3">
                        <label class="form-label">Tên thiết bị</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã thiết bị</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" required>
                            <option value="">Chọn danh mục</option>
                            <option value="diagnostic">Chẩn đoán</option>
                            <option value="surgical">Phẫu thuật</option>
                            <option value="monitoring">Theo dõi</option>
                            <option value="laboratory">Phòng thí nghiệm</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tồn kho</label>
                        <input type="number" class="form-control" name="stock" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn giá</label>
                        <input type="number" class="form-control" name="price" min="0" step="1000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tối thiểu</label>
                        <input type="number" class="form-control" name="minStock" min="0" value="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa thiết bị</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Tên thiết bị</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã thiết bị</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" required>
                            <option value="diagnostic">Chẩn đoán</option>
                            <option value="surgical">Phẫu thuật</option>
                            <option value="monitoring">Theo dõi</option>
                            <option value="laboratory">Phòng thí nghiệm</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tồn kho</label>
                        <input type="number" class="form-control" name="stock" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn giá</label>
                        <input type="number" class="form-control" name="price" min="0" step="1000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tối thiểu</label>
                        <input type="number" class="form-control" name="minStock" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateProduct()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Stock In Order Modal -->
<div class="modal fade" id="createStockInModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tạo đơn nhập thiết bị y tế</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createStockInForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nhà cung cấp</label>
                                <select class="form-select" name="supplier" required>
                                    <option value="">Chọn nhà cung cấp</option>
                                    <option value="Công ty Thiết bị XYZ">Công ty Thiết bị XYZ</option>
                                    <option value="Công ty Y tế GHI">Công ty Y tế GHI</option>
                                    <option value="Công ty Dụng cụ MNO">Công ty Dụng cụ MNO</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ngày dự kiến nhận</label>
                                <input type="date" class="form-control" name="expectedDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>

                    <h6>Danh sách thiết bị cần nhập</h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>Chọn</th>
                                <th>Thiết bị</th>
                                <th>Tồn kho</th>
                                <th>Số lượng nhập</th>
                                <th>Đơn giá</th>
                            </tr>
                            </thead>
                            <tbody id="stockInProductList">
                            <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="submitStockInOrder()">Tạo đơn nhập</button>
            </div>
        </div>
    </div>
</div>

<!-- Process Stock In Modal -->
<div class="modal fade" id="processStockInModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xử lý nhập kho thiết bị</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="processStockInContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="confirmStockIn()">Xác nhận nhập kho</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Files -->
<script th:src="@{/templates_storage/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/templates_storage/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/templates_storage/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/config.js}"></script>
<script th:src="@{/templates_storage/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/templates_storage/assets/js/chart/apex-chart/apex-chart.js}"></script>
<script th:src="@{/templates_storage/assets/js/chart/apex-chart/stock-prices.js}"></script>
<script th:src="@{/templates_storage/assets/js/chart/apex-chart/chart-custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/dashboard/default.js}"></script>
<script th:src="@{/templates_storage/assets/js/notify/index.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead/handlebars.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead/typeahead.bundle.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead/typeahead.custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead-search/handlebars.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead-search/typeahead-custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/script.js}"></script>

<script>
    // Sample data
    let products = [
        {
            id: 1,
            name: 'Máy đo huyết áp',
            code: 'BP001',
            category: 'monitoring',
            stock: 25,
            price: 1500000,
            minStock: 10,
            description: 'Máy đo huyết áp điện tử'
        },
        {
            id: 2,
            name: 'Máy siêu âm',
            code: 'US001',
            category: 'diagnostic',
            stock: 5,
            price: 8000000,
            minStock: 2,
            description: 'Máy siêu âm 4D'
        },
        {
            id: 3,
            name: 'Máy X-quang',
            code: 'XR001',
            category: 'diagnostic',
            stock: 2,
            price: 15000000,
            minStock: 1,
            description: 'Máy X-quang kỹ thuật số'
        },
        {
            id: 4,
            name: 'Nhiệt kế điện tử',
            code: 'TH001',
            category: 'monitoring',
            stock: 100,
            price: 200000,
            minStock: 50,
            description: 'Nhiệt kế điện tử không tiếp xúc'
        }
    ];

    let stockInOrders = [
        {
            id: 'SI-ME-001',
            supplier: 'Công ty Thiết bị XYZ',
            status: 'received',
            date: '2024-01-15',
            products: [
                {productId: 1, quantity: 20, price: 1500000},
                {productId: 4, quantity: 100, price: 200000}
            ]
        }
    ];

    let stockOutOrders = [
        {
            id: 'SO-ME-001',
            department: 'Khoa Nội',
            status: 'preparing',
            date: '2024-01-16',
            products: [
                {productId: 1, quantity: 5},
                {productId: 4, quantity: 20}
            ]
        }
    ];

    // Initialize page
    $(document).ready(function() {
        loadProducts();
        loadStockInOrders();
        loadStockOutOrders();
        updateCounts();

        // Initialize filters
        $('#searchProducts').on('input', filterProducts);
        $('#categoryFilter').on('change', filterProducts);
        $('#stockFilter').on('change', filterProducts);
    });

    // Load products
    function loadProducts() {
        const grid = $('#productsGrid');
        grid.empty();

        products.forEach(product => {
            const stockStatus = getStockStatus(product.stock, product.minStock);
            const stockClass = stockStatus.class;

            const card = `
                    <div class="col-md-6 col-lg-4 mb-3 product-item" data-category="${product.category}" data-stock="${stockStatus.status}">
                        <div class="card product-card">
                            <div class="card-body">
                                <h6 class="card-title">${product.name}</h6>
                                <p class="card-text">
                                    <small class="text-muted">Mã: ${product.code}</small><br>
                                    <small class="text-muted">Danh mục: ${getCategoryName(product.category)}</small>
                                </p>
                                <div class="row">
                                    <div class="col-6">
                                        <strong class="${stockClass}">Tồn kho: ${product.stock}</strong>
                                    </div>
                                    <div class="col-6 text-end">
                                        <strong>${formatCurrency(product.price)}</strong>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">
                                        <i class="ri-edit-line"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            grid.append(card);
        });
    }

    // Load stock in orders
    function loadStockInOrders() {
        const container = $('#stockInOrders');
        container.empty();

        stockInOrders.forEach(order => {
            const orderDiv = `
                    <div class="order-item order-${order.status}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Đơn nhập: ${order.id}</h6>
                                <p>Nhà cung cấp: ${order.supplierEntity ? order.supplierEntity.name : ''}</p>
                                <p>Ngày: ${order.date}</p>
                                <p>Trạng thái: <span class="badge bg-info">${getOrderStatusText(order.status)}</span></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary btn-sm" onclick="viewStockInOrder('${order.id}')">
                                    <i class="ri-eye-line"></i> Xem
                                </button>
                                <button class="btn btn-success btn-sm" onclick="processStockInOrder('${order.id}')">
                                    <i class="ri-check-line"></i> Xử lý
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            container.append(orderDiv);
        });
    }

    // Load stock out orders
    function loadStockOutOrders() {
        const container = $('#stockOutOrders');
        container.empty();

        stockOutOrders.forEach(order => {
            const orderDiv = `
                    <div class="order-item order-${order.status}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Đơn xuất: ${order.id}</h6>
                                <p>Khoa: ${order.department}</p>
                                <p>Ngày: ${order.date}</p>
                                <p>Trạng thái: <span class="badge bg-warning">${getOrderStatusText(order.status)}</span></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary btn-sm" onclick="viewStockOutOrder('${order.id}')">
                                    <i class="ri-eye-line"></i> Xem
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="prepareStockOutOrder('${order.id}')">
                                    <i class="ri-package-line"></i> Chuẩn bị
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            container.append(orderDiv);
        });
    }

    // Update counts
    function updateCounts() {
        $('#productCount').text(products.length);
        $('#stockInCount').text(stockInOrders.length);
        $('#stockOutCount').text(stockOutOrders.length);
    }

    // Filter products
    function filterProducts() {
        const search = $('#searchProducts').val().toLowerCase();
        const category = $('#categoryFilter').val();
        const stock = $('#stockFilter').val();

        $('.product-item').each(function() {
            const item = $(this);
            const text = item.text().toLowerCase();
            const itemCategory = item.data('category');
            const itemStock = item.data('stock');

            let show = true;

            if (search && !text.includes(search)) show = false;
            if (category && itemCategory !== category) show = false;
            if (stock && itemStock !== stock) show = false;

            item.toggle(show);
        });
    }

    // Create stock in order
    function createStockInOrder() {
        // Load products for selection
        const tbody = $('#stockInProductList');
        tbody.empty();

        products.forEach(product => {
            const stockStatus = getStockStatus(product.stock, product.minStock);
            const row = `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input" name="selectedProducts" value="${product.id}">
                        </td>
                        <td>${product.name}</td>
                        <td class="${stockStatus.class}">${product.stock}</td>
                        <td>
                            <input type="number" class="form-control" name="quantity_${product.id}" min="1" value="1">
                        </td>
                        <td>
                            <input type="number" class="form-control" name="price_${product.id}" value="${product.price}" step="1000">
                        </td>
                    </tr>
                `;                tbody.append(row);
        });

        $('#createStockInModal').modal('show');
    }

    // Submit stock in order
    function submitStockInOrder() {
        const formData = new FormData(document.getElementById('createStockInForm'));
        const selectedProducts = [];

        $('input[name="selectedProducts"]:checked').each(function() {
            const productId = $(this).val();
            const quantity = $(`input[name="quantity_${productId}"]`).val();
            const price = $(`input[name="price_${productId}"]`).val();

            selectedProducts.push({
                productId: parseInt(productId),
                quantity: parseInt(quantity),
                price: parseFloat(price)
            });
        });

        if (selectedProducts.length === 0) {
            alert('Vui lòng chọn ít nhất một thiết bị!');
            return;
        }

        const orderData = {
            id: 'SI-ME-' + Date.now(),
            supplier: formData.get('supplier'),
            expectedDate: formData.get('expectedDate'),
            notes: formData.get('notes'),
            products: selectedProducts,
            status: 'pending',
            type: 'equipment'
        };

        // Send to StockIn
        sendToStockIn(orderData);

        $('#createStockInModal').modal('hide');
        showNotification('Đã tạo đơn nhập và gửi đến StockIn!', 'success');
    }

    // Send order to StockIn
    function sendToStockIn(orderData) {
        // Simulate API call to StockIn
        console.log('Sending to StockIn:', orderData);

        // In real application, this would be an API call
        // fetch('/api/stock-in/orders', {
        //     method: 'POST',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify(orderData)
        // });
    }

    // Process stock in order
    function processStockInOrder(orderId) {
        const order = stockInOrders.find(o => o.id === orderId);
        if (!order) return;

        const content = `
                <h6>Thông tin đơn nhập</h6>
                <p><strong>Mã đơn:</strong> ${order.id}</p>
                <p><strong>Nhà cung cấp:</strong> ${order.supplierEntity ? order.supplierEntity.name : ''}</p>
                <p><strong>Ngày:</strong> ${order.date}</p>

                <h6>Danh sách thiết bị</h6>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Thiết bị</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Số lô</th>
                                <th>Ngày SX</th>
                                <th>Hạn SD</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.products.map(item => {
            const product = products.find(p => p.id === item.productId);
            return `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.price)}</td>
                                        <td><input type="text" class="form-control" name="batch_${item.productId}" placeholder="Nhập số lô"></td>
                                        <td><input type="date" class="form-control" name="mfg_${item.productId}"></td>
                                        <td><input type="date" class="form-control" name="exp_${item.productId}"></td>
                                    </tr>
                                `;
        }).join('')}
                        </tbody>
                    </table>
                </div>
                <input type="hidden" id="currentOrderId" value="${orderId}">
            `;

        $('#processStockInContent').html(content);
        $('#processStockInModal').modal('show');
    }

    // Confirm stock in
    function confirmStockIn() {
        const orderId = $('#currentOrderId').val();
        const order = stockInOrders.find(o => o.id === orderId);

        if (!order) return;

        // Update product stock
        order.products.forEach(item => {
            const product = products.find(p => p.id === item.productId);
            if (product) {
                product.stock += item.quantity;
            }
        });

        // Remove from stock in orders
        stockInOrders = stockInOrders.filter(o => o.id !== orderId);

        // Send invoice to StockInInvoice
        sendToStockInInvoice(order);

        $('#processStockInModal').modal('hide');
        loadProducts();
        loadStockInOrders();
        updateCounts();
        showNotification('Đã nhập kho thành công và tạo hóa đơn!', 'success');
    }

    // Send to StockInInvoice
    function sendToStockInInvoice(order) {
        const invoiceData = {
            ...order,
            status: 'completed',
            completedDate: new Date().toISOString(),
            type: 'equipment'
        };

        console.log('Sending to StockInInvoice:', invoiceData);

        // In real application, this would be an API call
        // fetch('/api/stock-in-invoice/create', {
        //     method: 'POST',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify(invoiceData)
        // });
    }

    // Prepare stock out order
    function prepareStockOutOrder(orderId) {
        const order = stockOutOrders.find(o => o.id === orderId);
        if (!order) return;

        // Update product stock
        order.products.forEach(item => {
            const product = products.find(p => p.id === item.productId);
            if (product && product.stock >= item.quantity) {
                product.stock -= item.quantity;
            }
        });

        // Update order status
        order.status = 'ready';

        // Send back to StockOut
        sendToStockOut(order);

        loadProducts();
        loadStockOutOrders();
        updateCounts();
        showNotification('Đã chuẩn bị hàng và gửi lại StockOut!', 'success');
    }

    // Send to StockOut
    function sendToStockOut(order) {
        console.log('Sending to StockOut:', order);

        // In real application, this would be an API call
        // fetch('/api/stock-out/orders/update', {
        //     method: 'PUT',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify(order)
        // });
    }

    // Save product
    function saveProduct() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);

        const product = {
            id: products.length + 1,
            name: formData.get('name'),
            code: formData.get('code'),
            category: formData.get('category'),
            stock: parseInt(formData.get('stock')),
            price: parseFloat(formData.get('price')),
            minStock: parseInt(formData.get('minStock')),
            description: formData.get('description')
        };

        products.push(product);
        loadProducts();
        updateCounts();

        $('#addProductModal').modal('hide');
        form.reset();
        showNotification('Đã thêm thiết bị thành công!', 'success');
    }

    // Edit product
    function editProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;

        const form = document.getElementById('editProductForm');
        form.elements['id'].value = product.id;
        form.elements['name'].value = product.name;
        form.elements['code'].value = product.code;
        form.elements['category'].value = product.category;
        form.elements['stock'].value = product.stock;
        form.elements['price'].value = product.price;
        form.elements['minStock'].value = product.minStock;
        form.elements['description'].value = product.description;

        $('#editProductModal').modal('show');
    }

    // Update product
    function updateProduct() {
        const form = document.getElementById('editProductForm');
        const formData = new FormData(form);

        const productId = parseInt(formData.get('id'));
        const product = products.find(p => p.id === productId);

        if (product) {
            product.name = formData.get('name');
            product.code = formData.get('code');
            product.category = formData.get('category');
            product.stock = parseInt(formData.get('stock'));
            product.price = parseFloat(formData.get('price'));
            product.minStock = parseInt(formData.get('minStock'));
            product.description = formData.get('description');

            loadProducts();
            $('#editProductModal').modal('hide');
            showNotification('Đã cập nhật thiết bị thành công!', 'success');
        }
    }

    // Delete product
    function deleteProduct(id) {
        if (confirm('Bạn có chắc chắn muốn xóa thiết bị này?')) {
            products = products.filter(p => p.id !== id);
            loadProducts();
            updateCounts();
            showNotification('Đã xóa thiết bị thành công!', 'success');
        }
    }

    // Utility functions
    function getStockStatus(stock, minStock) {
        if (stock === 0) return {status: 'out', class: 'stock-low'};
        if (stock <= minStock) return {status: 'low', class: 'stock-low'};
        return {status: 'normal', class: 'stock-normal'};
    }

    function getCategoryName(category) {
        const categories = {
            'diagnostic': 'Chẩn đoán',
            'surgical': 'Phẫu thuật',
            'monitoring': 'Theo dõi',
            'laboratory': 'Phòng thí nghiệm'
        };
        return categories[category] || category;
    }

    function getOrderStatusText(status) {
        const statusMap = {
            'pending': 'Chờ xử lý',
            'received': 'Đã nhận hàng',
            'preparing': 'Đang chuẩn bị',
            'ready': 'Sẵn sàng',
            'completed': 'Hoàn thành'
        };
        return statusMap[status] || status;
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    function showNotification(message, type) {
        $.notify({
            message: message
        }, {
            type: type,
            placement: {
                from: 'top',
                align: 'right'
            },
            delay: 3000
        });
    }

    // View order details
    function viewStockInOrder(orderId) {
        const order = stockInOrders.find(o => o.id === orderId);
        if (!order) return;

        alert(`Chi tiết đơn nhập ${orderId}:\n` +
            `Nhà cung cấp: ${order.supplierEntity ? order.supplierEntity.name : ''}` +
            `\nNgày: ${order.date}\n` +
            `Số sản phẩm: ${order.products.length}`);
    }

    function viewStockOutOrder(orderId) {
        const order = stockOutOrders.find(o => o.id === orderId);
        if (!order) return;

        alert(`Chi tiết đơn xuất ${orderId}:\n` +
            `Khoa: ${order.department}\n` +
            `Ngày: ${order.date}\n` +
            `Số sản phẩm: ${order.products.length}`);
    }

    function loadStockInOrders() {
        // Lấy dữ liệu từ controller đã truyền vào
        const orders = stockInOrders || [];
        
        // Hiển thị danh sách đơn hàng
        const container = document.getElementById('stockInOrders');
        
        if (orders.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Không có đơn hàng nào cần xử lý</div>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-bordered">';
        html += '<thead><tr><th>Mã đơn</th><th>Nhà cung cấp</th><th>Ngày tạo</th><th>Tổng tiền</th><th>Thao tác</th></tr></thead>';
        html += '<tbody>';
        
        orders.forEach(order => {
            html += `<tr>
            <td>${order.id}</td>
            <td>${order.supplierName || (order.supplierEntity ? order.supplierEntity.name : '')}</td>
            <td>${formatDate(order.transactionDate)}</td>
            <td>${formatCurrency(order.totalAmount)}</td>
            <td>
                <a href="/warehouse/stock-in/${order.id}" class="btn btn-sm btn-primary">
                    <i class="ri-eye-line"></i> Chi tiết
                </a>
                <form method="POST" action="/warehouse/medical-equipment/process-stockin/${order.id}" style="display:inline-block;">
                    <input type="hidden" name="_csrf" value="${document.querySelector('input[name="_csrf"]') ? document.querySelector('input[name="_csrf"]').value : ''}" />
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="ri-add-line"></i> Nhập kho
                    </button>
                </form>
                <button class="btn btn-sm btn-danger" onclick="rejectOrder(${order.id})">
                    <i class="ri-close-line"></i> Từ chối
                </button>
            </td>
        </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
    }

    function formatCurrency(amount) {
        if (!amount) return '0 VNĐ';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    function rejectOrder(id) {
        // Redirect to supplier-in detail page for rejection
        window.location.href = `/warehouse/stock-in/${id}?action=reject`;
    }

    // Gọi hàm khi trang tải xong
    document.addEventListener('DOMContentLoaded', function() {
        loadStockInOrders();
        
        // Xử lý thông báo thành công nếu có
        const successMessage = /*[[${successMessage}]]*/ null;
        if (successMessage) {
            $.notify({
                message: successMessage
            }, {
                type: 'success',
                allow_dismiss: true,
                placement: {
                    from: 'top',
                    align: 'center'
                },
                timer: 1000
            });
        }
        
        // Xử lý thông báo lỗi nếu có
        const errorMessage = /*[[${errorMessage}]]*/ null;
        if (errorMessage) {
            $.notify({
                message: errorMessage
            }, {
                type: 'danger',
                allow_dismiss: true,
                placement: {
                    from: 'top',
                    align: 'center'
                },
                timer: 2000
            });
        }
    });

    // Variables from controller
    /*<![CDATA[*/
// Variables are already defined above, just updating from Thymeleaf
/*]]>*/
</script>
</body>
    <!-- Stock-In modal fragment -->
    <div th:replace="templates_storage/fragments/createStockInModal :: createStockInModal"></div>
</html>


