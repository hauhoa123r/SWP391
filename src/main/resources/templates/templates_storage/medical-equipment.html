<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF tokens - fallback if not available -->
    <meta name="_csrf" th:content="${_csrf?.token ?: ''}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName ?: 'X-CSRF-TOKEN'}"/>
    <title>Kivicare - Quản lý thiết bị y tế</title>

    <!-- CSS Files -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/font-awesome.css}">
    <link rel="stylesheet" th:href="@{/templates_storage/assets/css/linearicon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/themify.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/feather-icon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/remixicon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/datatables.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/bootstrap.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/style.css}">

    <!-- Custom CSS -->
    <style>
        .warehouse-logo {
            font-family: 'Public Sans', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #2e8b57; /* Màu xanh lá cây */
            text-align: center;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        .sortable-header {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        
        .sortable-header.active {
            background-color: #007bff;
            color: white;
        }
        
        .sortable-header.active i {
            color: white;
        }
        
        .equipment-item {
            transition: all 0.3s ease;
        }
        
        .equipment-item:hover {
            transform: translateY(-2px);
        }
        
        .product-card { border: 1px solid #e0e0e0; border-radius: 8px; transition: all 0.3s; }
        .product-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .stock-low { color: #dc3545; font-weight: bold; }
        .stock-normal { color: #28a745; }
    
    /* Equipment detail modal styles */
    #equipmentDetailModal .modal-lg {
        max-width: 800px;
    }
    
    #detailImage {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #noImageMessage {
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }
        .sortable-header {
            cursor: pointer;
        }
        .sortable-header:hover {
            background-color: #f8f9fa;
        }
        .sortable-header i {
            transition: transform 0.2s;
        }
        .sortable-header.asc i {
            transform: rotate(180deg);
        }
        .workflow-tabs { margin-bottom: 20px; }
        .tab-content { min-height: 400px; }
        .order-item { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; padding: 15px; }
        .order-pending { border-left: 4px solid #ffc107; }
        .order-preparing { border-left: 4px solid #17a2b8; }
        .order-ready { border-left: 4px solid #28a745; }
        
        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .btn-group-vertical .btn {
            border-radius: 0.375rem !important;
        }
        
        .equipment-card .btn-group {
            gap: 0.25rem;
        }
        
        /* Loading animation */
        .fa-spin {
            animation: fa-spin 2s infinite linear;
        }
        
        @keyframes fa-spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
<div class="tap-top"><span class="lnr lnr-chevron-up"></span></div>

<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Bắt đầu tiêu đề trang -->
    <div class="page-header">
        <div class="header-wrapper m-0">
            <div class="header-logo-wrapper p-0">
                <div class="logo-wrapper">
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img class="img-fluid main-logo" th:src="@{/templates_storage/assets/images/logo/1.png}" alt="logo">
                        <img class="img-fluid white-logo" th:src="@{/templates_storage/assets/images/logo/1-white.png}" alt="logo">
                    </a>
                </div>
                <div class="toggle-sidebar">
                    <i class="status_toggle middle sidebar-toggle" data-feather="align-center"></i>
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img th:src="@{/templates_storage/assets/images/logo/1.png}" class="img-fluid" alt="">
                    </a>
                </div>
            </div>

            <!-- Tiêu đề mới -->
            <h1 class="warehouse-logo text-center mb-0">Kho Quản Lý</h1>
            <div class="nav-right col-6 pull-right right-header p-0">
                <ul class="nav-menus">
                    <li>
                        <span class="header-search">
                            <i class="ri-search-line"></i>
                        </span>
                    </li>
                    <li class="onhover-dropdown">
                        <div class="notification-box">
                            <i class="ri-notification-line"></i>
                            <span class="badge rounded-pill badge-theme">4</span>
                        </div>
                        <ul class="notification-dropdown onhover-show-div">
                            <li>
                                <i class="ri-notification-line"></i>
                                <h6 class="f-18 mb-0">Thông báo</h6>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-primary"></i>Đang xử lý giao hàng <span
                                        class="pull-right">10 phút</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-success"></i>Hoàn thành đơn hàng <span
                                        class="pull-right">1 giờ</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-info"></i>Tạo vé hỗ trợ <span
                                        class="pull-right">3 giờ</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-danger"></i>Hoàn thành giao hàng <span
                                        class="pull-right">6 giờ</span>
                                </p>
                            </li>
                            <li>
                                <a class="btn btn-primary" href="#">Xem tất cả thông báo</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <div class="mode">
                            <i class="ri-moon-line"></i>
                        </div>
                    </li>
                    <li class="profile-nav onhover-dropdown pe-0 me-0">
                        <div class="media profile-media">
                            <img class="user-profile rounded-circle" th:src="@{/templates_storage/assets/images/users/default.jpg}" alt="">
                            <div class="user-name-hide media-body">
                                <span th:text="${currentUser?.fullName ?: 'Người dùng'}">Người dùng</span>
                                <p class="mb-0 font-roboto"><span th:text="${currentUser?.roleName ?: 'Người dùng'}">Vai trò</span><i class="middle ri-arrow-down-s-line"></i></p>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Kết thúc tiêu đề trang -->

    <!-- Sidebar -->
    <div class="page-body-wrapper">
        <!-- Bắt đầu thanh bên -->
        <div class="sidebar-wrapper">
            <div id="sidebarEffect"></div>
            <div>
                <div class="logo-wrapper logo-wrapper-center">
                    <a th:href="@{/warehouse/dashboard/main}" data-bs-original-title="" title="">
                        <img class="img-fluid for-white" th:src="@{/templates_storage/assets/images/logo/full-white.png}" alt="logo">
                    </a>
                    <div class="back-btn">
                        <i class="fa fa-angle-left"></i>
                    </div>
                    <div class="toggle-sidebar">
                        <i class="ri-apps-line status_toggle middle sidebar-toggle"></i>
                    </div>
                </div>
                <div class="logo-icon-wrapper">
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img class="img-fluid main-logo main-white" th:src="@{/templates_storage/assets/images/logo/1-white.png}" alt="logo">
                        <img class="img-fluid main-logo main-dark" th:src="@{/templates_storage/assets/images/logo/logo-white.png}"
                             alt="logo">
                    </a>
                </div>
                
                <nav class="sidebar-main">
                    <div class="left-arrow" id="left-arrow">
                        <i data-feather="arrow-left"></i>
                    </div>

                    <div id="sidebar-menu">
                        <ul class="sidebar-links" id="simple-bar">
                            <li class="back-btn"></li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/warehouse/dashboard/main}">
                                    <i class="ri-home-line"></i>
                                    <span>Bảng điều khiển</span>
                                </a>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-store-3-line"></i>
                                    <span>Giao dịch</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/stock-in}">Nhập kho</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/stock-out}">Xuất kho</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-list-check-2"></i>
                                    <span>Hóa đơn</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/invoices/in}">Hóa đơn nhập kho</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/invoices/out}">Hóa đơn xuất kho</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-list-settings-line"></i>
                                    <span>Kho hàng</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/medical-equipment}">Thiết bị y tế</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/medicines}">Thuốc</a>
                                    </li>
                                </ul>
                            </li>
                            
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-price-tag-3-line"></i>
                                    <span>Mã giảm giá</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/coupon-list}">Danh sách mã giảm giá</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/create-coupon}">Tạo mã giảm giá</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/product-review}">
                                    <i class="ri-star-line"></i>
                                    <span>Đánh giá sản phẩm</span>
                                </a>
                            </li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/reports}">
                                    <i class="ri-file-chart-line"></i>
                                    <span>Báo cáo</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="right-arrow" id="right-arrow">
                        <i data-feather="arrow-right"></i>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Kết thúc thanh bên -->

        <!-- Main Content -->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Quản lý thiết bị y tế</h5>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                        <i class="ri-add-line"></i> Thêm thiết bị
                                    </button>
                                </div>
                            </div>

                            <!-- Workflow Tabs -->
                            <div class="workflow-tabs">
                                <ul class="nav nav-tabs" id="workflowTabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="products-tab" data-bs-toggle="tab" href="#products" role="tab">
                                            <i class="ri-box-line"></i> Sản phẩm <span class="badge bg-primary" id="productCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="problem-tab" data-bs-toggle="tab" href="#problem" role="tab">
                                            <i class="ri-error-warning-line"></i> Thiết bị có vấn đề <span class="badge bg-danger" id="problemCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="stock-in-tab" data-bs-toggle="tab" href="#stock-in" role="tab">
                                            <i class="ri-download-line"></i> Đơn nhập <span class="badge bg-success" id="stockInCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="stock-out-tab" data-bs-toggle="tab" href="#stock-out" role="tab">
                                            <i class="ri-upload-line"></i> Đơn xuất <span class="badge bg-warning" id="stockOutCount">0</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <div class="tab-content">
                                <!-- Products Tab -->
                                <div class="tab-pane fade show active" id="products" role="tabpanel">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-2">
                                                <input type="text" class="form-control" id="searchProducts" placeholder="Tìm kiếm thiết bị...">
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="categoryFilter">
                                                    <option value="">Tất cả danh mục</option>
                                                    <option value="diagnostic">Chẩn đoán</option>
                                                    <option value="surgical">Phẫu thuật</option>
                                                    <option value="monitoring">Theo dõi</option>
                                                    <option value="laboratory">Phòng thí nghiệm</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="stockFilter">
                                                    <option value="">Tất cả</option>
                                                    <option value="low">Sắp hết hàng</option>
                                                    <option value="normal">Còn hàng</option>
                                                    <option value="out">Hết hàng</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="btn-group">
                                                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                                        <i class="ri-filter-off-line"></i> Xóa lọc
                                                    </button>
                                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createStockInModal">
                                                    <i class="ri-add-circle-line"></i> Tạo đơn nhập
                                                </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sorting controls -->
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="name">
                                                        <i class="ri-sort-asc"></i> Tên thiết bị
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="id">
                                                        <i class="ri-sort-asc"></i> Mã thiết bị
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="category">
                                                        <i class="ri-sort-asc"></i> Danh mục
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="stock">
                                                        <i class="ri-sort-asc"></i> Tồn kho
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="price">
                                                        <i class="ri-sort-asc"></i> Giá
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row" id="productsGrid">
                                            <!-- Display medical equipment from database -->
                                            <div th:each="equipment : ${equipments}" class="col-md-4 col-sm-6 mb-4">
                                                <div class="card product-card h-100">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <h6 class="card-title" th:text="${equipment.name}">Máy đo huyết áp</h6>
                                                            <span th:class="${equipment.stockQuantities != null and equipment.stockQuantities <= 10 ? 'stock-low' : 'stock-normal'}"
                                                                  th:text="${equipment.stockQuantities != null ? equipment.stockQuantities + ' ' + (equipment.unit != null ? equipment.unit : 'cái') : '0 cái'}">10 Cái</span>
                                                        </div>
                                                        <p class="card-text small" th:text="${equipment.description != null ? equipment.description : 'Không có mô tả'}">Thiết bị đo huyết áp tự động</p>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold" th:text="${equipment.price != null ? #numbers.formatDecimal(equipment.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : '0 VNĐ'}">1,500,000 VNĐ</span>
                                                            <div class="btn-group">
                                                                <button class="btn btn-sm btn-outline-primary" onclick="viewEquipmentDetails(this)" th:data-id="${equipment.id}">
                                                                    <i class="ri-eye-line"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-success" onclick="editEquipment(this)" th:data-id="${equipment.id}">
                                                                    <i class="ri-edit-line"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Show message if no equipment -->
                                            <div th:if="${#lists.isEmpty(equipments)}" class="col-12 text-center py-5">
                                                <i class="ri-stethoscope-line fs-1 text-muted"></i>
                                                <p class="mt-3">Không có thiết bị y tế nào trong kho. Hãy thêm thiết bị mới.</p>
                                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                                    <i class="ri-add-line"></i> Thêm thiết bị
                                                </button>
                                    </div>
                                </div>

                                        <!-- ✅ Phân trang -->
                                        <div class="d-flex justify-content-center mt-4" th:if="${totalPages > 1}">
                                            <nav>
                                                <ul class="pagination">

                                                    <!-- « Previous -->
                                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                                        <a class="page-link" th:onclick="'goToPage(' + ${currentPage - 1} + ')'" style="cursor: pointer;">«</a>
                                                    </li>

                                                    <!-- First + ... -->
                                                    <li class="page-item" th:if="${startPage > 0}">
                                                        <a class="page-link" th:onclick="'goToPage(0)'" style="cursor: pointer;">1</a>
                                                    </li>
                                                    <li class="page-item disabled" th:if="${startPage > 1}">
                                                        <a class="page-link">...</a>
                                                    </li>

                                                    <!-- Middle -->
                                                    <li class="page-item"
                                                        th:each="i : ${#numbers.sequence(startPage, endPage)}"
                                                        th:classappend="${i == currentPage} ? 'active'">
                                                        <a class="page-link" th:onclick="'goToPage(' + ${i} + ')'" th:text="${i + 1}" style="cursor: pointer;">1</a>
                                                    </li>

                                                    <!-- ... + Last -->
                                                    <li class="page-item disabled" th:if="${endPage < totalPages - 2}">
                                                        <a class="page-link">...</a>
                                                    </li>
                                                    <li class="page-item" th:if="${endPage < totalPages - 1}">
                                                        <a class="page-link" th:onclick="'goToPage(' + ${totalPages - 1} + ')'" th:text="${totalPages}" style="cursor: pointer;"></a>
                                                    </li>

                                                    <!-- » Next -->
                                                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                                        <a class="page-link" th:onclick="'goToPage(' + ${currentPage + 1} + ')'" style="cursor: pointer;">»</a>
                                                    </li>

                                                </ul>
                                            </nav>
                                </div>

                                    </div>
                                </div>

                                <!-- Problem Tab -->
                                <div class="tab-pane fade" id="problem" role="tabpanel">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6>Thiết bị có vấn đề (tồn kho ≤ 10)</h6>
                                            <button class="btn btn-success" onclick="createStockInForProblemEquipments()">
                                                <i class="ri-add-circle-line"></i> Tạo đơn nhập cho danh sách
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Tên thiết bị</th>
                                                        <th>Danh mục</th>
                                                        <th>Tồn kho</th>
                                                        <th>Trạng thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="problemEquipmentList">
                                                    <!-- Problem equipment will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock In Tab -->
                                <div class="tab-pane fade" id="stock-in" role="tabpanel">
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3">
                                            <h6><i class="ri-information-line"></i> Hướng dẫn xử lý đơn nhập kho</h6>
                                            <ul class="mb-0">
                                                <li><strong>Xử lý:</strong> Chuyển đơn từ trạng thái NEED_TO_ADD → COMPLETED (sẽ chuyển sang trang StockInInvoice)</li>
                                                <li><strong>Từ chối:</strong> Chuyển đơn từ trạng thái NEED_TO_ADD → REJECTED (sẽ không hiển thị nữa)</li>
                                                <li>Chỉ hiển thị các đơn có trạng thái: NEED_TO_ADD, WAITING_FOR_DELIVERY, RECEIVED</li>
                                            </ul>
                            </div>
                                        <h6>Đơn nhập từ StockIn cần xử lý</h6>
                                        <div id="stockInOrders">
                                            <!-- Stock in orders will be loaded here -->
                        </div>
                    </div>
                </div>

                                <!-- Stock Out Tab -->
                                <div class="tab-pane fade" id="stock-out" role="tabpanel">
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3">
                                            <h6><i class="ri-information-line"></i> Hướng dẫn xử lý đơn xuất kho</h6>
                                            <ul class="mb-0">
                                                <li><strong>Chuẩn bị:</strong> Chuyển đơn từ trạng thái PREPARING → PREPARE_DELIVERY (sẽ chuyển sang trang StockOut)</li>
                                                <li><strong>Từ chối:</strong> Chuyển đơn từ trạng thái PREPARING → REJECTED (sẽ không hiển thị nữa)</li>
                                                <li>Chỉ hiển thị các đơn có trạng thái: PREPARING, PREPARE_DELIVERY, DELIVERING</li>
                                            </ul>
                                        </div>
                                        <h6>Đơn xuất từ StockOut cần chuẩn bị</h6>
                                        <div id="stockOutOrders">
                                            <!-- Stock out orders will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm thiết bị y tế</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="mb-3">
                        <label class="form-label">Tên thiết bị</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã thiết bị</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" required>
                            <option value="">Chọn danh mục</option>
                            <option value="diagnostic">Chẩn đoán</option>
                            <option value="surgical">Phẫu thuật</option>
                            <option value="monitoring">Theo dõi</option>
                            <option value="laboratory">Phòng thí nghiệm</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tồn kho</label>
                        <input type="number" class="form-control" name="stock" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn giá</label>
                        <input type="number" class="form-control" name="price" min="0" step="1000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tối thiểu</label>
                        <input type="number" class="form-control" name="minStock" min="0" value="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa thiết bị</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Tên thiết bị</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã thiết bị</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" required>
                            <option value="diagnostic">Chẩn đoán</option>
                            <option value="surgical">Phẫu thuật</option>
                            <option value="monitoring">Theo dõi</option>
                            <option value="laboratory">Phòng thí nghiệm</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tồn kho</label>
                        <input type="number" class="form-control" name="stock" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn giá</label>
                        <input type="number" class="form-control" name="price" min="0" step="1000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tối thiểu</label>
                        <input type="number" class="form-control" name="minStock" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateEquipment()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Stock In Order Modal -->
<div class="modal fade" id="createStockInModal" tabindex="-1" aria-labelledby="createStockInModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStockInModalLabel">Tạo đơn nhập thiết bị y tế</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createStockInForm" method="post" th:action="@{/warehouse/stock-in}">
                <div class="modal-body">
                    <input type="hidden" name="status" value="WAITING_FOR_DELIVERY">
                    <input type="hidden" name="transactionType" value="STOCK_IN">
                    <input type="hidden" id="inventoryManagerId" name="inventoryManagerId" th:value="${currentUser?.id ?: 256}">
                    <input type="hidden" name="totalAmount" id="totalAmountInputIn" value="0">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="supplierSearchIn" class="form-label">Nhà cung cấp <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="supplierSearchIn" placeholder="Tìm kiếm nhà cung cấp...">
                                <input type="hidden" id="supplierIdIn" name="supplierId" required>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#supplierModalIn">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                            <div id="supplierSearchResultsIn" class="dropdown-menu w-100"></div>
                            <div class="form-text" id="selectedSupplierInfoIn"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="expectedDeliveryDateIn" class="form-label">Ngày giao hàng dự kiến <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="expectedDeliveryDateIn" name="expectedDeliveryDate" required>
                            <script>
                                // Set default date to tomorrow for inbound order
                                const tomorrowIn = new Date();
                                tomorrowIn.setDate(tomorrowIn.getDate() + 1);
                                document.getElementById('expectedDeliveryDateIn').value = tomorrowIn.toISOString().split('T')[0];
                            </script>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="invoiceNumberIn" class="form-label">Số hóa đơn <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="invoiceNumberIn" name="invoiceNumber" placeholder="Nhập số hóa đơn" required>
                        </div>
                        <div class="col-md-4">
                            <label for="transactionDateIn" class="form-label">Ngày giao dịch <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="transactionDateIn" name="transactionDate" required>
                            <script>
                                // Set default transaction date to today for inbound order
                                document.getElementById('transactionDateIn').value = new Date().toISOString().split('T')[0];
                            </script>
                        </div>
                        <div class="col-md-4">
                            <label for="orderTypeIn" class="form-label">Loại đơn hàng <span class="text-danger">*</span></label>
                            <select class="form-select" id="orderTypeIn" name="orderType" required>
                                <option value="">Chọn loại đơn hàng</option>
                                <option value="MEDICINE">Thuốc</option>
                                <option value="MEDICAL_EQUIPMENT" selected>Thiết bị y tế</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reasonIn" class="form-label">Lý do nhập <span class="text-danger">*</span></label>
                            <select class="form-select" id="reasonIn" name="reason" required>
                                <option value="">Chọn lý do nhập</option>
                                <option value="PURCHASE">Mua hàng</option>
                                <option value="TRANSFER">Chuyển kho</option>
                                <option value="RETURN">Trả hàng</option>
                                <option value="OTHER">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentMethodIn" class="form-label">Phương thức thanh toán</label>
                            <select class="form-select" id="paymentMethodIn" name="paymentMethod">
                                <option value="CASH" selected>Tiền mặt</option>
                                <option value="BANK_TRANSFER">Chuyển khoản</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="taxAmountIn" class="form-label">Thuế (%)</label>
                            <select class="form-select" id="taxAmountIn" name="taxAmount">
                                <option value="0">0%</option>
                                <option value="8">8%</option>
                                <option value="10" selected>10%</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="shippingCostIn" class="form-label">Chi phí vận chuyển</label>
                            <input type="number" class="form-control" id="shippingCostIn" name="shippingCost" min="0" value="0">
                        </div>
                        <div class="col-md-4">
                            <label for="discountAmountIn" class="form-label">Giảm giá (VNĐ)</label>
                            <input type="number" class="form-control" id="discountAmountIn" name="discountAmount" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="notesIn" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="notesIn" name="notes" rows="2" placeholder="Nhập ghi chú về đơn hàng"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="items-section mb-3">
                        <h6>Danh sách thiết bị nhập kho</h6>
                        <table class="table table-bordered" id="itemsTableIn">
                            <thead>
                                <tr>
                                    <th>Tên thiết bị</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá (VNĐ)</th>
                                    <th>Thành tiền (VNĐ)</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="itemsListIn">
                                <tr id="noItemsMessageIn">
                                    <td colspan="5" class="text-center">Không có thiết bị nào. Vui lòng thêm thiết bị vào danh sách.</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addItemModalIn">
                                    <i class="ri-add-line"></i> Thêm thiết bị
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <h6>Tổng tiền: <span id="totalAmountIn">0</span> VNĐ</h6>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Lưu phiếu nhập</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Item Modal for Inbound Order -->
<div class="modal fade" id="addItemModalIn" tabindex="-1" aria-labelledby="addItemModalLabelIn" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabelIn">Thêm thiết bị vào đơn nhập</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemFormIn">
                    <div class="mb-3">
                        <label for="productSearchIn" class="form-label">Tìm kiếm thiết bị</label>
                        <input type="text" class="form-control" id="productSearchIn" placeholder="Nhập tên thiết bị...">
                        <div id="productSearchResultsIn" class="dropdown-menu w-100 mt-2"></div>
                        <input type="hidden" id="selectedProductIdIn">
                    </div>
                    <div class="mb-3" id="productDetailsIn" style="display: none;">
                        <h6>Thông tin thiết bị</h6>
                        <p><strong>Tên:</strong> <span id="productNameIn"></span></p>
                        <p><strong>Tồn kho:</strong> <span id="productStockIn"></span></p>
                        <p><strong>Đơn giá:</strong> <span id="productPriceIn"></span> VNĐ</p>
                    </div>
                    <div class="mb-3">
                        <label for="quantityIn" class="form-label">Số lượng</label>
                        <input type="number" class="form-control" id="quantityIn" min="1" value="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="addItemToListIn()">Thêm vào danh sách</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Files -->
<script th:src="@{/templates_storage/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/templates_storage/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/templates_storage/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/config.js}"></script>
<script th:src="@{/templates_storage/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/templates_storage/assets/js/chart/apex-chart/apex-chart.js}"></script>
<script th:src="@{/templates_storage/assets/js/chart/apex-chart/stock-prices.js}"></script>
<script th:src="@{/templates_storage/assets/js/chart/apex-chart/chart-custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/dashboard/default.js}"></script>
<script th:src="@{/templates_storage/assets/js/notify/index.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead/handlebars.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead/typeahead.bundle.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead/typeahead.custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead-search/handlebars.js}"></script>
<script th:src="@{/templates_storage/assets/js/typeahead-search/typeahead-custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/script.js}"></script>

<script th:inline="javascript">
    // Load equipment data from controller
    let equipments = [];
    
    /*<![CDATA[*/
    // Get data from Thymeleaf
    equipments = /*[[${equipments}]]*/ [];
    /*]]>*/

    // Load stock in/out orders from controller
    let stockInOrders = [];
    let stockOutOrders = [];
    
    /*<![CDATA[*/
    stockInOrders = /*[[${stockInOrders}]]*/ [];
    stockOutOrders = /*[[${stockOutOrders}]]*/ [];
    /*]]>*/
    
    // Ensure data is properly loaded and handle null/undefined values
    if (!equipments || equipments.length === 0) {
        console.log('Equipments is empty or null, checking Thymeleaf data...');
        equipments = [];
    }
    
    if (!stockInOrders || stockInOrders.length === 0) {
        console.log('Stock In Orders is empty or null, checking Thymeleaf data...');
        stockInOrders = [];
    }
    
    if (!stockOutOrders || stockOutOrders.length === 0) {
        console.log('Stock Out Orders is empty or null, checking Thymeleaf data...');
        stockOutOrders = [];
    }
    
    // Ensure arrays are properly initialized
    equipments = Array.isArray(equipments) ? equipments : [];
    stockInOrders = Array.isArray(stockInOrders) ? stockInOrders : [];
    stockOutOrders = Array.isArray(stockOutOrders) ? stockOutOrders : [];
    
    // Debug: Log data for troubleshooting
    console.log('Final Equipments data:', equipments);
    console.log('Final Stock In Orders data:', stockInOrders);
    console.log('Final Stock Out Orders data:', stockOutOrders);
    console.log('Equipments type:', typeof equipments);
    console.log('Stock In Orders type:', typeof stockInOrders);
    console.log('Stock Out Orders type:', typeof stockOutOrders);

    // Global variables for sorting and filtering
    let currentSortField = 'name';
    let currentSortDirection = 'asc';
    let filteredEquipments = [];
    
    // CSRF token setup
    const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
    console.log('CSRF Token:', CSRF_TOKEN ? 'Available' : 'Not available');
    console.log('CSRF Header:', CSRF_HEADER);

    // Cập nhật cấu trúc dữ liệu cho thiết bị y tế
    function initializeEquipmentData() {
        console.log('Initializing equipment data...');
        console.log('Raw equipments:', equipments);
        
        if (!equipments || equipments.length === 0) {
            console.log('No equipments data found');
            return;
        }
        
        equipments.forEach(equipment => {
            // Đảm bảo cấu trúc dữ liệu phù hợp với thiết bị y tế
            if (!equipment.category) {
                equipment.category = 'diagnostic'; // Mặc định là thiết bị chẩn đoán
            }
            if (!equipment.unit) {
                equipment.unit = 'cái'; // Đơn vị mặc định cho thiết bị
            }
            if (!equipment.minStock) {
                equipment.minStock = 10; // Tồn kho tối thiểu thấp hơn thuốc
            }
            if (!equipment.stockQuantities) {
                equipment.stockQuantities = 0;
            }
            // Thêm trường cho thiết bị y tế
            if (!equipment.warrantyPeriod) {
                equipment.warrantyPeriod = 12; // Thời hạn bảo hành 12 tháng
            }
            if (!equipment.manufacturer) {
                equipment.manufacturer = 'Chưa xác định';
            }
        });
        
        console.log('Equipment data initialized:', equipments);
    }

    // Danh mục thiết bị y tế
    const equipmentCategories = {
        'diagnostic': 'Thiết bị chẩn đoán',
        'surgical': 'Thiết bị phẫu thuật', 
        'monitoring': 'Thiết bị theo dõi',
        'laboratory': 'Thiết bị phòng thí nghiệm',
        'rehabilitation': 'Thiết bị phục hồi chức năng',
        'emergency': 'Thiết bị cấp cứu'
    };

    // Đơn vị cho thiết bị y tế
    const equipmentUnits = {
        'cái': 'Cái',
        'bộ': 'Bộ',
        'máy': 'Máy',
        'chiếc': 'Chiếc',
        'set': 'Set'
    };
    
    // Initialize page
    $(document).ready(function() {
        console.log('Document ready, initializing page...');
        
        // Initialize equipment data first
        initializeEquipmentData();
        
        // Load products after a short delay to ensure data is loaded
        setTimeout(() => {
            loadProducts(); // Load với full functionality
            $('#products-tab').tab('show');
            $('#products').addClass('show active');
            $('#productsGrid').show();
            updateCounts();
        }, 100);
        
                // Event listeners for tab changes
        $('#workflowTabs a').on('shown.bs.tab', function (e) {
            const target = $(e.target).attr('href');
            if (target === '#products') {
                loadProducts(); // Load với full functionality
            } else if (target === '#problem') {
                loadProblemEquipments();
            } else if (target === '#stock-in') {
        loadStockInOrders();
            } else if (target === '#stock-out') {
        loadStockOutOrders();
            }
        });

        // Event listeners for filters and sorting
        $('#searchProducts').on('input', filterEquipments);
        $('#categoryFilter').on('change', filterEquipments);
        $('#stockFilter').on('change', filterEquipments);
        
        // Sort button event listeners
        $('.sortable-header').on('click', function() {
            const sortField = $(this).data('sort');
            if (currentSortField === sortField) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = sortField;
                currentSortDirection = 'asc';
            }
            
            // Update sort icons
            $('.sortable-header i').attr('class', 'ri-sort-asc');
            const icon = currentSortDirection === 'asc' ? 'ri-sort-asc' : 'ri-sort-desc';
            $(this).find('i').attr('class', icon);
            
            filterEquipments();
        });

        // Initialize product search for stock in modal
        initProductSearchIn();
        
        // Event listeners for stock in form calculations
        $('#taxAmountIn, #shippingCostIn, #discountAmountIn').on('change', recalculateTotalIn);
        
        // Initialize supplier search for stock in modal
        initSupplierSearchIn();
        
        // Filter products on input change
        $('#searchProducts, #categoryFilter, #stockFilter').on('input change', function() {
            filterEquipments();
        });

        // Sort buttons event listeners
        $('.sortable-header').on('click', function() {
            const sortField = $(this).data('sort');
            
            if (currentSortField === sortField) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = sortField;
                currentSortDirection = 'asc';
            }
            
            // Update sort icons
            $('.sortable-header i').removeClass('ri-sort-asc ri-sort-desc').addClass('ri-sort-asc');
            $(this).find('i').removeClass('ri-sort-asc').addClass(currentSortDirection === 'asc' ? 'ri-sort-asc' : 'ri-sort-desc');
            
            filterEquipments();
        });
    });




    // Load out of stock equipment
    function loadOutOfStock() {
        const outOfStockItems = equipments.filter(p => p.stockQuantities <= 20);
        const tbody = $('#outOfStockTableBody');
        tbody.empty();

        if (outOfStockItems.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center">Không có thiết bị nào hết hàng</td></tr>');
            return;
        }

        outOfStockItems.forEach(product => {
            const suggestedQty = Math.max(product.minStock * 2, 50);
            const row = `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.code}</td>
                    <td><span class="stock-low">${product.stockQuantities}</span></td>
                    <td>${product.minStock}</td>
                    <td><strong>${suggestedQty}</strong></td>
                    <td>${formatCurrency(product.price)}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    // Add out of stock items to stock-in modal
    function addOutOfStockToModal() {
        const outOfStockItems = equipments.filter(p => p.stockQuantities <= 20);
        
        if (outOfStockItems.length === 0) {
            alert('Không có thiết bị nào hết hàng');
            return;
        }

        // Clear current products in modal
        if (window.siProducts) {
            window.siProducts.length = 0;
        }

        // Add each out of stock item to modal
        outOfStockItems.forEach(product => {
            const suggestedQty = Math.max(product.minStock * 2, 50);
            if (window.siAddProduct) {
                window.siAddProduct({
                    name: product.name,
                    qty: suggestedQty,
                    price: product.price || 0
                });
            }
        });

        // Set order type to medical equipment
        setTimeout(() => {
            const orderTypeSelect = document.getElementById('si-orderType');
            if (orderTypeSelect) {
                orderTypeSelect.value = 'MEDICAL_PRODUCT';
            }
        }, 100);

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('createStockInModal'));
        modal.show();
    }

    // Load products with full functionality
    function loadProducts() {
        console.log('Loading products...');
        console.log('Equipments data:', equipments);
        console.log('Equipments length:', equipments ? equipments.length : 'undefined');
        
        // Initialize filtered equipments
        filteredEquipments = equipments ? [...equipments] : [];
        
        // Apply filters and sorting
        filterEquipments();
        
        console.log('Products loaded successfully');
    }

    // Handle pagination
    function goToPage(page) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('page', page);
        window.location.href = currentUrl.toString();
    }

    // Create stock in for problem equipments
    function createStockInForProblemEquipments() {
        const problemEquipments = equipments.filter(e => (e.stockQuantities || 0) <= 10);
        
        if (problemEquipments.length === 0) {
            alert('Không có thiết bị nào cần nhập thêm!');
            return;
        }

        // Redirect to stock in page with pre-filled problem equipments
        const equipmentIds = problemEquipments.map(e => e.id).join(',');
        window.location.href = `/warehouse/stock-in?problemEquipments=${equipmentIds}`;
    }
    
    // Improved filter equipments function
    function filterEquipments() {
        const search = $('#searchProducts').val().toLowerCase();
        const category = $('#categoryFilter').val();
        const stock = $('#stockFilter').val();

        filteredEquipments = equipments.filter(equipment => {
            // Handle null/undefined values
            const equipmentName = equipment.name || '';
            const equipmentId = equipment.id || '';
            const equipmentCategory = equipment.category || '';
            const equipmentStock = equipment.stockQuantities || 0;
            const equipmentMinStock = equipment.minStock || 10;

            // Search filter
            const matchesSearch = !search || 
                equipmentName.toLowerCase().includes(search) ||
                equipmentId.toString().toLowerCase().includes(search) ||
                getCategoryName(equipmentCategory).toLowerCase().includes(search);

            // Category filter - improved to handle both category codes and names
            let matchesCategory = true;
            if (category) {
                const equipmentCategoryName = getCategoryName(equipmentCategory).toLowerCase();
                const selectedCategoryName = getCategoryName(category).toLowerCase();
                matchesCategory = equipmentCategoryName === selectedCategoryName;
            }

            // Stock filter
            let matchesStock = true;
            if (stock === 'low') {
                matchesStock = equipmentStock <= equipmentMinStock;
            } else if (stock === 'normal') {
                matchesStock = equipmentStock > equipmentMinStock && equipmentStock > 0;
            } else if (stock === 'out') {
                matchesStock = equipmentStock === 0;
            }

            return matchesSearch && matchesCategory && matchesStock;
        });

        // Sort filtered equipments
        sortEquipments(filteredEquipments);
        
        // Display filtered equipments
        displayEquipments(filteredEquipments);
        
        // Update counts
        updateCounts();
    }
    
    // Sort equipments function
    function sortEquipments(equipmentArray) {
        equipmentArray.sort((a, b) => {
            let aValue, bValue;
            
            switch (currentSortField) {
                case 'name':
                    aValue = (a.name || '').toLowerCase();
                    bValue = (b.name || '').toLowerCase();
                    break;
                case 'id':
                    aValue = a.id || 0;
                    bValue = b.id || 0;
                    break;
                case 'category':
                    aValue = getCategoryName(a.category || '').toLowerCase();
                    bValue = getCategoryName(b.category || '').toLowerCase();
                    break;
                case 'stock':
                    aValue = a.stockQuantities || 0;
                    bValue = b.stockQuantities || 0;
                    break;
                case 'price':
                    aValue = a.price || 0;
                    bValue = b.price || 0;
                    break;
                default:
                    aValue = (a.name || '').toLowerCase();
                    bValue = (b.name || '').toLowerCase();
            }

            if (currentSortDirection === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });
    }

    // Display equipments function
    function displayEquipments(equipmentArray) {
        const grid = $('#productsGrid');
        grid.empty();

        if (!equipmentArray || equipmentArray.length === 0) {
            grid.html(`
                <div class="col-12 text-center py-5">
                    <i class="ri-filter-3-line fs-1 text-muted"></i>
                    <p class="mt-3">Không tìm thấy thiết bị nào phù hợp với điều kiện lọc.</p>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="ri-filter-off-line"></i> Xóa bộ lọc
                    </button>
                </div>
            `);
            return;
        }

        equipmentArray.forEach(equipment => {
            // Handle null/undefined values
            const equipmentName = equipment.name || 'Không có tên';
            const equipmentId = equipment.id || 'N/A';
            const equipmentCategory = equipment.category || 'Chưa phân loại';
            const equipmentUnit = equipment.unit || 'cái';
            const equipmentStock = equipment.stockQuantities || 0;
            const equipmentPrice = equipment.price || 0;
            const equipmentMinStock = equipment.minStock || 10;
            // Kiểm tra lô sắp hết hạn (nếu có batches)
            let nearExpiry = false;
            if (equipment.batches && Array.isArray(equipment.batches)) {
                const today = new Date();
                nearExpiry = equipment.batches.some(batch => {
                    if (batch.expiryDate) {
                        const expDate = new Date(batch.expiryDate);
                        const daysToExpiry = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                        return daysToExpiry <= 90;
                    }
                    return false;
                });
            }

            const stockStatus = getStockStatus(equipmentStock, equipmentMinStock);
            const stockClass = stockStatus.class;

            const card = `
                <div class="col-md-6 col-lg-4 mb-3 equipment-item" data-category="${equipmentCategory}" data-stock="${stockStatus.status}">
                    <div class="card product-card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${equipmentName}</h6>
                            <p class="card-text">
                                <small class="text-muted">Mã: ${equipmentId}</small><br>
                                <small class="text-muted">Danh mục: ${getCategoryName(equipmentCategory)}</small><br>
                                <small class="text-muted">Đơn vị: ${equipmentUnit}</small>
                            </p>
                            <div class="row">
                                <div class="col-6">
                                    <strong class="${stockClass}">Tồn kho: ${equipmentStock}</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <strong>${formatCurrency(equipmentPrice)}</strong>
                                </div>
                            </div>
                            ${nearExpiry ? `<div class=\"mt-1\"><small class=\"expired-soon\"> Có lô sắp hết hạn</small></div>` : ''}
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info" onclick="viewEquipmentDetailsById(${equipmentId})" title="Xem chi tiết">
                                    <i class="ri-eye-line"></i>
                                </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editEquipment(${equipmentId})" title="Sửa thiết bị">
                                    <i class="ri-edit-line"></i>
                                </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEquipment(${equipmentId})" title="Xóa thiết bị">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.append(card);
        });
    }

    // Clear filters function
    function clearFilters() {
        $('#searchProducts').val('');
        $('#categoryFilter').val('');
        $('#stockFilter').val('');
        currentSortField = 'name';
        currentSortDirection = 'asc';
        
        // Reset sort icons
        $('.sortable-header i').attr('class', 'ri-sort-asc');
        
        filterEquipments();
    }

    // Helper functions
    function getStockStatus(stock, minStock) {
        if (stock === 0) return { status: 'out', class: 'stock-low' };
        if (stock <= minStock) return { status: 'low', class: 'stock-low' };
        return { status: 'normal', class: 'stock-normal' };
    }

    // Get category name
    function getCategoryName(categoryCode) {
        // If categoryCode is already a Vietnamese name, return it
        if (categoryCode && (categoryCode.includes('Chẩn đoán') || categoryCode.includes('Phẫu thuật') || 
            categoryCode.includes('Theo dõi') || categoryCode.includes('Phòng thí nghiệm') || 
            categoryCode.includes('Chưa phân loại'))) {
            return categoryCode;
        }
        
        const categories = {
            'diagnostic': 'Chẩn đoán',
            'surgical': 'Phẫu thuật',
            'monitoring': 'Theo dõi',
            'laboratory': 'Phòng thí nghiệm'
        };

        return categories[categoryCode] || categoryCode || 'Chưa phân loại';
    }

    // Format currency
    function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) {
            return '0 ₫';
        }
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    }

    // Update badge counts with improved logic
    function updateCounts() {
        // Đếm số sản phẩm đang hiển thị trên trang hiện tại (filteredEquipments)
        $('#productCount').text(filteredEquipments ? filteredEquipments.length : 0);
        // Đếm số thiết bị có vấn đề trên trang hiện tại
        $('#problemCount').text(filteredEquipments ? filteredEquipments.filter(e => (e.stockQuantities || 0) <= 10).length : 0);
        // Đếm số đơn nhập đang hiển thị trên trang hiện tại (nếu có phân trang/filter thì dùng biến filteredStockInOrders, nếu không thì dùng stockInOrders)
        if (typeof filteredStockInOrders !== 'undefined' && Array.isArray(filteredStockInOrders)) {
            $('#stockInCount').text(filteredStockInOrders.length);
        } else {
            $('#stockInCount').text(stockInOrders ? stockInOrders.length : 0);
        }
        // Đếm số đơn xuất đang hiển thị trên trang hiện tại (nếu có phân trang/filter thì dùng biến filteredStockOutOrders, nếu không thì dùng stockOutOrders)
        if (typeof filteredStockOutOrders !== 'undefined' && Array.isArray(filteredStockOutOrders)) {
            $('#stockOutCount').text(filteredStockOutOrders.length);
        } else {
            $('#stockOutCount').text(stockOutOrders ? stockOutOrders.length : 0);
        }
    }
    
    // Update equipment function
    function updateEquipment() {
        let id = parseInt($('#editEquipmentId').val());
        let equipment = equipments.find(p => p.id === id);
        if (!equipment) {
            alert('Không tìm thấy thiết bị!');
            return;
        }
        
        equipment.name = $('#editEquipmentName').val();
        equipment.category = $('#editEquipmentCategory').val();
        equipment.price = parseFloat($('#editEquipmentPrice').val());
        equipment.stockQuantities = parseInt($('#editEquipmentStock').val());
        equipment.unit = $('#editEquipmentUnit').val();
        equipment.minStock = parseInt($('#editEquipmentMinStock').val());
        equipment.manufacturer = $('#editEquipmentManufacturer').val();
        equipment.warrantyPeriod = $('#editEquipmentWarranty').val();
        
        $('#editEquipmentModal').modal('hide');
        loadProducts();
        updateCounts();
        alert('Cập nhật thông tin thiết bị thành công!');
    }

    // Add item to list for stock in modal
    function addItemToListIn() {
        const productId = document.getElementById('selectedProductIdIn').value;
        const quantity = parseInt(document.getElementById('quantityIn').value);
        
        if (!productId) {
            alert('Vui lòng chọn một sản phẩm');
            return;
        }
        
        if (quantity <= 0) {
            alert('Số lượng phải lớn hơn 0');
            return;
        }
        
        // Find the product from equipments array
        const product = equipments.find(e => e.id == productId);
        if (product) {
            // Add to selected products for inbound (global variable)
            if (!window.selectedProductsIn) window.selectedProductsIn = [];
            
            const existingIndex = window.selectedProductsIn.findIndex(p => p.id == productId);
            if (existingIndex !== -1) {
                window.selectedProductsIn[existingIndex].quantity += quantity;
            } else {
                window.selectedProductsIn.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                });
            }
            
            // Update the table
            updateItemsTableIn();
            $('#addItemModalIn').modal('hide');
            
            alert('Đã thêm thiết bị vào danh sách');
        } else {
            alert('Không tìm thấy thông tin sản phẩm');
        }
    }

    // Update items table for stock in
    function updateItemsTableIn() {
        const tbody = document.getElementById('itemsListIn');
        if (!tbody) return;
        
        if (!window.selectedProductsIn || window.selectedProductsIn.length === 0) {
            tbody.innerHTML = '<tr id="noItemsMessageIn"><td colspan="5" class="text-center">Không có thiết bị nào. Vui lòng thêm thiết bị vào danh sách.</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        let total = 0;
        
        window.selectedProductsIn.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.quantity}</td>
                <td>${formatCurrency(product.price)}</td>
                <td>${formatCurrency(product.price * product.quantity)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItemFromListIn(${product.id})">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            total += product.price * product.quantity;
        });
            
        // Update total
        const totalElement = document.querySelector('#totalAmountIn');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
        
        // Update hidden input
        const totalAmountInput = document.getElementById('totalAmountInputIn');
        if (totalAmountInput) {
            totalAmountInput.value = total;
        }
    }

    // Remove item from stock in list
    function removeItemFromListIn(productId) {
        if (window.selectedProductsIn) {
            window.selectedProductsIn = window.selectedProductsIn.filter(p => p.id != productId);
            updateItemsTableIn();
        }
    }

    // Recalculate total for stock in
    function recalculateTotalIn() {
        if (!window.selectedProductsIn) return;
        
        let subtotal = 0;
        window.selectedProductsIn.forEach(product => {
            subtotal += product.price * product.quantity;
        });
        
        const taxRate = parseFloat(document.getElementById('taxAmountIn')?.value || 10);
        const taxValue = subtotal * (taxRate / 100);
        const shippingCost = parseFloat(document.getElementById('shippingCostIn')?.value || 0);
        const discountAmount = parseFloat(document.getElementById('discountAmountIn')?.value || 0);
        const total = subtotal + taxValue + shippingCost - discountAmount;
        
        // Update UI
        const totalElement = document.querySelector('#totalAmountIn');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
        
        // Update hidden input for form submission
        const totalAmountInput = document.getElementById('totalAmountInputIn');
        if (totalAmountInput) {
            totalAmountInput.value = total;
        }
    }

    // Initialize product search for stock in modal
    function initProductSearchIn() {
        const productSearch = document.getElementById('productSearchIn');
        if (!productSearch) return;
        
        const productSearchResults = document.getElementById('productSearchResultsIn');
        const selectedProductId = document.getElementById('selectedProductIdIn');
        const productDetails = document.getElementById('productDetailsIn');
        
        // Search on input
        productSearch.addEventListener('input', debounce(function() {
            const query = productSearch.value.trim();
            if (query.length < 2) {
                productSearchResults.classList.remove('show');
            return;
        }
        
            // Filter equipments based on search query
            const filteredEquipments = equipments.filter(equipment => 
                equipment.name.toLowerCase().includes(query.toLowerCase()) ||
                equipment.id.toString().includes(query)
            );
            
            productSearchResults.innerHTML = '';
            
            if (filteredEquipments.length === 0) {
                const item = document.createElement('a');
                item.className = 'dropdown-item';
                item.textContent = 'Không tìm thấy thiết bị';
                productSearchResults.appendChild(item);
            } else {
                filteredEquipments.forEach(equipment => {
                    const item = document.createElement('a');
                    item.className = 'dropdown-item';
                    item.href = '#';
                    item.textContent = `${equipment.name} (ID: ${equipment.id})`;
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        productSearch.value = equipment.name;
                        selectedProductId.value = equipment.id;
                        
                        // Show product details
                        document.getElementById('productNameIn').textContent = equipment.name;
                        document.getElementById('productStockIn').textContent = (equipment.stockQuantities || 0) + ' ' + (equipment.unit || 'cái');
                        document.getElementById('productPriceIn').textContent = formatCurrency(equipment.price);
                        productDetails.style.display = 'block';
                        
                        productSearchResults.classList.remove('show');
                    });
                    productSearchResults.appendChild(item);
                });
            }
            productSearchResults.classList.add('show');
        }, 300));
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!productSearch.contains(e.target) && !productSearchResults.contains(e.target)) {
                productSearchResults.classList.remove('show');
            }
        });
    }

    // Initialize supplier search for stock in modal
    function initSupplierSearchIn() {
        const supplierSearch = document.getElementById('supplierSearchIn');
        if (!supplierSearch) return;
        
        const supplierSearchResults = document.getElementById('supplierSearchResultsIn');
        const supplierId = document.getElementById('supplierIdIn');
        const selectedSupplierInfo = document.getElementById('selectedSupplierInfoIn');
        
        // Search on input
        supplierSearch.addEventListener('input', debounce(function() {
            const query = supplierSearch.value.trim();
            if (query.length < 2) {
                supplierSearchResults.classList.remove('show');
                return;
            }
            
            fetch(`/warehouse/stock-in/api/suppliers?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    supplierSearchResults.innerHTML = '';
                    
                    if (data.length === 0) {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.textContent = 'Không tìm thấy nhà cung cấp';
                        supplierSearchResults.appendChild(item);
                    } else {
                        data.forEach(supplier => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item';
                            item.href = '#';
                            item.textContent = supplier.name;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                supplierSearch.value = supplier.name;
                                supplierId.value = supplier.id;
                                selectedSupplierInfo.textContent = `Đã chọn: ${supplier.name} (ID: ${supplier.id})`;
                                supplierSearchResults.classList.remove('show');
                            });
                            supplierSearchResults.appendChild(item);
                        });
                    }
                    supplierSearchResults.classList.add('show');
                })
                .catch(error => console.error('Error searching suppliers:', error));
        }, 300));
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!supplierSearch.contains(e.target) && !supplierSearchResults.contains(e.target)) {
                supplierSearchResults.classList.remove('show');
            }
        });
    }
    

    // Global variables for stock out
    let selectedProducts = [];

    // Notification function
    function showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container');
        if (!container) return;
        
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        container.appendChild(notification);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                container.removeChild(notification);
            }, 300);
        }, 5000);
    }
    
    // Document ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date pickers with today + 5 days as default for expected delivery
        const expectedDeliveryDateInput = document.getElementById('expectedDeliveryDate');
        if (expectedDeliveryDateInput) {
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 5);
            expectedDeliveryDateInput.value = defaultDate.toISOString().split('T')[0];
        }

        // Supplier search
        initSupplierSearch();
        
        // Product handling
        document.getElementById('addProductBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            // Check if order type is selected first
            const orderType = document.getElementById('orderType')?.value;
            if (!orderType) {
                showNotification('Vui lòng chọn loại đơn hàng trước khi thêm sản phẩm', 'warning');
                // Focus on the order type select to make it obvious
                document.getElementById('orderType')?.focus();
                return;
            }
            showProductModal();
        });
        
        // Add event listener to product search input for auto-searching
        const productSearchInput = document.getElementById('productSearch');
        if (productSearchInput) {
            productSearchInput.addEventListener('input', debounce(searchProducts, 500));
        }
        
        // Add event listener to order type for validation
        const orderTypeSelect = document.getElementById('orderType');
        if (orderTypeSelect) {
            orderTypeSelect.addEventListener('change', function() {
                // When order type changes, clear the product table to prevent mixing types
                if (selectedProducts.length > 0 && !confirm('Thay đổi loại đơn hàng sẽ xóa tất cả sản phẩm đã chọn. Bạn có muốn tiếp tục?')) {
                    // Restore previous value
                    this.value = this.getAttribute('data-previous-value') || '';
                    return;
                }
                
                // Store the new value for next change
                this.setAttribute('data-previous-value', this.value);
                
                // Clear product table
                const productTableBody = document.getElementById('itemsList');
                if (productTableBody) {
                    productTableBody.innerHTML = '<tr id="noItemsMessage"><td colspan="5" class="text-center">Không có thiết bị nào. Vui lòng thêm thiết bị vào danh sách.</td></tr>';
                    selectedProducts = [];
                    recalculateTotal();
                }
                
                console.log(`Order type changed to: ${this.value}`);
            });
        }
        
        // Auto load product modal when showing
        const productModal = document.getElementById('addItemModal');
        if (productModal) {
            productModal.addEventListener('shown.bs.modal', function() {
                // Auto load some products if search box is empty
                if (document.getElementById('productSearch').value.trim() === '') {
                    console.log("Auto loading initial product list");
                    searchProducts();
                }
            });
        }
        
        // Submit form
        document.getElementById('createStockOutForm')?.addEventListener('submit', submitOrderForm);
        
        // Tax amount change
        document.getElementById('taxAmount')?.addEventListener('change', function() {
            const taxRateElement = document.getElementById('taxRate');
            if (taxRateElement) {
                taxRateElement.textContent = this.value;
            }
            recalculateTotal();
        });
        
        // Shipping cost change
        document.getElementById('shippingCost')?.addEventListener('input', recalculateTotal);
        
        // Check for success or error messages
        const successMessage = /*[[${successMessage}]]*/ null;
        if (successMessage) {
            showNotification(successMessage, 'success');
        }
        
        const errorMessage = /*[[${errorMessage}]]*/ null;
        if (errorMessage) {
            showNotification(errorMessage, 'danger');
        }
    });
    
    // Function to display product search results
    function displayProductResults(data) {
        const resultsContainer = document.getElementById('productSearchResults');
        if (!resultsContainer) {
            console.error("Results container not found");
            return;
        }
        
        // Clear previous results
        resultsContainer.innerHTML = '';
        
        // Check if data is valid
        if (!data || !Array.isArray(data) || data.length === 0) {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = 'Không tìm thấy sản phẩm';
            resultsContainer.appendChild(item);
            console.log("No products found or invalid data format");
            return;
        }
        
        console.log(`Found ${data.length} products to display`);
        
        // Process each product
        data.forEach(product => {
            if (!product) return;
            
            console.log("Displaying product:", product.name || 'Unnamed', product.id || 'No ID');
            
            try {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.type = 'button';
                
                // Ensure price is a number
                let priceValue = 0;
                try {
                    priceValue = parseFloat(product.price) || 0;
                } catch (e) {
                    console.error("Error parsing price:", e);
                }
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${product.name || 'Không có tên'}</h5>
                        <small>${formatCurrency(priceValue)}</small>
                    </div>
                    <p class="mb-1">ID: ${product.id || 'N/A'}</p>
                    <small>Tồn kho: ${product.stockQuantities || 0}</small>
                `;
                
                item.addEventListener('click', function() {
                    console.log("Product selected:", product);
                    addProductToTable(product);
                    
                    // Close modal using Bootstrap API
                    const productModal = document.getElementById('addItemModal');
                    if (productModal) {
                        const bsModal = bootstrap.Modal.getInstance(productModal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }
                });
                
                resultsContainer.appendChild(item);
            } catch (error) {
                console.error("Error creating product item:", error, product);
            }
        });
    }
    
    // Initialize supplier search
    function initSupplierSearch() {
        const supplierSearch = document.getElementById('supplierSearch');
        if (!supplierSearch) return;
        
        const supplierSearchResults = document.getElementById('supplierSearchResults');
        const supplierId = document.getElementById('supplierId');
        const selectedSupplierInfo = document.getElementById('selectedSupplierInfo');
        
        // Search on input
        supplierSearch.addEventListener('input', debounce(function() {
            const query = supplierSearch.value.trim();
            if (query.length < 2) {
                supplierSearchResults.classList.remove('show');
                return;
            }
            
            fetch(`/warehouse/stock-out/api/suppliers?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    supplierSearchResults.innerHTML = '';
                    
                    if (data.length === 0) {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.textContent = 'Không tìm thấy nhà cung cấp';
                        supplierSearchResults.appendChild(item);
                    } else {
                        data.forEach(supplier => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item';
                            item.href = '#';
                            item.textContent = supplier.name;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                supplierSearch.value = supplier.name;
                                supplierId.value = supplier.id;
                                selectedSupplierInfo.textContent = `Đã chọn: ${supplier.name} (ID: ${supplier.id})`;
                                supplierSearchResults.classList.remove('show');
                            });
                            supplierSearchResults.appendChild(item);
                        });
                    }
                    supplierSearchResults.classList.add('show');
                })
                .catch(error => console.error('Error searching suppliers:', error));
        }, 300));
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!supplierSearch.contains(e.target) && !supplierSearchResults.contains(e.target)) {
                supplierSearchResults.classList.remove('show');
            }
        });
    }
    
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Format currency
    function formatCurrency(amount) {
        if (!amount) return '0 VNĐ';
        return new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
    }
    
    // Get category name function
    function getCategoryName(category) {
        const categories = {
            'diagnostic': 'Chẩn đoán',
            'surgical': 'Phẫu thuật',
            'monitoring': 'Theo dõi',
            'laboratory': 'Phòng thí nghiệm'
        };
        return categories[category] || category || 'N/A';
    }
    
    // Get stock status function
    function getStockStatus(stock, minStock) {
        if (stock <= 0) return { status: 'out', class: 'stock-low' };
        if (stock <= (minStock || 10)) return { status: 'low', class: 'stock-low' };
        return { status: 'normal', class: 'stock-normal' };
    }
    
    // Get order status text function
    function getOrderStatusText(status) {
        const statusTexts = {
            'NEED_TO_ADD': 'Cần nhập',
            'PREPARING': 'Đang chuẩn bị',
            'COMPLETED': 'Hoàn thành',
            'REJECTED': 'Từ chối',
            'WAITING_FOR_DELIVERY': 'Chờ giao hàng',
            'RECEIVED': 'Đã nhận',
            'PREPARE_DELIVERY': 'Chuẩn bị giao',
            'DELIVERING': 'Đang giao'
        };
        return statusTexts[status] || status || 'N/A';
    }
    
    // Filter products function
    function filterProducts() {
        const searchTerm = $('#searchProducts').val().toLowerCase();
        const categoryFilter = $('#categoryFilter').val();
        const stockFilter = $('#stockFilter').val();
        
        $('.product-item').each(function() {
            const $item = $(this);
            const productName = $item.find('.card-title').text().toLowerCase();
            const productCategory = $item.data('category');
            const productStock = $item.data('stock');
            
            let shouldShow = true;
            
            // Search filter
            if (searchTerm && !productName.includes(searchTerm)) {
                shouldShow = false;
            }
            
            // Category filter
            if (categoryFilter && productCategory !== categoryFilter) {
                shouldShow = false;
            }
            
            // Stock filter
            if (stockFilter) {
                if (stockFilter === 'low' && productStock !== 'low') shouldShow = false;
                if (stockFilter === 'normal' && productStock !== 'normal') shouldShow = false;
                if (stockFilter === 'out' && productStock !== 'out') shouldShow = false;
            }
            
            $item.toggle(shouldShow);
        });
    }
    

    
</script>

<!-- Stock-In modal fragment -->
<div th:replace="templates_storage/fragments/createStockInModal :: createStockInModal"></div>

<script>
  var stockInOrders = [];
  var stockOutOrders = [];
  
  // Khởi tạo dữ liệu từ server
  function initializeData() {
    try {
      var stockInData = '[[${stockInOrders}]]';
      var stockOutData = '[[${stockOutOrders}]]';
      console.log('Raw Stock In Data:', stockInData);
      console.log('Raw Stock Out Data:', stockOutData);
      stockInOrders = stockInData && stockInData !== '' && stockInData !== '[[${stockInOrders}]]' ? JSON.parse(stockInData) : [];
      stockOutOrders = stockOutData && stockOutData !== '' && stockOutData !== '[[${stockOutOrders}]]' ? JSON.parse(stockOutData) : [];
      console.log('Stock In Orders:', stockInOrders);
      console.log('Stock Out Orders:', stockOutOrders);
    } catch (e) {
      console.error('Error parsing order data:', e);
      stockInOrders = [];
      stockOutOrders = [];
    }
    renderStockInOrders();
    renderStockOutOrders();
  }
  
  // Render danh sách đơn nhập
  function renderStockInOrders() {
    var pendingStockIns = stockInOrders.filter(function(order) { return order.status === 'PENDING'; });
    var completedStockIns = stockInOrders.filter(function(order) { return order.status === 'COMPLETED'; });
    $('#pendingStockInCount').text(pendingStockIns.length);
    $('#completedStockInCount').text(completedStockIns.length);
    
    var container = $('#stockInOrdersContainer');
    container.empty();
    if (stockInOrders.length === 0) {
      container.append('<p class="text-muted">Không có đơn nhập nào.</p>');
            return;
        }
        
    var activeList = $('<ul class="list-group mb-3">');
    var completedList = $('<ul class="list-group mb-3">');
    
    pendingStockIns.forEach(function(order) {
      var badgeClass = order.status === 'PENDING' ? 'badge-warning' : 'badge-success';
      var badgeText = order.status === 'PENDING' ? 'Đang chờ xử lý' : 'Hoàn thành';
      var listItem = `
        <li class="list-group-item d-flex justify-content-between align-items-center" onclick="viewStockInOrderDetails(${order.id})" style="cursor: pointer;">
          Đơn nhập #${order.id} - ${formatDate(order.createdDate)}
          <span class="badge ${badgeClass} badge-pill">${badgeText}</span>
        </li>
      `;
      activeList.append(listItem);
    });
    
    completedStockIns.forEach(function(order) {
      var badgeClass = order.status === 'PENDING' ? 'badge-warning' : 'badge-success';
      var badgeText = order.status === 'PENDING' ? 'Đang chờ xử lý' : 'Hoàn thành';
      var listItem = `
        <li class="list-group-item d-flex justify-content-between align-items-center" onclick="viewStockInOrderDetails(${order.id})" style="cursor: pointer;">
          Đơn nhập #${order.id} - ${formatDate(order.createdDate)}
          <span class="badge ${badgeClass} badge-pill">${badgeText}</span>
        </li>
      `;
      completedList.append(listItem);
    });
    
    if (pendingStockIns.length > 0) {
      container.append('<h5>Đang chờ xử lý</h5>');
      container.append(activeList);
    }
    if (completedStockIns.length > 0) {
      container.append('<h5>Đã hoàn thành</h5>');
      container.append(completedList);
    }
  }
  
  // Render danh sách đơn xuất
  function renderStockOutOrders() {
    var preparingStockOuts = stockOutOrders.filter(function(order) { return order.status === 'PREPARING'; });
    var completedStockOuts = stockOutOrders.filter(function(order) { return order.status === 'COMPLETED'; });
    $('#preparingStockOutCount').text(preparingStockOuts.length);
    $('#completedStockOutCount').text(completedStockOuts.length);
    
    var container = $('#stockOutOrdersContainer');
    container.empty();
    if (stockOutOrders.length === 0) {
      container.append('<p class="text-muted">Không có đơn xuất nào.</p>');
            return;
        }
        
    var activeList = $('<ul class="list-group mb-3">');
    var completedList = $('<ul class="list-group mb-3">');
    
    preparingStockOuts.forEach(function(order) {
      var badgeClass = order.status === 'PREPARING' ? 'badge-warning' : 'badge-success';
      var badgeText = order.status === 'PREPARING' ? 'Đang chuẩn bị' : 'Hoàn thành';
      var listItem = `
        <li class="list-group-item d-flex justify-content-between align-items-center" onclick="viewStockOutOrderDetails(${order.id})" style="cursor: pointer;">
          Đơn xuất #${order.id} - ${formatDate(order.createdDate)}
          <span class="badge ${badgeClass} badge-pill">${badgeText}</span>
        </li>
      `;
      activeList.append(listItem);
    });
    
    completedStockOuts.forEach(function(order) {
      var badgeClass = order.status === 'PREPARING' ? 'badge-warning' : 'badge-success';
      var badgeText = order.status === 'PREPARING' ? 'Đang chuẩn bị' : 'Hoàn thành';
      var listItem = `
        <li class="list-group-item d-flex justify-content-between align-items-center" onclick="viewStockOutOrderDetails(${order.id})" style="cursor: pointer;">
          Đơn xuất #${order.id} - ${formatDate(order.createdDate)}
          <span class="badge ${badgeClass} badge-pill">${badgeText}</span>
        </li>
      `;
      completedList.append(listItem);
    });
    
    if (preparingStockOuts.length > 0) {
      container.append('<h5>Đang chuẩn bị</h5>');
      container.append(activeList);
    }
    if (completedStockOuts.length > 0) {
      container.append('<h5>Đã hoàn thành</h5>');
      container.append(completedList);
    }
  }
  
  // Gọi hàm khởi tạo khi trang load
  $(document).ready(function() {
    initializeData();
  });
</script>

<!-- Hàm xử lý đơn nhập kho cho thiết bị y tế -->
<script>
    function loadStockInOrders() {
        console.log('Loading stock-in orders for medical equipment...');
        const container = $('#stockInOrders');
        console.log('Container found:', container.length > 0);
        container.empty();

        // Show loading indicator
        container.html(`
            <div class="text-center py-5">
                <i class="ri-loader-4-line fa-spin fs-1 text-muted"></i>
                <p class="mt-3">Đang tải dữ liệu...</p>
            </div>
        `);

        // Load data immediately
        container.empty();

        // Debug: Check database data
        console.log('Raw stockInOrders from database:', stockInOrders);
        console.log('StockInOrders type:', typeof stockInOrders);
        console.log('StockInOrders length:', stockInOrders ? (Array.isArray(stockInOrders) ? stockInOrders.length : 'Not an array') : 'Undefined');
        
        // Debug: Log each order status
        if (Array.isArray(stockInOrders)) {
            stockInOrders.forEach((order, index) => {
                console.log(`Order ${index}: ID=${order.id}, Status=${order.status}, Type=${order.transaction_type}`);
            });
        }
        
        // Ensure stockInOrders is an array and filter orders
        const validOrders = Array.isArray(stockInOrders) ? stockInOrders : [];
        const filteredOrders = validOrders.filter(order => {
            if (!order || !order.status) return false;
            console.log('Checking order:', order);
            
            // Điều kiện giống medicine nhưng cho MEDICAL_PRODUCT
            const allowedStatuses = ['NEED_TO_ADD', 'WAITING_FOR_DELIVERY', 'RECEIVED'];
            const statusMatch = allowedStatuses.includes(order.status);
            const typeMatch = !order.transaction_type || order.transaction_type === 'STOCK_IN';
            const productMatch = !order.products || (Array.isArray(order.products) && order.products.length === 0) || 
                (order.products && Array.isArray(order.products) && order.products.some(p => p.type === 'MEDICAL_PRODUCT'));
            
            console.log(`StockIn Order ${order.id}: status=${order.status}, statusMatch=${statusMatch}, typeMatch=${typeMatch}, productMatch=${productMatch}`);
            console.log(`StockIn Order ${order.id}: products=`, order.products);
            return statusMatch && typeMatch && productMatch;
        });
        
        console.log('Valid stock in orders:', validOrders);
        console.log('Filtered stock in orders:', filteredOrders);
        console.log('Filtered stock in orders length:', filteredOrders.length);

        if (filteredOrders.length === 0) {
            container.html(`
                <div class="text-center py-5">
                    <i class="ri-inbox-line fs-1 text-muted"></i>
                    <p class="mt-3">Không có đơn nhập kho nào. Kiểm tra console để debug.</p>
                </div>
            `);
            return;
        }

        filteredOrders.forEach(order => {
            try {
                // Safely get order properties with fallbacks
                const orderId = order.id || order.invoiceNumber || 'N/A';
                const supplierName = order.supplierName || order.supplier || 'N/A';
                const transactionDate = order.transactionDate || order.createdDate || order.date || 'N/A';
                const totalAmount = order.totalAmount || 0;
                
                // Calculate total amount and product count from products array
                let calculatedTotal = 0;
                let calculatedProductCount = 0;
                if (order.products && Array.isArray(order.products) && order.products.length > 0) {
                    calculatedProductCount = order.products.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    calculatedTotal = order.products.reduce((sum, item) => {
                        return sum + ((item.quantity || 0) * (item.price || 0));
                    }, 0);
                }

                const orderDiv = `
                    <div class="order-item order-${order.status.toLowerCase()}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Đơn nhập: ${orderId}</h6>
                                <p><strong>Nhà cung cấp:</strong> ${supplierName}</p>
                                <p><strong>Ngày tạo:</strong> ${transactionDate}</p>
                                <p><strong>Tổng tiền:</strong> ${formatCurrency(totalAmount || calculatedTotal)}</p>
                                <p><strong>Số lượng sản phẩm:</strong> ${calculatedProductCount}</p>
                                <p><strong>Trạng thái:</strong> <span class="badge bg-info">${getOrderStatusText(order.status)}</span></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical">
                                    <a class="btn btn-primary btn-sm mb-1" href="/warehouse/stock-in/${orderId}">
                                        <i class="ri-eye-line"></i> Xem chi tiết
                                    </a>
                                    <button class="btn btn-success btn-sm mb-1" onclick="processStockInOrder('${orderId}')">
                                        <i class="ri-check-line"></i> Xử lý
                </button>
                                    <button class="btn btn-danger btn-sm" onclick="confirmRejectStockIn('${orderId}')">
                                        <i class="ri-close-line"></i> Từ chối
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(orderDiv);
            } catch (error) {
                console.error('Error processing stock in order:', error, order);
            }
        });
        console.log('Stock in orders loaded:', filteredOrders.length, 'orders');
    }
    
    function viewStockInOrder(id) {
        let order = stockInOrders.find(o => o.id === id);
        if (!order) {
            showNotification('Không tìm thấy đơn nhập kho!', 'danger');
            return;
        }
        
        $('#stockInOrderId').text(order.id);
        $('#stockInOrderSupplier').text(order.supplierName);
        $('#stockInOrderDate').text(order.date);
        $('#stockInOrderTotal').text(formatCurrency(order.total));
        
        $('#stockInOrderItems').empty();
        order.items.forEach(item => {
            $('#stockInOrderItems').append(`
                <tr>
                    <td>${item.equipmentName}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${formatCurrency(item.quantity * item.price)}</td>
                </tr>
            `);
        });
        
        $('#stockInOrderModal').modal('show');
    }
    
    function processStockInOrder(orderId) {
        console.log('Processing stock-in order:', orderId);
        
        if (!CSRF_TOKEN) {
            alert('Lỗi: CSRF token không khả dụng');
            return;
        }
        
        $.ajax({
            url: `/warehouse/medical-equipment/api/stock-in/${orderId}/process`,
            type: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [CSRF_HEADER]: CSRF_TOKEN
            },
            success: function(response) {
                console.log('API Response:', response);
                if (response.success) {
                    alert('Đã xử lý đơn nhập thành công! Đơn hàng đã chuyển sang trang StockInInvoice.');
                    setTimeout(() => loadStockInOrders(), 100);
                } else {
                    alert('Lỗi: ' + (response.message || 'Không xác định'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Error processing stock-in order:', error);
                alert('Lỗi khi xử lý đơn hàng: ' + error);
            }
        });
    }
    
    function confirmRejectStockIn(orderId) {
        const reason = prompt('Nhập lý do từ chối:');
        if (reason === null) return; // User cancelled
        
        if (!reason.trim()) {
            alert('Vui lòng nhập lý do từ chối!');
            return;
        }
        
        console.log('Rejecting stock-in order:', orderId, 'Reason:', reason);
        
        if (!CSRF_TOKEN) {
            alert('Lỗi: CSRF token không khả dụng');
            return;
        }
        
        $.ajax({
            url: `/warehouse/medical-equipment/api/stock-in/${orderId}/reject`,
            type: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [CSRF_HEADER]: CSRF_TOKEN
            },
            data: JSON.stringify({ reason: reason }),
            success: function(response) {
                console.log('API Response:', response);
                if (response.success) {
                    alert('Đã từ chối đơn nhập thành công! Đơn hàng đã chuyển sang trạng thái REJECTED.');
                    setTimeout(() => loadStockInOrders(), 100);
                } else {
                    alert('Lỗi: ' + (response.message || 'Không xác định'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Error rejecting stock-in order:', error);
                alert('Lỗi khi từ chối đơn hàng: ' + error);
            }
        });
    }
    
    // Gọi hàm khi tab được kích hoạt
    $(document).ready(function() {
        $('#stock-in-tab').on('shown.bs.tab', function (e) {
            loadStockInOrders();
        });
    });
</script>

<!-- Hàm xử lý đơn xuất kho cho thiết bị y tế -->
<script>
    function loadStockOutOrders() {
        console.log('Loading stock-out orders for medical equipment...');
        const container = $('#stockOutOrders');
        console.log('Container found:', container.length > 0);
        container.empty();

        // Show loading indicator
        container.html(`
            <div class="text-center py-5">
                <i class="ri-loader-4-line fa-spin fs-1 text-muted"></i>
                <p class="mt-3">Đang tải dữ liệu...</p>
            </div>
        `);

        // Load data immediately
        container.empty();

        // Debug: Check database data
        console.log('Raw stockOutOrders from database:', stockOutOrders);
        console.log('StockOutOrders type:', typeof stockOutOrders);
        console.log('StockOutOrders length:', stockOutOrders ? (Array.isArray(stockOutOrders) ? stockOutOrders.length : 'Not an array') : 'Undefined');
        
        // Debug: Log each order status
        if (Array.isArray(stockOutOrders)) {
            stockOutOrders.forEach((order, index) => {
                console.log(`Order ${index}: ID=${order.id}, Status=${order.status}, Type=${order.transaction_type}`);
            });
        }
        
        // Ensure stockOutOrders is an array and filter orders
        const validOrders = Array.isArray(stockOutOrders) ? stockOutOrders : [];
        const filteredOrders = validOrders.filter(order => {
            if (!order || !order.status) return false;
            console.log('Checking order:', order);
            
            // Điều kiện giống medicine nhưng cho MEDICAL_PRODUCT
            const allowedStatuses = ['PREPARING', 'PREPARE_DELIVERY', 'DELIVERING'];
            const statusMatch = allowedStatuses.includes(order.status);
            const typeMatch = !order.transaction_type || order.transaction_type === 'STOCK_OUT';
            const productMatch = !order.products || (Array.isArray(order.products) && order.products.length === 0) || 
                (order.products && Array.isArray(order.products) && order.products.some(p => p.type === 'MEDICAL_PRODUCT'));
            
            console.log(`StockOut Order ${order.id}: status=${order.status}, statusMatch=${statusMatch}, typeMatch=${typeMatch}, productMatch=${productMatch}`);
            console.log(`StockOut Order ${order.id}: products=`, order.products);
            return statusMatch && typeMatch && productMatch;
        });
        
        console.log('Valid stock out orders:', validOrders);
        console.log('Filtered stock out orders:', filteredOrders);
        console.log('Filtered stock out orders length:', filteredOrders.length);

        if (filteredOrders.length === 0) {
            container.html(`
                <div class="text-center py-5">
                    <i class="ri-inbox-line fs-1 text-muted"></i>
                    <p class="mt-3">Không có đơn xuất kho nào. Kiểm tra console để debug.</p>
                </div>
            `);
            return;
        }

        filteredOrders.forEach(order => {
            try {
                // Safely get order properties with fallbacks
                const orderId = order.id || order.invoiceNumber || 'N/A';
                const recipient = order.recipient || order.departmentName || order.department || order.customerName || 'N/A';
                const transactionDate = order.transactionDate || order.createdDate || order.date || 'N/A';
                const totalAmount = order.totalAmount || 0;
                
                // Calculate total amount and product count from products array
                let calculatedTotal = 0;
                let calculatedProductCount = 0;
                if (order.products && Array.isArray(order.products) && order.products.length > 0) {
                    calculatedProductCount = order.products.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    calculatedTotal = order.products.reduce((sum, item) => {
                        return sum + ((item.quantity || 0) * (item.price || 0));
                    }, 0);
                }

                const orderDiv = `
                    <div class="order-item order-${order.status.toLowerCase()}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Đơn xuất: ${orderId}</h6>
                                <p><strong>Người nhận:</strong> ${recipient}</p>
                                <p><strong>Ngày tạo:</strong> ${transactionDate}</p>
                                <p><strong>Tổng tiền:</strong> ${formatCurrency(totalAmount || calculatedTotal)}</p>
                                <p><strong>Số lượng sản phẩm:</strong> ${calculatedProductCount}</p>
                                <p><strong>Trạng thái:</strong> <span class="badge bg-info">${getOrderStatusText(order.status)}</span></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical">
                                    <a class="btn btn-primary btn-sm mb-1" href="/warehouse/stock-out/${orderId}">
                                        <i class="ri-eye-line"></i> Xem chi tiết
                                    </a>
                                    <button class="btn btn-success btn-sm mb-1" onclick="prepareStockOutOrder('${orderId}')">
                                        <i class="ri-check-line"></i> Chuẩn bị
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="confirmRejectStockOut('${orderId}')">
                                        <i class="ri-close-line"></i> Từ chối
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(orderDiv);
            } catch (error) {
                console.error('Error processing stock out order:', error, order);
            }
        });
        console.log('Stock out orders loaded:', filteredOrders.length, 'orders');
    }
    
    function viewStockOutOrder(id) {
        let order = stockOutOrders.find(o => o.id === id);
        if (!order) {
            showNotification('Không tìm thấy đơn xuất kho!', 'danger');
            return;
        }
        
        $('#stockOutOrderId').text(order.id);
        $('#stockOutOrderCustomer').text(order.customerName);
        $('#stockOutOrderDate').text(order.date);
        $('#stockOutOrderTotal').text(formatCurrency(order.total));
        
        $('#stockOutOrderItems').empty();
        order.items.forEach(item => {
            $('#stockOutOrderItems').append(`
                <tr>
                    <td>${item.equipmentName}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${formatCurrency(item.quantity * item.price)}</td>
                </tr>
            `);
        });
        
        $('#stockOutOrderModal').modal('show');
    }
    
    function prepareStockOutOrder(orderId) {
        console.log('Preparing stock-out order:', orderId);
        
        if (!CSRF_TOKEN) {
            alert('Lỗi: CSRF token không khả dụng');
            return;
        }
        
        $.ajax({
            url: `/warehouse/medical-equipment/api/stock-out/${orderId}/prepare`,
            type: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [CSRF_HEADER]: CSRF_TOKEN
            },
            success: function(response) {
                console.log('API Response:', response);
                if (response.success) {
                    alert('Đã chuẩn bị đơn xuất thành công! Đơn hàng đã chuyển sang trang StockOut.');
                    setTimeout(() => loadStockOutOrders(), 100);
                } else {
                    alert('Lỗi: ' + (response.message || 'Không xác định'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Error preparing stock-out order:', error);
                alert('Lỗi khi chuẩn bị đơn hàng: ' + error);
            }
        });
    }
    
    function confirmRejectStockOut(orderId) {
        const reason = prompt('Nhập lý do từ chối:');
        if (reason === null) return; // User cancelled
        
        if (!reason.trim()) {
            alert('Vui lòng nhập lý do từ chối!');
            return;
        }
        
        console.log('Rejecting stock-out order:', orderId, 'Reason:', reason);
        
        if (!CSRF_TOKEN) {
            alert('Lỗi: CSRF token không khả dụng');
            return;
        }
        
        $.ajax({
            url: `/warehouse/medical-equipment/api/stock-out/${orderId}/reject`,
            type: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [CSRF_HEADER]: CSRF_TOKEN
            },
            data: JSON.stringify({ reason: reason }),
            success: function(response) {
                console.log('API Response:', response);
                if (response.success) {
                    alert('Đã từ chối đơn xuất thành công! Đơn hàng đã chuyển sang trạng thái REJECTED.');
                    setTimeout(() => loadStockOutOrders(), 100);
                } else {
                    alert('Lỗi: ' + (response.message || 'Không xác định'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Error rejecting stock-out order:', error);
                alert('Lỗi khi từ chối đơn hàng: ' + error);
            }
        });
    }
    
    function getOrderStatusText(status) {
        const statusMap = {
            'NEED_TO_ADD': 'Cần nhập',
            'PREPARING': 'Đang chuẩn bị',
            'COMPLETED': 'Hoàn thành',
            'REJECTED': 'Từ chối',
            'WAITING_FOR_DELIVERY': 'Chờ giao hàng',
            'RECEIVED': 'Đã nhận',
            'PREPARE_DELIVERY': 'Chuẩn bị giao',
            'DELIVERING': 'Đang giao'
        };
        return statusMap[status] || status;
    }
    
    // Load products with improved functionality
    function loadProducts() {
        filteredEquipments = equipments ? [...equipments] : [];
        filterEquipments();
    }

    // Load problem equipments function
    function loadProblemEquipments() {
        console.log('Loading problem equipments...');
        
        if (!equipments || equipments.length === 0) {
            $('#problemEquipmentList').html('<tr><td colspan="6" class="text-center">Không có thiết bị nào có vấn đề</td></tr>');
            return;
        }
        
        const problemEquipments = equipments.filter(equipment => {
            const stock = equipment.stockQuantities || 0;
            const minStock = equipment.minStock || 10;
            return stock <= minStock;
        });
        
        console.log('Problem equipments found:', problemEquipments.length);
        
        const tbody = $('#problemEquipmentList');
        tbody.empty();
        
        if (problemEquipments.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center">Không có thiết bị nào có vấn đề</td></tr>');
            return;
        }
        
        problemEquipments.forEach(equipment => {
            const stock = equipment.stockQuantities || 0;
            const minStock = equipment.minStock || 10;
            const status = stock === 0 ? 'Hết hàng' : 'Sắp hết hàng';
            const statusClass = stock === 0 ? 'text-danger' : 'text-warning';
            
            const row = `
                <tr>
                    <td>${equipment.id}</td>
                    <td>${equipment.name}</td>
                    <td>${getCategoryName(equipment.category)}</td>
                    <td><span class="stock-low">${stock}</span></td>
                    <td><span class="${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="createStockInForEquipment(${equipment.id})" title="Tạo đơn nhập">
                            <i class="ri-add-circle-line"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="viewEquipmentDetailsById(${equipment.id})" title="Xem chi tiết">
                            <i class="ri-eye-line"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
        
        updateCounts();
    }
    
    // Update badge counts with improved logic
    function updateCounts() {
        // Đếm số sản phẩm đang hiển thị trên trang hiện tại (filteredEquipments)
        $('#productCount').text(filteredEquipments ? filteredEquipments.length : 0);
        // Đếm số thiết bị có vấn đề trên trang hiện tại
        $('#problemCount').text(filteredEquipments ? filteredEquipments.filter(e => (e.stockQuantities || 0) <= 10).length : 0);
        // Đếm số đơn nhập đang hiển thị trên trang hiện tại (nếu có phân trang/filter thì dùng biến filteredStockInOrders, nếu không thì dùng stockInOrders)
        if (typeof filteredStockInOrders !== 'undefined' && Array.isArray(filteredStockInOrders)) {
            $('#stockInCount').text(filteredStockInOrders.length);
        } else {
            $('#stockInCount').text(stockInOrders ? stockInOrders.length : 0);
        }
        // Đếm số đơn xuất đang hiển thị trên trang hiện tại (nếu có phân trang/filter thì dùng biến filteredStockOutOrders, nếu không thì dùng stockOutOrders)
        if (typeof filteredStockOutOrders !== 'undefined' && Array.isArray(filteredStockOutOrders)) {
            $('#stockOutCount').text(filteredStockOutOrders.length);
        } else {
            $('#stockOutCount').text(stockOutOrders ? stockOutOrders.length : 0);
        }
    }
    
    // Helper functions for dates
    function getTodayDate() {
        const today = new Date();
        return today.toISOString().split('T')[0];
    }
    
    function getTomorrowDate() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow.toISOString().split('T')[0];
    }
    
    // View equipment details (for button click)
    function viewEquipmentDetails(button) {
        const equipmentId = $(button).data('id');
        viewEquipmentDetailsById(equipmentId);
    }
    
    // View equipment details by ID
    function viewEquipmentDetailsById(equipmentId) {
        const equipment = equipments.find(e => e.id == equipmentId);
        if (equipment) {
            $('#detailId').text(equipment.id || 'N/A');
            $('#detailName').text(equipment.name || 'N/A');
            $('#detailCategory').text(getCategoryName(equipment.category) || 'N/A');
            $('#detailStock').text((equipment.stockQuantities || 0) + ' ' + (equipment.unit || 'cái'));
            $('#detailPrice').text(formatCurrency(equipment.price || 0));
            $('#detailUnit').text(equipment.unit || 'cái');
            $('#detailManufacturer').text(equipment.manufacturer || 'N/A');
            $('#detailWarranty').text((equipment.warrantyPeriod || 0) + ' tháng');
            $('#detailStatus').text(equipment.productStatus || 'ACTIVE');
            $('#detailLabel').text(equipment.label || 'STANDARD');
            $('#detailDescription').text(equipment.description || 'Không có mô tả');
            
            // Handle image display
            const detailImage = $('#detailImage');
            const noImageMessage = $('#noImageMessage');
            
            if (equipment.imageUrl && equipment.imageUrl.trim() !== '') {
                detailImage.attr('src', equipment.imageUrl);
                detailImage.show();
                noImageMessage.hide();
            } else {
                detailImage.hide();
                noImageMessage.show();
            }
            
            $('#equipmentDetailModal').modal('show');
        } else {
            alert('Không tìm thấy thiết bị!');
        }
    }
    
    // Create stock in for specific equipment
    function createStockInForEquipment(equipmentId) {
        console.log('Creating stock in for equipment:', equipmentId);
        const equipment = equipments.find(e => e.id == equipmentId);
        if (equipment) {
            // Pre-fill the create stock in modal
            $('#supplierSearchIn').val('');
            $('#supplierIdIn').val('');
            $('#selectedSupplierInfoIn').hide();
            $('#expectedDeliveryDateIn').val(getTomorrowDate());
            $('#invoiceNumberIn').val('');
            $('#transactionDateIn').val(getTodayDate());
            $('#orderTypeIn').val('MEDICAL_EQUIPMENT');
            $('#reasonIn').val('RESTOCK');
            $('#paymentMethodIn').val('CASH');
            $('#taxAmountIn').val('0');
            $('#shippingCostIn').val('0');
            $('#discountAmountIn').val('0');
            $('#notesIn').val(`Tạo đơn nhập cho thiết bị: ${equipment.name}`);
            
            // Clear previous items
            window.selectedProductsIn = [];
            updateItemsTableIn();
            
            // Add the equipment to the list
            window.selectedProductsIn.push({
                id: equipment.id,
                name: equipment.name,
                price: equipment.price,
                quantity: 1
            });
            updateItemsTableIn();
            
            // Show the modal
            $('#createInboundOrderModal').modal('show');
        } else {
            alert('Không tìm thấy thiết bị!');
        }
    }
    
    // Initialize page
    $(document).ready(function() {
        // Initially hide all tab content except the first one
        $('.tab-pane').removeClass('show active');
        $('#products').addClass('show active');
        $('#products-tab').addClass('active');
        
        // Load all data initially with a small delay to ensure DOM is ready
        setTimeout(() => {
            console.log('Initializing data loading...');
            initializeEquipmentData();
            loadProducts();
            loadProblemEquipments();
            loadStockInOrders();
            loadStockOutOrders();
            updateCounts();
            console.log('Data loading completed');
        }, 100);

        // Initialize filters
        $('#searchProducts').on('input', filterEquipments);
        $('#categoryFilter').on('change', function() {
            filterEquipments();
        });
        $('#stockFilter').on('change', filterEquipments);

        // Add sorting event listeners
        $('.sortable-header').on('click', function() {
            const field = $(this).data('sort');
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // Update visual feedback
            $('.sortable-header').removeClass('active');
            $(this).addClass('active');
            
            // Update sort icons
            $('.sortable-header i').removeClass('ri-sort-asc ri-sort-desc').addClass('ri-sort-asc');
            const icon = currentSortDirection === 'asc' ? 'ri-sort-asc' : 'ri-sort-desc';
            $(this).find('i').removeClass('ri-sort-asc ri-sort-desc').addClass(icon);
            
            filterEquipments();
        });

        // Handle tab clicks with Bootstrap 5 compatibility
        $('#workflowTabs a').on('click', function(e) {
            e.preventDefault();
            const target = $(e.target).attr('href');
            
            // Remove active class from all tabs
            $('#workflowTabs a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all tab content
            $('.tab-pane').removeClass('show active');
            
            // Show only the clicked tab content
            $(target).addClass('show active');
            
            // Refresh data for the active tab to ensure it's up to date
            if (target === '#products') {
                loadProducts();
            } else if (target === '#problem') {
                loadProblemEquipments();
            } else if (target === '#stock-in') {
                loadStockInOrders();
            } else if (target === '#stock-out') {
                loadStockOutOrders();
            }
        });
    });

function deleteEquipment(id) {
    const equipment = equipments.find(e => e.id == id);
    if (!equipment) {
        alert('Không tìm thấy thiết bị!');
        return;
    }
    if (confirm(`Bạn có chắc chắn muốn xóa thiết bị "${equipment.name}"?`)) {
        fetch(`/warehouse/medical-equipment/${id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [CSRF_HEADER]: CSRF_TOKEN
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Xóa thiết bị thành công!');
                // Xóa khỏi mảng và reload UI
                equipments = equipments.filter(e => e.id != id);
                loadProducts();
                updateCounts();
            } else {
                alert('Có lỗi xảy ra khi xóa thiết bị!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi xóa thiết bị!');
        });
    }
}
</script>

<!-- Equipment Detail Modal -->
<div class="modal fade" id="equipmentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết thiết bị</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <img id="detailImage" src="" alt="Hình ảnh thiết bị" class="img-fluid rounded" style="max-height: 200px; max-width: 100%;" onerror="this.style.display='none'">
                            <div id="noImageMessage" class="text-muted mt-2" style="display: none;">
                                <i class="ri-image-line fs-1"></i>
                                <p class="mt-2">Không có hình ảnh</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Mã sản phẩm:</strong> <span id="detailId"></span></p>
                                <p><strong>Tên sản phẩm:</strong> <span id="detailName"></span></p>
                                <p><strong>Danh mục:</strong> <span id="detailCategory"></span></p>
                                <p><strong>Tồn kho:</strong> <span id="detailStock"></span></p>
                                <p><strong>Đơn giá:</strong> <span id="detailPrice"></span></p>
                                <p><strong>Đơn vị:</strong> <span id="detailUnit"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Nhà sản xuất:</strong> <span id="detailManufacturer"></span></p>
                                <p><strong>Bảo hành:</strong> <span id="detailWarranty"></span></p>
                                <p><strong>Trạng thái:</strong> <span id="detailStatus"></span></p>
                                <p><strong>Nhãn:</strong> <span id="detailLabel"></span></p>
                                <p><strong>Mô tả:</strong> <span id="detailDescription"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Equipment Modal -->
<div class="modal fade" id="editEquipmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa thiết bị</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editEquipmentForm">
                    <input type="hidden" id="editEquipmentId">
                    <div class="mb-3">
                        <label class="form-label">Tên thiết bị</label>
                        <input type="text" class="form-control" id="editEquipmentName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã thiết bị</label>
                        <input type="text" class="form-control" id="editEquipmentCode" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" id="editEquipmentCategory" required>
                            <option value="diagnostic">Chẩn đoán</option>
                            <option value="surgical">Phẫu thuật</option>
                            <option value="monitoring">Theo dõi</option>
                            <option value="laboratory">Phòng thí nghiệm</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tồn kho</label>
                        <input type="number" class="form-control" id="editEquipmentStock" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn giá</label>
                        <input type="number" class="form-control" id="editEquipmentPrice" min="0" step="1000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn vị</label>
                        <input type="text" class="form-control" id="editEquipmentUnit">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tồn kho tối thiểu</label>
                        <input type="number" class="form-control" id="editEquipmentMinStock" min="0" value="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nhà sản xuất</label>
                        <input type="text" class="form-control" id="editEquipmentManufacturer">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thời hạn bảo hành (tháng)</label>
                        <input type="number" class="form-control" id="editEquipmentWarranty" min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateEquipment()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>



</html>