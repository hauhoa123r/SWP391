<!-- Stock In Order Creation Fragment -->
<!--
  This fragment provides a reusable modal (#createStockInModal) and supporting
  JavaScript to create a Stock-In order from any page (medicine / medical-equipment).
  Include it with:  <div th:replace="templates_storage/fragments/createStockInModal :: createStockInModal"></div>
-->

<div th:fragment="createStockInModal">
    <!-- Notification container (if host page lacks one) -->
    <div id="stockin-notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1081;"></div>

    <!-- Create Stock-In Order Modal -->
    <div class="modal fade" id="createStockInModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tạo đơn nhập kho</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createStockInForm">
                        <input type="hidden" name="status" value="WAITING_FOR_DELIVERY">
                        <input type="hidden" name="transactionType" value="STOCK_IN">
                        <input type="hidden" name="totalAmount" id="si-totalAmount" value="0">

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nhà cung cấp <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="si-supplier" name="supplierName" required 
                                       placeholder="Tên nhà cung cấp" minlength="2" maxlength="100">
                                <div class="invalid-feedback">Vui lòng nhập tên nhà cung cấp (2-100 ký tự)</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày giao dự kiến <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="si-expectedDate" name="expectedDeliveryDate" required>
                                <div class="invalid-feedback">Vui lòng chọn ngày giao dự kiến</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Loại đơn hàng <span class="text-danger">*</span></label>
                                <select class="form-select" id="si-orderType" name="orderType" required>
                                    <option value="">Chọn loại đơn</option>
                                    <option value="MEDICINE">Thuốc</option>
                                    <option value="MEDICAL_PRODUCT">Thiết bị y tế</option>
                                </select>
                                <div class="invalid-feedback">Vui lòng chọn loại đơn hàng</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ghi chú</label>
                                <input type="text" class="form-control" id="si-notes" name="notes" maxlength="500" 
                                       placeholder="Ghi chú thêm (tối đa 500 ký tự)">
                                <div class="invalid-feedback">Ghi chú không được vượt quá 500 ký tự</div>
                            </div>
                        </div>

                        <div class="table-responsive mb-3">
                            <table class="table table-bordered" id="si-productTable">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="si-productBody"></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <button type="button" class="btn btn-sm btn-primary" id="si-addProductBtn">
                                                <i class="ri-add-line"></i> Thêm sản phẩm
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="text-end mb-2">
                            <strong>Tổng cộng: <span id="si-totalDisplay">0 VNĐ</span></strong>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success" id="si-submitBtn">Tạo đơn nhập</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VERY lightweight product picker (name + qty) -->
    <div class="modal fade" id="si-productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Sản phẩm <span class="text-danger">*</span></label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="si-prodName" placeholder="Tìm kiếm sản phẩm..." autocomplete="off">
                            <input type="hidden" id="si-prodId" value="">
                            <div id="si-productDropdown" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;">
                                <!-- Product options will be populated here -->
                            </div>
                        </div>
                        <small class="text-muted">Gõ để tìm kiếm hoặc chọn từ danh sách</small>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Số lượng</label>
                            <input type="number" class="form-control" id="si-prodQty" min="1" value="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Đơn giá</label>
                            <input type="number" class="form-control" id="si-prodPrice" min="0" step="100" value="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="si-addProdConfirm">Thêm</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    // ========== Helpers ==========
    const siCurrency = v => new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(v||0);
    const siNotify = (msg,type='success')=>{
        const c=document.getElementById('stockin-notification-container');
        if(!c) return; const div=document.createElement('div');
        div.className=`alert alert-${type} alert-dismissible fade show`; div.innerHTML=`${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        c.appendChild(div); setTimeout(()=>{div.classList.remove('show'); setTimeout(()=>c.removeChild(div),300)},4000);
    };

    // ========== Product Table management ==========
    const siProducts=[];
    function siRecalc(){
        let total=0; siProducts.forEach(p=>{total+=p.qty*p.price});
        document.getElementById('si-totalDisplay').textContent=siCurrency(total);
        document.getElementById('si-totalAmount').value=total;
    }

    function siRenderTable(){
        const body=document.getElementById('si-productBody'); body.innerHTML='';
        siProducts.forEach((p,idx)=>{
          const row=document.createElement('tr');
          row.innerHTML=`<td>${p.name}</td><td><input type='number' class='form-control form-control-sm' min='1' value='${p.qty}' onchange='siUpdateQty(${idx},this.value)'/></td><td><input type='number' class='form-control form-control-sm' min='0' step='100' value='${p.price}' onchange='siUpdatePrice(${idx},this.value)'/></td><td>${siCurrency(p.qty*p.price)}</td><td><button class='btn btn-sm btn-link text-danger' onclick='siRemoveProd(${idx})'><i class="ri-delete-bin-line"></i></button></td>`;
          body.appendChild(row);
        });
        siRecalc();
    }
    function siUpdateQty(i,v){siProducts[i].qty=parseInt(v||1); siRenderTable();}
    function siUpdatePrice(i,v){siProducts[i].price=parseFloat(v||0); siRenderTable();}
    function siRemoveProd(i){siProducts.splice(i,1); siRenderTable();}

    function siAddProduct(p){siProducts.push(p); siRenderTable();}

    // ========== Basic product modal ==========
    document.addEventListener('DOMContentLoaded',()=>{
        console.log('CreateStockInModal: DOMContentLoaded started');
        
        const addProductBtn = document.getElementById('si-addProductBtn');
        const addProdConfirm = document.getElementById('si-addProdConfirm');
        const productModal = document.getElementById('si-productModal');
        
        if (!addProductBtn) {
            console.error('CreateStockInModal: si-addProductBtn not found');
            return;
        }
        if (!addProdConfirm) {
            console.error('CreateStockInModal: si-addProdConfirm not found');
            return;
        }
        if (!productModal) {
            console.error('CreateStockInModal: si-productModal not found');
            return;
        }
        
        console.log('CreateStockInModal: All elements found, adding event listeners');
        
        // Product search functionality
        function initProductSearch() {
            const nameInput = document.getElementById('si-prodName');
            const prodIdInput = document.getElementById('si-prodId');
            const dropdown = document.getElementById('si-productDropdown');
            const priceInput = document.getElementById('si-prodPrice');
            
            if (!nameInput || !dropdown) return;
            
            // Get products from current page context
            let availableProducts = [];
            
            // Try to get products from window object (set by the main pages)
            if (window.medicines && Array.isArray(window.medicines)) {
                availableProducts = window.medicines.map(m => ({
                    id: m.id,
                    name: m.name,
                    price: m.price || 0,
                    stock: m.stockQuantities || 0,
                    type: 'MEDICINE'
                }));
            } else if (window.equipments && Array.isArray(window.equipments)) {
                availableProducts = window.equipments.map(e => ({
                    id: e.id,
                    name: e.name,
                    price: e.price || 0,
                    stock: e.stockQuantities || 0,
                    type: 'MEDICAL_PRODUCT'
                }));
            }
            
            console.log('Available products for search:', availableProducts.length);
            
            nameInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                prodIdInput.value = ''; // Clear selected product ID
                
                if (query.length < 1) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const filtered = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query)
                ).slice(0, 10); // Limit to 10 results
                
                dropdown.innerHTML = '';
                
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item-text text-muted">Không tìm thấy sản phẩm nào phù hợp</div>';
                } else {
                    filtered.forEach(product => {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'dropdown-item';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <span>${product.name}</span>
                                <small class="text-muted">Tồn: ${product.stock}</small>
                            </div>
                        `;
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            nameInput.value = product.name;
                            prodIdInput.value = product.id;
                            priceInput.value = product.price;
                            dropdown.classList.remove('show');
                            console.log('CreateStockInModal: Selected product:', product);
                            // Đảm bảo giá trị được lưu trữ ngay lập tức
                            nameInput.setAttribute('data-selected-name', product.name);
                            prodIdInput.setAttribute('data-selected-id', product.id);
                            priceInput.setAttribute('data-selected-price', product.price);
                        });
                        dropdown.appendChild(item);
                    });
                }
                dropdown.classList.add('show');
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!nameInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        // Initialize product search when modal is shown
        document.getElementById('si-productModal').addEventListener('shown.bs.modal', function() {
            initProductSearch();
            document.getElementById('si-prodName').focus();
        });
        
        addProductBtn.addEventListener('click', (e) => {
            console.log('CreateStockInModal: Add product button clicked');
            e.preventDefault();
            
            const nameInput = document.getElementById('si-prodName');
            const prodIdInput = document.getElementById('si-prodId');
            const qtyInput = document.getElementById('si-prodQty');
            const priceInput = document.getElementById('si-prodPrice');
            const dropdown = document.getElementById('si-productDropdown');
            
            if (nameInput) nameInput.value = '';
            if (prodIdInput) prodIdInput.value = '';
            if (qtyInput) qtyInput.value = 1;
            if (priceInput) priceInput.value = 0;
            if (dropdown) dropdown.classList.remove('show');
            
            try {
                const modal = new bootstrap.Modal(productModal);
                modal.show();
                console.log('CreateStockInModal: Product modal opened');
            } catch (error) {
                console.error('CreateStockInModal: Error opening modal:', error);
                siNotify('Lỗi mở modal thêm sản phẩm', 'danger');
            }
        });
        
        addProdConfirm.addEventListener('click', (e) => {
            e.preventDefault();
            
            const nameInput = document.getElementById('si-prodName');
            const prodIdInput = document.getElementById('si-prodId');
            const qtyInput = document.getElementById('si-prodQty');
            const priceInput = document.getElementById('si-prodPrice');
            
            if (!nameInput || !qtyInput || !priceInput) {
                console.error('CreateStockInModal: Input elements not found');
                siNotify('Lỗi: Không tìm thấy các trường nhập liệu', 'danger');
                return;
            }
            
            const name = nameInput.value.trim();
            const productId = prodIdInput ? prodIdInput.value.trim() : '';
            const qty = parseInt(qtyInput.value) || 1;
            const price = parseFloat(priceInput.value) || 0;
            
            console.log('CreateStockInModal: Product data:', {name, productId, qty, price});
            
            if (!name) {
                siNotify('Vui lòng chọn sản phẩm', 'warning');
                nameInput.focus();
                return;
            }
            
            // Prefer productId for validation, but allow manual entry
            if (!productId && name.length < 2) {
                siNotify('Tên sản phẩm phải có ít nhất 2 ký tự', 'warning');
                nameInput.focus();
                return;
            }
            
            // Kiểm tra nếu giá trị hiện tại không khớp với giá trị đã chọn từ dropdown
            if (nameInput.getAttribute('data-selected-name') && nameInput.getAttribute('data-selected-name') !== name) {
                prodIdInput.value = '';
                console.log('CreateStockInModal: Product name changed after selection, clearing productId');
            }
            
            if (qty <= 0) {
                siNotify('Số lượng phải lớn hơn 0', 'warning');
                qtyInput.focus();
                return;
            }
            
            if (price < 0) {
                siNotify('Đơn giá không được âm', 'warning');
                priceInput.focus();
                return;
            }
            
            // Check for duplicate product (by productId if available, otherwise by name)
            const existingProduct = siProducts.find(p => {
                if (productId) {
                    return p.productId === productId;
                }
                return p.name.toLowerCase() === name.toLowerCase();
            });
            
            if (existingProduct) {
                siNotify('Sản phẩm này đã có trong danh sách', 'warning');
                nameInput.focus();
                return;
            }
            
            // Add product to list
            const productData = {
                name: name,
                qty: qty,
                price: price
            };
            
            // Only add productId if it's available (don't send empty string)
            if (productId) {
                productData.productId = productId;
            }
            
            console.log('CreateStockInModal: Adding product to list:', productData);
            siAddProduct(productData);
            siNotify('Đã thêm sản phẩm vào danh sách', 'success');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('si-productModal')).hide();
        });

        // default expected date = tomorrow
        const d=new Date(); d.setDate(d.getDate()+1); document.getElementById('si-expectedDate').value=d.toISOString().split('T')[0];

        // submit
        document.getElementById('si-submitBtn').addEventListener('click',()=>{
            if(siProducts.length===0){siNotify('Chưa có sản phẩm','warning');return;}
            const form=document.getElementById('createStockInForm');
            const fd=new FormData(form); fd.append('products',JSON.stringify(siProducts));
            fetch('/warehouse/stock-in',{method:'POST',body:fd}).then(r=>{
                if(r.ok){siNotify('Đã tạo đơn nhập thành công'); bootstrap.Modal.getInstance(document.getElementById('createStockInModal')).hide(); if(window.loadStockInOrders) setTimeout(loadStockInOrders,500);}else{r.text().then(t=>siNotify(t||'Lỗi tạo đơn','danger'));}
            }).catch(e=>siNotify(e.message,'danger'));
        });
    });
    </script>
</div>
