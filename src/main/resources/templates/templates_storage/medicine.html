<!DOCTYPE html>
<html lang="vi" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF tokens - fallback if not available -->
    <meta name="_csrf" th:content="${_csrf?.token ?: ''}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName ?: 'X-CSRF-TOKEN'}"/>
    <title>Kivicare - Quản lý thuốc</title>

    <!-- CSS Files -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/font-awesome.css}">
    <link rel="stylesheet" th:href="@{/templates_storage/assets/css/linearicon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/themify.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/feather-icon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/remixicon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/datatables.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/vendors/bootstrap.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/templates_storage/assets/css/style.css}">

    <!-- Custom CSS -->
    <style>
        .warehouse-logo {
            font-family: 'Public Sans', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #2e8b57; /* Màu xanh lá cây */
            text-align: center;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        .sortable-header {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        
        .sortable-header.active {
            background-color: #007bff;
            color: white;
        }
        
        .sortable-header.active i {
            color: white;
        }
        
        .medicine-item {
            transition: all 0.3s ease;
        }
        
        .medicine-item:hover {
            transform: translateY(-2px);
        }
        
        .stock-low {
            color: #dc3545;
            font-weight: bold;
        }
        
        .stock-normal {
            color: #28a745;
        }
        
        .expired-soon {
            color: #ffc107;
            font-weight: bold;
        }
        
        .expired {
            color: #dc3545;
            font-weight: bold;
        }
        
        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .btn-group-vertical .btn {
            border-radius: 0.375rem !important;
        }
        
        .medicine-card .btn-group {
            gap: 0.25rem;
        }
        
        /* Loading animation */
        .fa-spin {
            animation: fa-spin 2s infinite linear;
        }
        
        @keyframes fa-spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .medicine-card .btn-group .btn {
            border-radius: 0.375rem !important;
            padding: 0.25rem 0.5rem;
        }
        
        /* Adjust font sizes: decrease general medicine information by 5% and increase medicine name by 5% */
        .medicine-card .card-title {
            font-size: 1.05em !important;
        }
        
        .medicine-card .card-text {
            font-size: 0.95em !important;
        }
        
        .medicine-card .card-text small {
            font-size: 0.95em !important;
        }
        
        .medicine-card strong {
            font-size: 0.95em !important;
        }
    </style>

    <style>
        .medicine-card { border: 1px solid #e0e0e0; border-radius: 8px; transition: all 0.3s; }
        .medicine-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .stock-low { color: #ff6b6b; font-weight: bold; }
        .stock-normal { color: #51cf66; }
        .expired-soon { color: #ff922b; }
        .expired { color: #ff6b6b; }
        .workflow-tabs { margin-bottom: 20px; }
        .tab-content { min-height: 400px; }
        .order-item { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; padding: 15px; }
        .order-pending { border-left: 4px solid #ffc107; }
        .order-preparing { border-left: 4px solid #17a2b8; }
        .order-ready { border-left: 4px solid #28a745; }
        
        /* Tab content visibility control */
        .tab-pane:not(.show) {
            display: none !important;
        }
        
        .tab-pane.show {
            display: block !important;
        }
        
        /* Ensure smooth transitions */
        .tab-pane {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body>
<div class="tap-top"><span class="lnr lnr-chevron-up"></span></div>

<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <!-- Bắt đầu tiêu đề trang -->
    <div class="page-header">
        <div class="header-wrapper m-0">
            <div class="header-logo-wrapper p-0">
                <div class="logo-wrapper">
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img class="img-fluid main-logo" th:src="@{/templates_storage/assets/images/logo/1.png}" alt="logo">
                        <img class="img-fluid white-logo" th:src="@{/templates_storage/assets/images/logo/1-white.png}" alt="logo">
                    </a>
                </div>
                <div class="toggle-sidebar">
                    <i class="status_toggle middle sidebar-toggle" data-feather="align-center"></i>
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img th:src="@{/templates_storage/assets/images/logo/1.png}" class="img-fluid" alt="">
                    </a>
                </div>
            </div>

            <!-- Tiêu đề mới -->
            <h1 class="warehouse-logo text-center mb-0">Kho Quản Lý</h1>

            <div class="nav-right col-6 pull-right right-header p-0">
                <ul class="nav-menus">
                    <li>
                        <span class="header-search">
                            <i class="ri-search-line"></i>
                        </span>
                    </li>
                    <li class="onhover-dropdown">
                        <div class="notification-box">
                            <i class="ri-notification-line"></i>
                            <span class="badge rounded-pill badge-theme">4</span>
                        </div>
                        <ul class="notification-dropdown onhover-show-div">
                            <li>
                                <i class="ri-notification-line"></i>
                                <h6 class="f-18 mb-0">Thông báo</h6>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-primary"></i>Đang xử lý giao hàng <span
                                        class="pull-right">10 phút</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-success"></i>Hoàn thành đơn hàng <span
                                        class="pull-right">1 giờ</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-info"></i>Tạo vé hỗ trợ <span
                                        class="pull-right">3 giờ</span>
                                </p>
                            </li>
                            <li>
                                <p>
                                    <i class="fa fa-circle me-2 font-danger"></i>Hoàn thành giao hàng <span
                                        class="pull-right">6 giờ</span>
                                </p>
                            </li>
                            <li>
                                <a class="btn btn-primary" href="#">Xem tất cả thông báo</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <div class="mode">
                            <i class="ri-moon-line"></i>
                        </div>
                    </li>
                    <li class="profile-nav onhover-dropdown pe-0 me-0">
                        <div class="media profile-media">
                            <img class="user-profile rounded-circle" th:src="@{${currentUser?.avatar ?: '/templates_storage/assets/images/users/default.jpg'}}" alt="">
                            <div class="user-name-hide media-body">
                                <span th:text="${currentUser?.fullName ?: 'Người dùng'}">Người dùng</span>
                                <p class="mb-0 font-roboto"><span th:text="${currentUser?.roleName ?: 'Người dùng'}">Vai trò</span><i class="middle ri-arrow-down-s-line"></i></p>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Kết thúc tiêu đề trang -->


    <!-- Sidebar -->
    <div class="page-body-wrapper">
        <!-- Bắt đầu thanh bên -->
        <div class="sidebar-wrapper">
            <div id="sidebarEffect"></div>
            <div>
                <div class="logo-wrapper logo-wrapper-center">
                    <a th:href="@{/warehouse/dashboard/main}" data-bs-original-title="" title="">
                        <img class="img-fluid for-white" th:src="@{/templates_storage/assets/images/logo/full-white.png}" alt="logo">
                    </a>
                    <div class="back-btn">
                        <i class="fa fa-angle-left"></i>
                    </div>
                    <div class="toggle-sidebar">
                        <i class="ri-apps-line status_toggle middle sidebar-toggle"></i>
                    </div>
                </div>
                <div class="logo-icon-wrapper">
                    <a th:href="@{/warehouse/dashboard/main}">
                        <img class="img-fluid main-logo" th:src="@{/templates_storage/assets/images/logo/1.png}" alt="logo">
                        <img class="img-fluid white-logo" th:src="@{/templates_storage/assets/images/logo/1-white.png}" alt="logo">
                    </a>
                </div>
                <nav class="sidebar-main">
                    <div class="left-arrow" id="left-arrow">
                        <i data-feather="arrow-left"></i>
                    </div>

                    <div id="sidebar-menu">
                        <ul class="sidebar-links" id="simple-bar">
                            <li class="back-btn"></li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/warehouse/dashboard/main}">
                                    <i class="ri-home-line"></i>
                                    <span>Bảng điều khiển</span>
                                </a>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-store-3-line"></i>
                                    <span>Giao dịch</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/stock-in}">Nhập kho</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/stock-out}">Xuất kho</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-list-check-2"></i>
                                    <span>Hóa đơn</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/invoices/in}">Hóa đơn nhập kho</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/invoices/out}">Hóa đơn xuất kho</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-list-settings-line"></i>
                                    <span>Kho hàng</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/warehouse/medical-equipment}">Thiết bị y tế</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/warehouse/medicines}">Thuốc</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="linear-icon-link sidebar-link sidebar-title" href="#">
                                    <i class="ri-price-tag-3-line"></i>
                                    <span>Mã giảm giá</span>
                                </a>
                                <ul class="sidebar-submenu">
                                    <li>
                                        <a th:href="@{/coupon-list}">Danh sách mã giảm giá</a>
                                    </li>
                                    <li>
                                        <a th:href="@{/create-coupon}">Tạo mã giảm giá</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/product-review}">
                                    <i class="ri-star-line"></i>
                                    <span>Đánh giá sản phẩm</span>
                                </a>
                            </li>
                            <li class="sidebar-list">
                                <a class="sidebar-link sidebar-title link-nav" th:href="@{/reports}">
                                    <i class="ri-file-chart-line"></i>
                                    <span>Báo cáo</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="right-arrow" id="right-arrow">
                        <i data-feather="arrow-right"></i>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Kết thúc thanh bên -->

        <!-- Main Content -->
        <div class="page-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Quản lý thuốc</h5>
                                <div class="btn-group">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">
                                        <i class="ri-add-line"></i> Thêm thuốc
                                    </button>
                                </div>
                            </div>

                            <!-- Workflow Tabs -->
                            <div class="workflow-tabs">
                                <ul class="nav nav-tabs" id="workflowTabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="medicines-tab" data-bs-toggle="tab" href="#medicines" role="tab">
                                            <i class="ri-medicine-bottle-line"></i> Thuốc <span class="badge bg-primary" id="medicineCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="expiry-tab" data-bs-toggle="tab" href="#expiry" role="tab">
                                            <i class="ri-time-line"></i> Thuốc có vấn đề <span class="badge bg-danger" id="expiryCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="stock-in-tab" data-bs-toggle="tab" href="#stock-in" role="tab">
                                            <i class="ri-download-line"></i> Đơn nhập <span class="badge bg-success" id="stockInCount">0</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="stock-out-tab" data-bs-toggle="tab" href="#stock-out" role="tab">
                                            <i class="ri-upload-line"></i> Đơn xuất <span class="badge bg-warning" id="stockOutCount">0</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <div class="tab-content">
                                <!-- Medicines Tab -->
                                <div class="tab-pane fade show active" id="medicines" role="tabpanel">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-2">
                                                <input type="text" class="form-control" id="searchMedicines" placeholder="Tìm kiếm thuốc...">
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="categoryFilter">
                                                    <option value="">Tất cả danh mục</option>
                                                    <option value="antibiotic">Kháng sinh</option>
                                                    <option value="painkiller">Giảm đau</option>
                                                    <option value="vitamin">Vitamin</option>
                                                    <option value="heart">Tim mạch</option>
                                                    <option value="digestive">Tiêu hóa</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="stockFilter">
                                                    <option value="">Tất cả</option>
                                                    <option value="low">Sắp hết hàng</option>
                                                    <option value="normal">Còn hàng</option>
                                                    <option value="out">Hết hàng</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="btn-group">
                                                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                                        <i class="ri-filter-off-line"></i> Xóa lọc
                                                    </button>
                                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createInboundOrderModal">
                                                    <i class="ri-add-circle-line"></i> Tạo đơn nhập
                                                </button>
                                                </div>
                                            </div>
                                            </div>
                                        </div>

                                        <!-- Sorting controls -->
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="name">
                                                        <i class="ri-sort-asc"></i> Tên thuốc
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="id">
                                                        <i class="ri-sort-asc"></i> Mã thuốc
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="category">
                                                        <i class="ri-sort-asc"></i> Danh mục
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="stock">
                                                        <i class="ri-sort-asc"></i> Tồn kho
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary sortable-header" data-sort="price">
                                                        <i class="ri-sort-asc"></i> Giá
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row" id="medicinesGrid">
                                            <!-- Display medicines from database -->
                                            <div th:each="medicine : ${medicines}" class="col-md-4 col-sm-6 mb-4">
                                                <div class="card medicine-card h-100">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <h6 class="card-title" th:text="${medicine.name}">Paracetamol 500mg</h6>
                                                            <span th:class="${medicine.stockQuantities != null and medicine.stockQuantities <= 10 ? 'stock-low' : 'stock-normal'}"
                                                                  th:text="${medicine.stockQuantities != null ? medicine.stockQuantities + ' ' + (medicine.unit != null ? medicine.unit : 'viên') : '0 viên'}">100 Viên</span>
                                                        </div>
                                                        <p class="card-text small" th:text="${medicine.description != null ? medicine.description : 'Không có mô tả'}">Thuốc giảm đau hạ sốt</p>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold" th:text="${medicine.price != null ? #numbers.formatDecimal(medicine.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : '0 VNĐ'}">15,000 VNĐ</span>
                                                            <div class="btn-group">
                                                                <button class="btn btn-sm btn-outline-info" onclick="viewMedicineDetails(this)" th:data-id="${medicine.id}">
                                                                    <i class="ri-eye-line"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="editMedicine(this)" th:data-id="${medicine.id}">
                                                                    <i class="ri-edit-line"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Show message if no medicines -->
                                            <div th:if="${#lists.isEmpty(medicines)}" class="col-12 text-center py-5">
                                                <i class="ri-medicine-bottle-line fs-1 text-muted"></i>
                                                <p class="mt-3">Không có thuốc nào trong kho. Hãy thêm thuốc mới.</p>
                                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">
                                                    <i class="ri-add-line"></i> Thêm thuốc
                                                </button>
                                            </div>
                                        </div>

                                        <!-- ✅ Phân trang -->
                                        <div class="d-flex justify-content-center mt-4" th:if="${totalPages > 1}">
                                            <nav>
                                                <ul class="pagination">

                                                    <!-- « Previous -->
                                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                                        <a class="page-link" th:href="@{/warehouse/medicines(page=${currentPage - 1})}">«</a>
                                                    </li>

                                                    <!-- First + ... -->
                                                    <li class="page-item" th:if="${startPage > 0}">
                                                        <a class="page-link" th:href="@{/warehouse/medicines(page=0)}">1</a>
                                                    </li>
                                                    <li class="page-item disabled" th:if="${startPage > 1}">
                                                        <a class="page-link">...</a>
                                                    </li>

                                                    <!-- Middle -->
                                                    <li class="page-item"
                                                        th:each="i : ${#numbers.sequence(startPage, endPage)}"
                                                        th:classappend="${i == currentPage} ? 'active'">
                                                        <a class="page-link" th:href="@{/warehouse/medicines(page=${i})}" th:text="${i + 1}">1</a>
                                                    </li>

                                                    <!-- ... + Last -->
                                                    <li class="page-item disabled" th:if="${endPage < totalPages - 2}">
                                                        <a class="page-link">...</a>
                                                    </li>
                                                    <li class="page-item" th:if="${endPage < totalPages - 1}">
                                                        <a class="page-link" th:href="@{/warehouse/medicines(page=${totalPages - 1})}" th:text="${totalPages}"></a>
                                                    </li>

                                                    <!-- » Next -->
                                                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                                        <a class="page-link" th:href="@{/warehouse/medicines(page=${currentPage + 1})}">»</a>
                                                    </li>

                                                </ul>
                                            </nav>
                                        </div>

                                    </div>
                                <!-- Expiry Tab -->
                                <div class="tab-pane fade" id="expiry" role="tabpanel">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6>Thuốc có vấn đề (hết hạn hoặc tồn kho ≤ 50)</h6>
                                            <button class="btn btn-success" onclick="createStockInForProblemMedicines()">
                                                <i class="ri-add-circle-line"></i> Tạo đơn nhập cho danh sách
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                <tr>
                                                    <th>Tên thuốc</th>
                                                    <th>Trạng thái</th>
                                                    <th>Thao tác</th>
                                                </tr>
                                                </thead>
                                                <tbody id="expiryTableBody">
                                                <!-- Expiry data will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock In Tab -->
                                <div class="tab-pane fade" id="stock-in" role="tabpanel">
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3">
                                            <h6><i class="ri-information-line"></i> Hướng dẫn xử lý đơn nhập kho</h6>
                                            <ul class="mb-0">
                                                <li><strong>Xử lý:</strong> Chuyển đơn từ trạng thái NEED_TO_ADD → COMPLETED (sẽ chuyển sang trang StockInInvoice)</li>
                                                <li><strong>Từ chối:</strong> Chuyển đơn từ trạng thái NEED_TO_ADD → REJECTED (sẽ không hiển thị nữa)</li>
                                                <li>Chỉ hiển thị các đơn có trạng thái: NEED_TO_ADD, WAITING_FOR_DELIVERY, RECEIVED</li>
                                            </ul>
                                        </div>
                                        <h6>Đơn nhập từ StockIn cần xử lý</h6>
                                        <div id="stockInOrders">
                                            <!-- Stock in orders will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock Out Tab -->
                                <div class="tab-pane fade" id="stock-out" role="tabpanel">
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3">
                                            <h6><i class="ri-information-line"></i> Hướng dẫn xử lý đơn xuất kho</h6>
                                            <ul class="mb-0">
                                                <li><strong>Chuẩn bị:</strong> Chuyển đơn từ trạng thái PREPARING → PREPARE_DELIVERY (sẽ chuyển sang trang StockOut)</li>
                                                <li><strong>Từ chối:</strong> Chuyển đơn từ trạng thái PREPARING → REJECTED (sẽ không hiển thị nữa)</li>
                                                <li>Chỉ hiển thị các đơn có trạng thái: PREPARING, PREPARE_DELIVERY, DELIVERING</li>
                                            </ul>
                                        </div>
                                        <h6>Đơn xuất từ StockOut cần chuẩn bị</h6>
                                        <div id="stockOutOrdersContainer">
                                            <!-- Stock out orders will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Medicine Modal -->
<div class="modal fade" id="addMedicineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Thêm thuốc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMedicineForm">
                    <div class="mb-3">
                        <label class="form-label">Tên thuốc</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã thuốc</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" required>
                            <option value="">Chọn danh mục</option>
                            <option value="antibiotic">Kháng sinh</option>
                            <option value="painkiller">Giảm đau</option>
                            <option value="vitamin">Vitamin</option>
                            <option value="heart">Tim mạch</option>
                            <option value="digestive">Tiêu hóa</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn vị tính</label>
                        <select class="form-select" name="unit" required>
                            <option value="">Chọn đơn vị</option>
                            <option value="viên">Viên</option>
                            <option value="vỉ">Vỉ</option>
                            <option value="hộp">Hộp</option>
                            <option value="chai">Chai</option>
                            <option value="tuýp">Tuýp</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tồn kho</label>
                        <input type="number" class="form-control" name="stock" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đơn giá</label>
                        <input type="number" class="form-control" name="price" min="0" step="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số lượng tối thiểu</label>
                        <input type="number" class="form-control" name="minStock" min="0" value="50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hướng dẫn sử dụng</label>
                        <textarea class="form-control" name="instructions" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveMedicine()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Process Stock In Modal -->
<div class="modal fade" id="processStockInModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xử lý nhập kho thuốc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="processStockInContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="confirmStockIn()">Xác nhận nhập kho</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Stock Out Modal -->
<div class="modal fade" id="createStockOutModal" tabindex="-1" aria-labelledby="createStockOutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStockOutModalLabel">Tạo đơn xuất kho thuốc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createStockOutForm" method="post" th:action="@{/warehouse/stock-out}">
                <div class="modal-body">
                    <input type="hidden" name="status" value="PREPARE_DELIVERY">
                    <input type="hidden" name="transactionType" value="STOCK_OUT">
                    <input type="hidden" id="inventoryManagerId" name="inventoryManagerId" th:value="${currentUser?.id ?: 256}">
                    <input type="hidden" name="totalAmount" id="totalAmountInput" value="0">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="supplierSearch" class="form-label">Nhà cung cấp <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="supplierSearch" placeholder="Tìm kiếm nhà cung cấp...">
                                <input type="hidden" id="supplierId" name="supplierId" required>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#supplierModal">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                            <div id="supplierSearchResults" class="dropdown-menu w-100"></div>
                            <div class="form-text" id="selectedSupplierInfo"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="expectedDeliveryDate" class="form-label">Ngày giao hàng dự kiến <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="expectedDeliveryDate" name="expectedDeliveryDate" required>
                            <script>
                                // Set default date to tomorrow
                                const tomorrow = new Date();
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                document.getElementById('expectedDeliveryDate').value = tomorrow.toISOString().split('T')[0];
                            </script>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="recipient" class="form-label">Người nhận <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="recipient" name="recipient" required placeholder="Nhập tên người nhận">
                        </div>
                        <div class="col-md-4">
                            <label for="recipientContact" class="form-label">Liên hệ người nhận</label>
                            <input type="text" class="form-control" id="recipientContact" name="recipientContact" placeholder="Số điện thoại liên hệ">
                        </div>
                        <div class="col-md-4">
                            <label for="orderType" class="form-label">Loại đơn hàng <span class="text-danger">*</span></label>
                            <select class="form-select" id="orderType" name="orderType" required>
                                <option value="">Chọn loại đơn hàng</option>
                                <option value="MEDICINE" selected>Thuốc</option>
                                <option value="MEDICAL_PRODUCT">Thiết bị y tế</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reason" class="form-label">Lý do xuất <span class="text-danger">*</span></label>
                            <select class="form-select" id="reason" name="reason" required>
                                <option value="">Chọn lý do xuất</option>
                                <option value="SALE">Bán hàng</option>
                                <option value="TRANSFER">Chuyển kho</option>
                                <option value="RETURN">Trả hàng</option>
                                <option value="EXPIRED">Hết hạn</option>
                                <option value="DAMAGED">Hư hỏng</option>
                                <option value="OTHER">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentMethod" class="form-label">Phương thức thanh toán</label>
                            <select class="form-select" id="paymentMethod" name="paymentMethod">
                                <option value="CASH" selected>Tiền mặt</option>
                                <option value="BANK_TRANSFER">Chuyển khoản</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="taxAmount" class="form-label">Thuế (%)</label>
                            <select class="form-select" id="taxAmount" name="taxAmount">
                                <option value="0">0%</option>
                                <option value="8">8%</option>
                                <option value="10" selected>10%</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="shippingCost" class="form-label">Chi phí vận chuyển</label>
                            <input type="number" class="form-control" id="shippingCost" name="shippingCost" min="0" value="0">
                        </div>
                        <div class="col-md-4">
                            <label for="notes" class="form-label">Ghi chú</label>
                            <input type="text" class="form-control" id="notes" name="notes" placeholder="Ghi chú thêm">
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="items-section mb-3">
                        <h6>Danh sách thuốc</h6>
                        <table class="table table-bordered" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>Tên thuốc</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá (VNĐ)</th>
                                    <th>Thành tiền (VNĐ)</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="itemsList">
                                <tr id="noItemsMessage">
                                    <td colspan="5" class="text-center">Không có thuốc nào. Vui lòng thêm thuốc vào danh sách.</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                    <i class="ri-add-line"></i> Thêm thuốc
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <h6>Tổng tiền: <span id="totalAmount">0</span> VNĐ</h6>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Lưu phiếu xuất</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Thêm thuốc vào đơn xuất</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="mb-3">
                        <label for="productSearch" class="form-label">Tìm kiếm thuốc</label>
                        <input type="text" class="form-control" id="productSearch" placeholder="Nhập tên thuốc...">
                        <div id="productSearchResults" class="dropdown-menu w-100 mt-2"></div>
                        <input type="hidden" id="selectedProductId">
                    </div>
                    <div class="mb-3" id="productDetails" style="display: none;">
                        <h6>Thông tin thuốc</h6>
                        <p><strong>Tên:</strong> <span id="productName"></span></p>
                        <p><strong>Tồn kho:</strong> <span id="productStock"></span></p>
                        <p><strong>Đơn giá:</strong> <span id="productPrice"></span> VNĐ</p>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Số lượng</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="addItemToList()">Thêm vào danh sách</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Inbound Order Modal -->
<div class="modal fade" id="createInboundOrderModal" tabindex="-1" aria-labelledby="createInboundOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInboundOrderModalLabel">Tạo đơn nhập kho thuốc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createStockInForm" method="post" th:action="@{/warehouse/stock-in}">
                <div class="modal-body">
                    <input type="hidden" name="status" value="WAITING_FOR_DELIVERY">
                    <input type="hidden" name="transactionType" value="STOCK_IN">
                    <input type="hidden" id="inventoryManagerId" name="inventoryManagerId" th:value="${currentUser?.id ?: 256}">
                    <input type="hidden" name="totalAmount" id="totalAmountInputIn" value="0">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="supplierSearchIn" class="form-label">Nhà cung cấp <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="supplierSearchIn" placeholder="Tìm kiếm nhà cung cấp...">
                                <input type="hidden" id="supplierIdIn" name="supplierId" required>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#supplierModalIn">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                            <div id="supplierSearchResultsIn" class="dropdown-menu w-100"></div>
                            <div class="form-text" id="selectedSupplierInfoIn"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="expectedDeliveryDateIn" class="form-label">Ngày giao hàng dự kiến <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="expectedDeliveryDateIn" name="expectedDeliveryDate" required>
                            <script>
                                // Set default date to tomorrow for inbound order
                                const tomorrowIn = new Date();
                                tomorrowIn.setDate(tomorrowIn.getDate() + 1);
                                document.getElementById('expectedDeliveryDateIn').value = tomorrowIn.toISOString().split('T')[0];
                            </script>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="invoiceNumberIn" class="form-label">Số hóa đơn <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="invoiceNumberIn" name="invoiceNumber" placeholder="Nhập số hóa đơn" required>
                        </div>
                        <div class="col-md-4">
                            <label for="transactionDateIn" class="form-label">Ngày giao dịch <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="transactionDateIn" name="transactionDate" required>
                            <script>
                                // Set default transaction date to today for inbound order
                                document.getElementById('transactionDateIn').value = new Date().toISOString().split('T')[0];
                            </script>
                        </div>
                        <div class="col-md-4">
                            <label for="orderTypeIn" class="form-label">Loại đơn hàng <span class="text-danger">*</span></label>
                            <select class="form-select" id="orderTypeIn" name="orderType" required>
                                <option value="">Chọn loại đơn hàng</option>
                                <option value="MEDICINE" selected>Thuốc</option>
                                <option value="MEDICAL_PRODUCT">Thiết bị y tế</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reasonIn" class="form-label">Lý do nhập <span class="text-danger">*</span></label>
                            <select class="form-select" id="reasonIn" name="reason" required>
                                <option value="">Chọn lý do nhập</option>
                                <option value="PURCHASE">Mua hàng</option>
                                <option value="TRANSFER">Chuyển kho</option>
                                <option value="RETURN">Trả hàng</option>
                                <option value="OTHER">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentMethodIn" class="form-label">Phương thức thanh toán</label>
                            <select class="form-select" id="paymentMethodIn" name="paymentMethod">
                                <option value="CASH" selected>Tiền mặt</option>
                                <option value="BANK_TRANSFER">Chuyển khoản</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="taxAmountIn" class="form-label">Thuế (%)</label>
                            <select class="form-select" id="taxAmountIn" name="taxAmount">
                                <option value="0">0%</option>
                                <option value="8">8%</option>
                                <option value="10" selected>10%</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="shippingCostIn" class="form-label">Chi phí vận chuyển</label>
                            <input type="number" class="form-control" id="shippingCostIn" name="shippingCost" min="0" value="0">
                        </div>
                        <div class="col-md-4">
                            <label for="discountAmountIn" class="form-label">Giảm giá (VNĐ)</label>
                            <input type="number" class="form-control" id="discountAmountIn" name="discountAmount" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="notesIn" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="notesIn" name="notes" rows="2" placeholder="Nhập ghi chú về đơn hàng"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="items-section mb-3">
                        <h6>Danh sách thuốc nhập kho</h6>
                        <table class="table table-bordered" id="itemsTableIn">
                            <thead>
                                <tr>
                                    <th>Tên thuốc</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá (VNĐ)</th>
                                    <th>Thành tiền (VNĐ)</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="itemsListIn">
                                <tr id="noItemsMessageIn">
                                    <td colspan="5" class="text-center">Không có thuốc nào. Vui lòng thêm thuốc vào danh sách.</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addItemModalIn">
                                    <i class="ri-add-line"></i> Thêm thuốc
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <h6>Tổng tiền: <span id="totalAmountIn">0</span> VNĐ</h6>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Lưu phiếu nhập</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Item Modal for Inbound Order -->
<div class="modal fade" id="addItemModalIn" tabindex="-1" aria-labelledby="addItemModalLabelIn" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabelIn">Thêm thuốc vào đơn nhập</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemFormIn">
                    <div class="mb-3">
                        <label for="productSearchIn" class="form-label">Tìm kiếm thuốc</label>
                        <input type="text" class="form-control" id="productSearchIn" placeholder="Nhập tên thuốc...">
                        <div id="productSearchResultsIn" class="dropdown-menu w-100 mt-2"></div>
                        <input type="hidden" id="selectedProductIdIn">
                    </div>
                    <div class="mb-3" id="productDetailsIn" style="display: none;">
                        <h6>Thông tin thuốc</h6>
                        <p><strong>Tên:</strong> <span id="productNameIn"></span></p>
                        <p><strong>Tồn kho:</strong> <span id="productStockIn"></span></p>
                        <p><strong>Đơn giá:</strong> <span id="productPriceIn"></span> VNĐ</p>
                    </div>
                    <div class="mb-3">
                        <label for="quantityIn" class="form-label">Số lượng</label>
                        <input type="number" class="form-control" id="quantityIn" min="1" value="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="addItemToListIn()">Thêm vào danh sách</button>
            </div>
        </div>
    </div>
</div>

<!-- Supplier Search Modal for Inbound Order -->
<div class="modal fade" id="supplierModalIn" tabindex="-1" aria-labelledby="supplierModalInLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="supplierModalInLabel">Chọn nhà cung cấp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="supplierModalSearchIn" placeholder="Tìm kiếm nhà cung cấp...">
                </div>
                <div id="supplierLoadingIn" class="text-center" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
                <div id="supplierModalResultsIn" class="list-group">
                    <div class="list-group-item text-center">Nhập từ khóa để tìm kiếm nhà cung cấp</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Files -->
<script th:src="@{/templates_storage/assets/js/jquery-3.6.0.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/bootstrap/bootstrap.bundle.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/icons/feather-icon/feather.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/icons/feather-icon/feather-icon.js}"></script>
<script th:src="@{/templates_storage/assets/js/scrollbar/simplebar.js}"></script>
<script th:src="@{/templates_storage/assets/js/scrollbar/custom.js}"></script>
<script th:src="@{/templates_storage/assets/js/config.js}"></script>
<script th:src="@{/templates_storage/assets/js/sidebar-menu.js}"></script>
<script th:src="@{/templates_storage/assets/js/notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/templates_storage/assets/js/notify/index.js}"></script>
<script th:src="@{/templates_storage/assets/js/script.js}"></script>

<script th:inline="javascript">
    // Load medicine data from controller
    let medicines = [];
    
    /*<![CDATA[*/
    // Get data from Thymeleaf
    medicines = /*[[${medicines}]]*/ [];
    /*]]>*/

    // Load stock in/out orders from controller
    let stockInOrders = [];
    let stockOutOrders = [];
    
    /*<![CDATA[*/
    stockInOrders = /*[[${stockInOrders}]]*/ [];
    stockOutOrders = /*[[${stockOutOrders}]]*/ [];
    /*]]>*/
    
    // Initialize order data from server
    function initializeOrderData() {
        try {
            var stockInData = '[[${stockInOrders}]]';
            var stockOutData = '[[${stockOutOrders}]]';
            console.log('Raw Stock In Data:', stockInData);
            console.log('Raw Stock Out Data:', stockOutData);
            stockInOrders = stockInData && stockInData !== '' && stockInData !== '[[${stockInOrders}]]' ? JSON.parse(stockInData) : [];
            stockOutOrders = stockOutData && stockOutData !== '' && stockOutData !== '[[${stockOutOrders}]]' ? JSON.parse(stockOutData) : [];
            console.log('Initialized Stock In Orders:', stockInOrders);
            console.log('Initialized Stock Out Orders:', stockOutOrders);
        } catch (e) {
            console.error('Error parsing order data:', e);
            stockInOrders = [];
            stockOutOrders = [];
        }
    }
    
    // Ensure data is properly loaded and handle null/undefined values
    if (!stockInOrders || stockInOrders.length === 0) {
        console.log('Stock In Orders is empty or null, checking Thymeleaf data...');
        stockInOrders = [];
    }
    
    if (!stockOutOrders || stockOutOrders.length === 0) {
        console.log('Stock Out Orders is empty or null, checking Thymeleaf data...');
        stockOutOrders = [];
    }
    
    // Hàm định dạng ngày - chỉ hiển thị ngày
    function formatDateOnly(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return date.toLocaleDateString('vi-VN', options);
        } catch (error) {
            console.error('Error formatting date:', error);
            return dateString;
        }
    }
    
    // Hàm định dạng tiền tệ
    function formatCurrency(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            return '0 VNĐ';
        }
        return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }
    
    // Hàm lấy text trạng thái đơn hàng
    function getOrderStatusText(status) {
        switch(status) {
            case 'PENDING': return 'Đang chờ';
            case 'APPROVED': return 'Đã duyệt';
            case 'REJECTED': return 'Đã từ chối';
            case 'COMPLETED': return 'Hoàn thành';
            case 'NEED_TO_ADD': return 'Cần xử lý';
            case 'WAITING_FOR_DELIVERY': return 'Chờ giao hàng';
            case 'RECEIVED': return 'Đã nhận';
            case 'PREPARING': return 'Đang chuẩn bị';
            case 'PREPARE_DELIVERY': return 'Chuẩn bị giao hàng';
            case 'DELIVERING': return 'Đang giao hàng';
            default: return status || 'Không xác định';
        }
    }

    // Ensure arrays are properly initialized
    stockInOrders = Array.isArray(stockInOrders) ? stockInOrders : [];
    stockOutOrders = Array.isArray(stockOutOrders) ? stockOutOrders : [];
    
    // Debug: Log data for troubleshooting
    console.log('Final Stock In Orders data:', stockInOrders);
    console.log('Final Stock Out Orders data:', stockOutOrders);
    console.log('Stock In Orders type:', typeof stockInOrders);
    console.log('Stock Out Orders type:', typeof stockOutOrders);

    // Global variables for sorting and filtering
    let currentSortField = 'name';
    let currentSortDirection = 'asc';
    let filteredMedicines = [];
    
        // CSRF token setup
    const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
    console.log('CSRF Token:', CSRF_TOKEN ? 'Available' : 'Not available');
    console.log('CSRF Header:', CSRF_HEADER);

    // Initialize page
    $(document).ready(function() {
        // Initially hide all tab content except the first one
        $('.tab-pane').removeClass('show active');
        $('#medicines').addClass('show active');
        $('#medicines-tab').addClass('active');
        
        // Load all data initially with a small delay to ensure DOM is ready
        setTimeout(() => {
            console.log('Initializing data loading...');
            loadMedicines();
            loadExpiryData();
            loadStockInOrders();
            loadStockOutOrders();
            updateCounts();
            console.log('Data loading completed');
        }, 100);

        // Initialize filters
        $('#searchMedicines').on('input', filterMedicines);
        $('#categoryFilter').on('change', function() {
            filterMedicines();
        });
        $('#stockFilter').on('change', filterMedicines);

        // Add sorting event listeners
        $('.sortable-header').on('click', function() {
            const field = $(this).data('sort');
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // Update visual feedback
            $('.sortable-header').removeClass('active');
            $(this).addClass('active');
            
            // Update sort icons
            $('.sortable-header i').removeClass('ri-sort-asc ri-sort-desc').addClass('ri-sort-asc');
            const icon = currentSortDirection === 'asc' ? 'ri-sort-asc' : 'ri-sort-desc';
            $(this).find('i').removeClass('ri-sort-asc ri-sort-desc').addClass(icon);
            
            loadMedicines();
        });

        // Handle tab clicks with Bootstrap 5 compatibility
        $('#workflowTabs a').on('click', function(e) {
            e.preventDefault();
            const target = $(this).attr('href');
            
            // Remove active class from all tabs
            $('#workflowTabs a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all tab content
            $('.tab-pane').removeClass('show active');
            
            // Show only the clicked tab content
            $(target).addClass('show active');
            
            // Refresh data for the active tab to ensure it's up to date
            if (target === '#medicines') {
                loadMedicines();
            } else if (target === '#expiry') {
                loadExpiryData();
            } else if (target === '#stock-in') {
                loadStockInOrders();
            } else if (target === '#stock-out') {
                loadStockOutOrders();
            }
        });
    });

    // Update badge counts with improved logic
    function updateCounts() {
        // Count total medicines in database (not filtered)
        $('#medicineCount').text(medicines ? medicines.length : 0);
        
        // Count stock in orders with NEED_TO_ADD status to match loadStockInOrders filter
        const stockInCount = stockInOrders ? stockInOrders.filter(order => {
            if (!order || !order.status) return false;
            const statusMatch = order.status === 'NEED_TO_ADD';
            const typeMatch = !order.transaction_type || order.transaction_type === 'STOCK_IN';
            return statusMatch && typeMatch;
        }).length : 0;
        $('#stockInCount').text(stockInCount);
        
        // Count stock out orders with PREPARING status to match loadStockOutOrders filter
        const stockOutCount = stockOutOrders ? stockOutOrders.filter(order => {
            if (!order || !order.status) return false;
            const statusMatch = order.status === 'PREPARING';
            const typeMatch = !order.transaction_type || order.transaction_type === 'STOCK_OUT';
            return statusMatch && typeMatch;
        }).length : 0;
        $('#stockOutCount').text(stockOutCount);
        
        // Count problematic medicines (expired or low stock)
        let problemCount = 0;
        if (medicines) {
            medicines.forEach(medicine => {
                const stock = medicine.stockQuantities || 0;
                const minStock = medicine.minStock || 50;
                
                // Debug: Log each medicine check
                console.log(`Checking medicine: ${medicine.name}, stock: ${stock}, minStock: ${minStock}, condition: ${stock <= minStock}`);
                
                if (stock <= minStock) {
                    console.log(`Adding ${medicine.name} to problem medicines`);
                    problemCount++;
                }
            });
        }
        $('#expiryCount').text(problemCount);
    }

    // Improved filter medicines function
    function filterMedicines() {
        const search = $('#searchMedicines').val().toLowerCase();
        const category = $('#categoryFilter').val();
        const stock = $('#stockFilter').val();

        filteredMedicines = medicines.filter(medicine => {
            // Handle null/undefined values
            const medicineName = medicine.name || '';
            const medicineId = medicine.id || '';
            const medicineCategory = medicine.category || '';
            const medicineStock = medicine.stockQuantities || 0;
            const medicineMinStock = medicine.minStock || 50;

            // Search filter
            const matchesSearch = !search || 
                medicineName.toLowerCase().includes(search) ||
                medicineId.toString().toLowerCase().includes(search) ||
                getCategoryName(medicineCategory).toLowerCase().includes(search);

            // Category filter - improved to handle both category codes and names
            let matchesCategory = true;
            if (category) {
                const medicineCategoryName = getCategoryName(medicineCategory).toLowerCase();
                const selectedCategoryName = getCategoryName(category).toLowerCase();
                matchesCategory = medicineCategoryName === selectedCategoryName;
            }

            // Stock filter
            let matchesStock = true;
            if (stock === 'low') {
                matchesStock = medicineStock <= medicineMinStock;
            } else if (stock === 'normal') {
                matchesStock = medicineStock > medicineMinStock && medicineStock > 0;
            } else if (stock === 'out') {
                matchesStock = medicineStock === 0;
            }

            return matchesSearch && matchesCategory && matchesStock;
        });

        // Sort filtered medicines
        sortMedicines(filteredMedicines);
        
        // Display filtered medicines
        displayMedicines(filteredMedicines);
        
        // Update counts
        updateCounts();
    }

    // Sort medicines function
    function sortMedicines(medicineArray) {
        medicineArray.sort((a, b) => {
            let aValue, bValue;
            
            switch (currentSortField) {
                case 'name':
                    aValue = (a.name || '').toLowerCase();
                    bValue = (b.name || '').toLowerCase();
                    break;
                case 'id':
                    aValue = a.id || 0;
                    bValue = b.id || 0;
                    break;
                case 'category':
                    aValue = getCategoryName(a.category || '').toLowerCase();
                    bValue = getCategoryName(b.category || '').toLowerCase();
                    break;
                case 'stock':
                    aValue = a.stockQuantities || 0;
                    bValue = b.stockQuantities || 0;
                    break;
                case 'price':
                    aValue = a.price || 0;
                    bValue = b.price || 0;
                    break;
                default:
                    aValue = (a.name || '').toLowerCase();
                    bValue = (b.name || '').toLowerCase();
            }

            if (currentSortDirection === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });
    }

    // Display medicines function
    function displayMedicines(medicineArray) {
        console.log('Displaying medicines:', medicineArray);
        medicineArray.forEach(med => console.log('Medicine:', med.id, 'Category:', med.category));
        const grid = $('#medicinesGrid');
        grid.empty();

        if (!medicineArray || medicineArray.length === 0) {
            grid.html(`
                <div class="col-12 text-center py-5">
                    <i class="ri-filter-3-line fs-1 text-muted"></i>
                    <p class="mt-3">Không tìm thấy thuốc nào phù hợp với điều kiện lọc.</p>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="ri-filter-off-line"></i> Xóa bộ lọc
                    </button>
                </div>
            `);
            return;
        }

        medicineArray.forEach(medicine => {
            // Handle null/undefined values
            const medicineName = medicine.name || 'Không có tên';
            const medicineId = medicine.id || 'N/A';
            const medicineCategory = medicine.category || '';
            const medicineUnit = medicine.unit || 'viên';
            const medicineStock = medicine.stockQuantities || 0;
            const medicinePrice = medicine.price || 0;
            const medicineMinStock = medicine.minStock || 50;

            const stockStatus = getStockStatus(medicineStock, medicineMinStock);
            const stockClass = stockStatus.class;

            console.log('Medicine ID:', medicineId, 'Category:', medicineCategory);

            const card = `
                <div class="col-md-6 col-lg-4 mb-3 medicine-item" data-category="${medicineCategory}" data-stock="${stockStatus.status}">
                <div class="card medicine-card">
                <div class="card-body">
                <h6 class="card-title">${medicineName}</h6>
    <p class="card-text">
        <small class="text-muted">Mã: ${medicineId}</small><br>
        <small class="text-muted">Danh mục: ${getCategoryName(medicineCategory)}</small><br>
        <small class="text-muted">Đơn vị: ${medicineUnit}</small>
    </p>
    <div class="row">
        <div class="col-6">
            <strong class="${stockClass}">Tồn kho: ${medicineStock}</strong>
        </div>
        <div class="col-6 text-end">
            <strong>${formatCurrency(medicinePrice)}</strong>
        </div>
    </div>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info" onclick="viewMedicineDetails(${medicineId})" title="Xem chi tiết">
                                        <i class="ri-eye-line"></i>
        </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editMedicine(${medicineId})" title="Sửa thuốc">
            <i class="ri-edit-line"></i>
        </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMedicine(${medicineId})" title="Xóa thuốc">
            <i class="ri-delete-bin-line"></i>
        </button>
                                </div>
    </div>
    </div>
    </div>
    </div>
    `;
            grid.append(card);
        });
    }

    // Load medicines with improved functionality
    function loadMedicines() {
        filteredMedicines = medicines ? [...medicines] : [];
        filterMedicines();
    }

        // Load expiry data with improved counting
    function loadExpiryData() {
        const tbody = $('#expiryTableBody');
        tbody.empty();

        // Show loading indicator
        tbody.html('<tr><td colspan="3" class="text-center"><i class="ri-loader-4-line fa-spin"></i> Đang tải dữ liệu...</td></tr>');

        // Load data immediately
        tbody.empty();
        let expiringItems = [];

        if (medicines) {
            medicines.forEach(medicine => {
                // Check for low stock (≤ 50)
                const stockQuantities = medicine.stockQuantities || 0;
                if (stockQuantities <= 50) {
                    expiringItems.push({
                        medicineId: medicine.id || 'N/A',
                        medicineName: medicine.name || 'Không có tên',
                        status: 'Tồn kho thấp',
                        statusClass: 'bg-warning'
                    });
                }
            });
        }

        // Sort by expiry date (soonest first)
        expiringItems.sort((a, b) => {
            const aDate = a.status === 'Sắp hết hạn' ? 1 : 2;
            const bDate = b.status === 'Sắp hết hạn' ? 1 : 2;
            return aDate - bDate;
        });

        if (expiringItems.length === 0) {
            tbody.html('<tr><td colspan="3" class="text-center text-muted">Không có thuốc nào có vấn đề</td></tr>');
            return;
        }

        expiringItems.forEach(item => {
            const row = `
                <tr>
                    <td>${item.medicineName}</td>
                    <td><span class="${item.statusClass}">${item.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="createStockInForMedicine(${item.medicineId})" title="Tạo đơn nhập">
                            <i class="ri-add-circle-line"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="viewMedicineDetails(${item.medicineId})" title="Xem chi tiết">
                            <i class="ri-eye-line"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    // Load stock in orders with specific status filtering
    function loadStockInOrders() {
        console.log('Loading stock in orders...');
        const container = $('#stockInOrders');
        console.log('Container found:', container.length > 0);
        container.empty();

        // Show loading indicator
        container.html(`
            <div class="text-center py-5">
                <i class="ri-loader-4-line fa-spin fs-1 text-muted"></i>
                <p class="mt-3">Đang tải dữ liệu...</p>
            </div>
        `);

        // Load data immediately
        container.empty();

        // Debug: Check database data
        console.log('Raw stockInOrders from database:', stockInOrders);
        console.log('StockInOrders type:', typeof stockInOrders);
        console.log('StockInOrders length:', stockInOrders ? (Array.isArray(stockInOrders) ? stockInOrders.length : 'Not an array') : 'Undefined');
        
        // Debug: Log each order status
        if (Array.isArray(stockInOrders)) {
            stockInOrders.forEach((order, index) => {
                console.log(`Order ${index}: ID=${order.id}, Status=${order.status}, Type=${order.transaction_type}`);
            });
        }
        
        // Ensure stockInOrders is an array and filter orders
        const validOrders = Array.isArray(stockInOrders) ? stockInOrders : [];
        const filteredOrders = validOrders.filter(order => {
            if (!order || !order.status) return false;
            console.log('Checking order:', order);
            // Nới lỏng điều kiện để debug
            const statusMatch = order.status === 'NEED_TO_ADD';
            const typeMatch = !order.transaction_type || order.transaction_type === 'STOCK_IN';
            // Tạm thởi bỏ qua lọc sản phẩm để debug
            const productMatch = true; // !order.products || Array.isArray(order.products) && order.products.length === 0 || 
                // (order.products && Array.isArray(order.products) && order.products.some(p => p.type === 'MEDICINE'));
            console.log(`StockIn Order ${order.id}: status=${order.status}, statusMatch=${statusMatch}, typeMatch=${typeMatch}, productMatch=${productMatch}`);
            console.log(`StockIn Order ${order.id}: products=`, order.products);
            return statusMatch && typeMatch && productMatch;
        });
        
        console.log('Valid orders:', validOrders);
        console.log('Filtered orders:', filteredOrders);
        console.log('Filtered orders length:', filteredOrders.length);

        if (filteredOrders.length === 0) {
            container.html(`
                <div class="text-center py-5">
                    <i class="ri-inbox-line fs-1 text-muted"></i>
                    <p class="mt-3">Không có đơn nhập kho nào. Kiểm tra console để debug.</p>
                </div>
            `);
            return;
        }

        filteredOrders.forEach(order => {
            try {
                // Safely get order properties with fallbacks
                const orderId = order.id || order.invoiceNumber || 'N/A';
                const supplierName = order.supplierName || order.supplier || 'N/A';
                const transactionDate = order.transactionDate || order.createdDate || order.date || 'N/A';
                const totalAmount = order.totalAmount || 0;
                
                // Calculate total amount and product count from products array
                let calculatedTotal = 0;
                let calculatedProductCount = 0;
                if (order.products && Array.isArray(order.products) && order.products.length > 0) {
                    calculatedProductCount = order.products.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    calculatedTotal = order.products.reduce((sum, item) => {
                        return sum + ((item.quantity || 0) * (item.price || 0));
                    }, 0);
                }

                const orderDiv = `
                    <div class="order-item order-${order.status.toLowerCase()}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Đơn nhập: ${orderId}</h6>
                                <p><strong>Nhà cung cấp:</strong> ${supplierName}</p>
                                <p><strong>Ngày tạo:</strong> ${formatDateOnly(transactionDate)}</p>
                                <p><strong>Tổng tiền:</strong> ${formatCurrency(calculatedTotal)}</p>
                                <p><strong>Số lượng sản phẩm:</strong> ${calculatedProductCount}</p>
                            <p><strong>Trạng thái:</strong> <span class="badge bg-info">${getOrderStatusText(order.status)}</span></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical">
                                    <a class="btn btn-primary btn-sm mb-1" href="/warehouse/stock-in/${orderId}">
                                        <i class="ri-eye-line"></i> Xem chi tiết
                                    </a>
                                    <button class="btn btn-success btn-sm mb-1" onclick="processStockInOrder('${orderId}')">
                                        <i class="ri-check-line"></i> Xử lý
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectStockInOrder('${orderId}')">
                                        <i class="ri-close-line"></i> Từ chối
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(orderDiv);
            } catch (error) {
                console.error('Error processing stock in order:', error, order);
            }
        });
        console.log('Stock in orders loaded:', filteredOrders.length, 'orders');
    }

    // Load stock out orders with specific status filtering
    function loadStockOutOrders() {
        console.log('Loading stock out orders...');
        const container = $('#stockOutOrdersContainer');
        console.log('Container found:', container.length > 0);
        container.empty();

        // Show loading indicator
        container.html(`
            <div class="text-center py-5">
                <i class="ri-loader-4-line fa-spin fs-1 text-muted"></i>
                <p class="mt-3">Đang tải dữ liệu...</p>
            </div>
        `);

        // Load data immediately
        container.empty();

        // Debug: Check database data
        console.log('Raw stockOutOrders from database:', stockOutOrders);
        console.log('StockOutOrders type:', typeof stockOutOrders);
        console.log('StockOutOrders length:', stockOutOrders ? (Array.isArray(stockOutOrders) ? stockOutOrders.length : 'Not an array') : 'Undefined');
        
        // Debug: Log each order status
        if (Array.isArray(stockOutOrders)) {
            stockOutOrders.forEach((order, index) => {
                console.log(`Order ${index}: ID=${order.id}, Status=${order.status}, Type=${order.transaction_type}`);
            });
        }
        
        // Ensure stockOutOrders is an array and filter orders
        const validOrders = Array.isArray(stockOutOrders) ? stockOutOrders : [];
        const filteredOrders = validOrders.filter(order => {
            if (!order || !order.status) return false;
            console.log('Checking order:', order);
            // Nới lỏng điều kiện để debug
            const statusMatch = order.status === 'PREPARING';
            const typeMatch = !order.transaction_type || order.transaction_type === 'STOCK_OUT';
            // Tạm thởi bỏ qua lọc sản phẩm để debug
            const productMatch = true; // !order.products || Array.isArray(order.products) && order.products.length === 0 || 
                // (order.products && Array.isArray(order.products) && order.products.some(p => p.type === 'MEDICINE'));
            console.log(`StockOut Order ${order.id}: status=${order.status}, statusMatch=${statusMatch}, typeMatch=${typeMatch}, productMatch=${productMatch}`);
            console.log(`StockOut Order ${order.id}: products=`, order.products);
            return statusMatch && typeMatch && productMatch;
        });
        
        console.log('Valid stock out orders:', validOrders);
        console.log('Filtered stock out orders:', filteredOrders);
        console.log('Filtered stock out orders length:', filteredOrders.length);

        if (filteredOrders.length === 0) {
            container.append('<p class="text-muted">Không có đơn xuất nào đang chờ xử lý.</p>');
        } else {
            filteredOrders.forEach(order => {
                try {
                    // Safely get order properties with fallbacks
                    const orderId = order.id || order.invoiceNumber || 'N/A';
                    const recipient = order.recipient || order.departmentName || order.department || order.customerName || 'N/A';
                    const transactionDate = order.transactionDate || order.createdDate || order.date || 'N/A';
                    
                    // Calculate total amount and product count from products array
                    let calculatedTotal = 0;
                    let calculatedProductCount = 0;
                    if (order.products && Array.isArray(order.products) && order.products.length > 0) {
                        calculatedProductCount = order.products.reduce((sum, item) => sum + (item.quantity || 0), 0);
                        calculatedTotal = order.products.reduce((sum, item) => {
                            return sum + ((item.quantity || 0) * (item.price || 0));
                        }, 0);
                    }

                    const orderDiv = `
                        <div class="order-item order-${order.status.toLowerCase()}">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Đơn xuất: ${orderId}</h6>
                                    <p><strong>Người nhận:</strong> ${recipient}</p>
                                    <p><strong>Ngày tạo:</strong> ${formatDateOnly(transactionDate)}</p>
                                    <p><strong>Tổng tiền:</strong> ${formatCurrency(calculatedTotal)}</p>
                                    <p><strong>Số lượng sản phẩm:</strong> ${calculatedProductCount}</p>
                                    <p><strong>Trạng thái:</strong> <span class="badge bg-info">${getOrderStatusText(order.status)}</span></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group-vertical">
                                        <a class="btn btn-primary btn-sm mb-1" href="/warehouse/stock-out/${orderId}">
                                            <i class="ri-eye-line"></i> Xem chi tiết
                                        </a>
                                        <button class="btn btn-success btn-sm mb-1" onclick="processStockOutOrder('${orderId}')">
                                            <i class="ri-check-line"></i> Xử lý
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectStockOutOrder('${orderId}')">
                                            <i class="ri-close-line"></i> Từ chối
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(orderDiv);
                } catch (error) {
                    console.error('Error processing stock out order:', error, order);
                }
            });
            console.log('Stock out orders loaded:', filteredOrders.length, 'orders');
        }
    }

    // Fixed edit medicine function
    function editMedicine(medicineId) {
        const medicine = medicines.find(m => m.id === medicineId);
        if (!medicine) {
            showNotification('Không tìm thấy thuốc!', 'error');
            return;
        }

        // Create and show edit modal
        const editModalContent = `
                <div class="modal fade" id="editMedicineModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chỉnh sửa thuốc</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="editMedicineForm">
                            <div class="modal-body">
                                <input type="hidden" name="id" value="${medicine.id}">
                                <div class="mb-3">
                                    <label class="form-label">Tên thuốc</label>
                                    <input type="text" class="form-control" name="name" value="${medicine.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mã thuốc</label>
                                    <input type="text" class="form-control" name="code" value="${medicine.id}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Danh mục</label>
                                    <select class="form-select" name="category" required>
                                        <option value="">Chọn danh mục</option>
                                        <option value="antibiotic" ${medicine.category === 'antibiotic' ? 'selected' : ''}>Kháng sinh</option>
                                        <option value="painkiller" ${medicine.category === 'painkiller' ? 'selected' : ''}>Giảm đau</option>
                                        <option value="vitamin" ${medicine.category === 'vitamin' ? 'selected' : ''}>Vitamin</option>
                                        <option value="heart" ${medicine.category === 'heart' ? 'selected' : ''}>Tim mạch</option>
                                        <option value="digestive" ${medicine.category === 'digestive' ? 'selected' : ''}>Tiêu hóa</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Đơn vị tính</label>
                                    <select class="form-select" name="unit" required>
                                        <option value="">Chọn đơn vị</option>
                                        <option value="viên" ${medicine.unit === 'viên' ? 'selected' : ''}>Viên</option>
                                        <option value="vỉ" ${medicine.unit === 'vỉ' ? 'selected' : ''}>Vỉ</option>
                                        <option value="hộp" ${medicine.unit === 'hộp' ? 'selected' : ''}>Hộp</option>
                                        <option value="chai" ${medicine.unit === 'chai' ? 'selected' : ''}>Chai</option>
                                        <option value="tuýp" ${medicine.unit === 'tuýp' ? 'selected' : ''}>Tuýp</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Đơn giá</label>
                                    <input type="number" class="form-control" name="price" min="0" step="100" value="${medicine.price}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số lượng tối thiểu</label>
                                    <input type="number" class="form-control" name="minStock" min="0" value="${medicine.minStock || 50}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Hướng dẫn sử dụng</label>
                                    <textarea class="form-control" name="instructions" rows="3">${medicine.instructions || ''}</textarea>
                                </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" onclick="updateMedicine()">Lưu thay đổi</button>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>
            `;

        $('body').append(editModalContent);
        $('#editMedicineModal').modal('show');

        $('#editMedicineModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    // Fixed view medicine details function
    function viewMedicineDetails(medicineId) {
        const medicine = medicines.find(m => m.id === medicineId);
        if (!medicine) {
            alert('Không tìm thấy thuốc!');
            return;
        }
        $('#detailId').text(medicine.id || 'N/A');
        $('#detailName').text(medicine.name || 'N/A');
        $('#detailCategory').text(getCategoryName(medicine.category) || 'N/A');
        $('#detailStock').text((medicine.stockQuantities || 0) + ' ' + (medicine.unit || ''));
        $('#detailPrice').text(formatCurrency(medicine.price || 0));
        $('#detailUnit').text(medicine.unit || '');
        $('#detailStatus').text(medicine.productStatus || 'ACTIVE');
        $('#detailLabel').text(medicine.label || 'STANDARD');
        $('#detailDescription').text(medicine.description || 'Không có mô tả');
        // Hình ảnh
        const detailImage = $('#detailImage');
        const noImageMessage = $('#noImageMessage');
        if (medicine.imageUrl && medicine.imageUrl.trim() !== '') {
            detailImage.attr('src', medicine.imageUrl);
            detailImage.show();
            noImageMessage.hide();
        } else {
            detailImage.hide();
            noImageMessage.show();
        }
        $('#medicineDetailModal').modal('show');
    }

    // Add delete medicine function
    function deleteMedicine(medicineId) {
        const medicine = medicines.find(m => m.id === medicineId);
        if (!medicine) {
            showNotification('Không tìm thấy thuốc!', 'error');
            return;
        }

        if (confirm(`Bạn có chắc chắn muốn xóa thuốc "${medicine.name}"?`)) {
            // Remove from medicines array
            const index = medicines.findIndex(m => m.id === medicineId);
            if (index !== -1) {
                medicines.splice(index, 1);
                
                // Reload the display
                loadMedicines();
                loadExpiryData();
                updateCounts();
                
                showNotification('Đã xóa thuốc thành công!', 'success');
            }
        }
    }

    // Update medicine function
    function updateMedicine() {
        const form = document.getElementById('editMedicineForm');
        const formData = new FormData(form);
        const id = parseInt(formData.get('id'));

        const medicineIndex = medicines.findIndex(m => m.id === id);
        if (medicineIndex === -1) {
            showNotification('Không tìm thấy thuốc để cập nhật!', 'error');
            return;
        }

        // Keep the original batches and stock
        const originalBatches = medicines[medicineIndex].batches || [];
        const originalStock = medicines[medicineIndex].stockQuantities;

        // Update medicine with new values
        medicines[medicineIndex] = {
            ...medicines[medicineIndex],
            name: formData.get('name'),
            id: formData.get('code'),
            category: formData.get('category'),
            unit: formData.get('unit'),
            stockQuantities: originalStock,
            price: parseFloat(formData.get('price')) || 0,
            minStock: parseInt(formData.get('minStock')) || 50,
            instructions: formData.get('instructions'),
            batches: originalBatches
        };

        loadMedicines();
        $('#editMedicineModal').modal('hide');
        showNotification('Đã cập nhật thuốc thành công!', 'success');
    }

    // Clear filters function
    function clearFilters() {
        $('#searchMedicines').val('');
        $('#categoryFilter').val('');
        $('#stockFilter').val('');
        currentSortField = 'name';
        currentSortDirection = 'asc';
        loadMedicines();
    }

    // Helper functions
    function getStockStatus(stock, minStock) {
        if (stock === 0) return { status: 'out', class: 'stock-low' };
        if (stock <= minStock) return { status: 'low', class: 'stock-low' };
        return { status: 'normal', class: 'stock-normal' };
    }

    function getOrderStatusText(status) {
        const statusMap = {
            'REPARING': 'Chuẩn bị đơn hàng',
            'ADDED': 'Đã thêm',
            'PREPARING': 'Đang chuẩn bị hàng',
            'NEED_TO_ADD': 'Cần thêm vào kho',
            'NEED_TO_ADDED': 'Cần thêm vào kho',
            'WAITING_FOR_DELIVERY': 'Chờ giao hàng',
            'PREPARE_DELIVERY': 'Chuẩn bị giao hàng',
            'READY_FOR_DELIVERY': 'Sẵn sàng giao hàng',
            'DELIVERED': 'Đã giao hàng',
            'CANCELLED': 'Đã hủy',
            'REJECTED': 'Đã từ chối',
            'COMPLETED': 'Hoàn thành',
            'INSPECTED': 'Đã kiểm tra',
            'RECEIVED': 'Đã nhận',
            'PENDING': 'Chờ xử lý',
            'PAID': 'Đã thanh toán'
        };
        return statusMap[status] || status;
    }

    // Get category name
    function getCategoryName(categoryCode) {
        const categories = {
            'antibiotic': 'Kháng sinh',
            'painkiller': 'Giảm đau',
            'vitamin': 'Vitamin',
            'antihistamine': 'Kháng histamin',
            'antiviral': 'Kháng virus',
            'antifungal': 'Kháng nấm',
            'antiinflammatory': 'Chống viêm',
            'antidiabetic': 'Điều trị tiểu đường',
            'cardiovascular': 'Tim mạch',
            'respiratory': 'Hô hấp',
            'gastrointestinal': 'Tiêu hóa',
            'neurological': 'Thần kinh',
            'dermatological': 'Da liễu',
            'hormonal': 'Nội tiết',
            'contraceptive': 'Tránh thai',
            'musculoskeletal': 'Cơ xương khớp',
            'anticancer': 'Điều trị ung thư',
            'immunosuppressant': 'Ức chế miễn dịch',
            'antiparasitic': 'Chống ký sinh trùng',
            'vaccine': 'Vắc-xin',
            'anesthetic': 'Gây mê',
            'antidote': 'Giải độc',
            'diagnostic': 'Chẩn đoán',
            'herbal': 'Thảo dược',
            'supplement': 'Bổ sung dinh dưỡng',
            'other': 'Khác'
        };
        return categories[categoryCode] || 'Chưa phân loại';
    }



    // Format currency
    function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) {
            return '0 ₫';
        }
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    }

    // Save medicine function
    function saveMedicine() {
        const form = document.getElementById('addMedicineForm');
        const formData = new FormData(form);

        const medicine = {
            id: medicines.length + 1,
            name: formData.get('name'),
            code: formData.get('code'),
            category: formData.get('category'),
            unit: formData.get('unit'),
            stockQuantities: parseInt(formData.get('stock')) || 0,
            price: parseFloat(formData.get('price')) || 0,
            minStock: parseInt(formData.get('minStock')) || 50,
            instructions: formData.get('instructions'),
            batches: []
        };

        medicines.push(medicine);
        loadMedicines();
        updateCounts();

        $('#addMedicineModal').modal('hide');
        form.reset();
        showNotification('Đã thêm thuốc thành công!', 'success');
    }

    // Show notification function
    function showNotification(message, type) {
        $.notify({
            icon: type === 'success' ? 'ri-check-line' : type === 'warning' ? 'ri-alert-line' : 'ri-information-line',
            message: message
        }, {
            type: type,
            allow_dismiss: true,
            placement: {
                from: 'top',
                align: 'right'
            },
            offset: 20,
            spacing: 10,
            z_index: 1031,
            delay: 3000,
            timer: 1000,
            animate: {
                enter: 'animated fadeInDown',
                exit: 'animated fadeOutUp'
            }
        });
    }

    // Handle expired batch function
    function handleExpiredBatch(batchNo) {
        if (confirm(`Xử lý lô hàng hết hạn: ${batchNo}?\nHành động này sẽ đánh dấu lô hàng cần được thu hồi.`)) {
            showNotification(`Đã đánh dấu lô ${batchNo} cần thu hồi!`, 'warning');
        }
    }

    // View stock in order function
    function viewStockInOrder(orderId) {
        const order = stockInOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        // Calculate total amount and product count from products array
        let calculatedTotal = 0;
        let calculatedProductCount = 0;
        if (order.products && Array.isArray(order.products) && order.products.length > 0) {
            calculatedProductCount = order.products.reduce((sum, item) => sum + (item.quantity || 0), 0);
            calculatedTotal = order.products.reduce((sum, item) => {
                return sum + ((item.quantity || 0) * (item.price || 0));
            }, 0);
        }

        const modalContent = `
            <div class="modal fade" id="viewStockInOrderModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết đơn nhập #${order.id || order.invoiceNumber}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Mã đơn hàng:</strong> ${order.id || order.invoiceNumber || 'N/A'}</p>
                                    <p><strong>Nhà cung cấp:</strong> ${order.supplierName || order.supplier || 'N/A'}</p>
                                    <p><strong>Ngày tạo:</strong> ${formatDateOnly(order.transactionDate || order.createdDate || order.date || 'N/A')}</p>
                                    <p><strong>Tổng tiền:</strong> ${formatCurrency(order.totalAmount || calculatedTotal)}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Trạng thái:</strong> <span class="badge bg-info">${getOrderStatusText(order.status)}</span></p>
                                    <p><strong>Số lượng sản phẩm:</strong> ${order.productCount || calculatedProductCount}</p>
                                    <p><strong>Ghi chú:</strong> ${order.notes || 'Không có'}</p>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Thuốc</th>
                                            <th>Số lượng</th>
                                            <th>Đơn giá</th>
                                            <th>Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${order.products && Array.isArray(order.products) && order.products.length > 0 ? order.products.map(item => {
                                            const medicine = medicines.find(m => m.id === item.productId);
                                            const itemTotal = (item.quantity || 0) * (item.price || 0);
                                            return `
                                                <tr>
                                                    <td>${medicine ? medicine.name : 'Không xác định'}</td>
                                                    <td>${item.quantity || 0}</td>
                                                    <td>${formatCurrency(item.price || 0)}</td>
                                                    <td>${formatCurrency(itemTotal)}</td>
                                                </tr>
                                            `;
                                        }).join('') : '<tr><td colspan="4" class="text-center">Không có dữ liệu</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        $('body').append(modalContent);
        $('#viewStockInOrderModal').modal('show');

        $('#viewStockInOrderModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    // View stock out order function
    function viewStockOutOrder(orderId) {
        const order = stockOutOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        // Calculate total amount and product count from products array
        let calculatedTotal = 0;
        let calculatedProductCount = 0;
        if (order.products && Array.isArray(order.products) && order.products.length > 0) {
            calculatedProductCount = order.products.reduce((sum, item) => sum + (item.quantity || 0), 0);
            calculatedTotal = order.products.reduce((sum, item) => {
                return sum + ((item.quantity || 0) * (item.price || 0));
            }, 0);
        }

        const modalContent = `
            <div class="modal fade" id="viewStockOutOrderModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết đơn xuất #${order.id || order.invoiceNumber}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Mã đơn hàng:</strong> ${order.id || order.invoiceNumber || 'N/A'}</p>
                                    <p><strong>Khoa/Phòng:</strong> ${order.recipient || order.departmentName || order.department || 'N/A'}</p>
                                    <p><strong>Ngày tạo:</strong> ${formatDateOnly(order.transactionDate || order.createdDate || order.date || 'N/A')}</p>
                                    <p><strong>Tổng tiền:</strong> ${formatCurrency(order.totalAmount || calculatedTotal)}</p>
                                    <p><strong>Số lượng sản phẩm:</strong> ${order.productCount || calculatedProductCount}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Trạng thái:</strong> <span class="badge bg-warning">${getOrderStatusText(order.status)}</span></p>
                                    <p><strong>Ghi chú:</strong> ${order.notes || 'Không có'}</p>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Thuốc</th>
                                            <th>Số lượng</th>
                                            <th>Đơn giá</th>
                                            <th>Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${order.products && Array.isArray(order.products) && order.products.length > 0 ? order.products.map(item => {
                                            const medicine = medicines.find(m => m.id === item.productId);
                                            const itemTotal = (item.quantity || 0) * (item.price || 0);
                                            return `
                                                <tr>
                                                    <td>${medicine ? medicine.name : 'Không xác định'}</td>
                                                    <td>${item.quantity || 0}</td>
                                                    <td>${formatCurrency(item.price || 0)}</td>
                                                    <td>${formatCurrency(itemTotal)}</td>
                                                </tr>
                                            `;
                                        }).join('') : '<tr><td colspan="4" class="text-center">Không có dữ liệu</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        $('body').append(modalContent);
        $('#viewStockOutOrderModal').modal('show');

        $('#viewStockOutOrderModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    // Process stock in order function
    function processStockInOrder(orderId) {
        console.log('processStockInOrder called with orderId:', orderId);
        console.log('Available stockInOrders:', stockInOrders);
        
        const order = stockInOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        console.log('Found order:', order);
        
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        if (confirm(`Xác nhận xử lý đơn nhập #${order.id || order.invoiceNumber}?`)) {
                    $.ajax({
            url: `/warehouse/medicines/api/stock-in/${orderId}/process`,
            type: 'POST',
            beforeSend: function(xhr) {
                if (CSRF_TOKEN) {
                    xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                }
            },
                success: function(response) {
                    console.log('API Response:', response);
                    if (response.success) {
                        showNotification('Đã xử lý đơn nhập thành công! Đơn hàng đã chuyển sang trang StockInInvoice.', 'success');
                        // Reload danh sách đơn hàng để cập nhật
            loadStockInOrders();
                    } else {
                        showNotification('Lỗi: ' + (response.message || 'Không xác định'), 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error processing stock in order:', error);
                    console.error('Response:', xhr.responseText);
                    showNotification('Lỗi khi xử lý đơn nhập!', 'error');
                }
            });
        }
    }

    // Prepare stock out order function
    function prepareStockOutOrder(orderId) {
        const order = stockOutOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        // Check stock availability
        let canPrepare = true;
        if (order.products) {
            order.products.forEach(item => {
                const medicine = medicines.find(m => m.id === item.productId);
                if (!medicine || medicine.stockQuantities < item.quantity) {
                    canPrepare = false;
                }
            });
        }

        if (!canPrepare) {
            showNotification('Không đủ hàng để chuẩn bị đơn xuất!', 'warning');
            return;
        }

        if (confirm(`Xác nhận chuẩn bị đơn xuất #${order.id || order.invoiceNumber}?`)) {
                    $.ajax({
            url: `/warehouse/medicines/api/stock-out/${orderId}/prepare`,
            type: 'POST',
            beforeSend: function(xhr) {
                if (CSRF_TOKEN) {
                    xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                }
            },
                success: function(response) {
                    console.log('API Response:', response);
                    if (response.success) {
                        showNotification('Đã chuẩn bị đơn xuất thành công! Đơn hàng đã chuyển sang trang StockOut.', 'success');
                        // Reload danh sách đơn hàng để cập nhật
            loadStockOutOrders();
                    } else {
                        showNotification('Lỗi: ' + (response.message || 'Không xác định'), 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error preparing stock out order:', error);
                    console.error('Response:', xhr.responseText);
                    showNotification('Lỗi khi chuẩn bị đơn xuất!', 'error');
                }
            });
        }
    }

    // Reject stock in order function
    function rejectStockInOrder(orderId) {
        const order = stockInOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        // Create a modal for rejection reason
        const modalHtml = `
            <div class="modal fade" id="rejectStockInModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Từ chối đơn nhập #${order.id || order.invoiceNumber}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="rejectReason" class="form-label">Lý do từ chối:</label>
                                <textarea class="form-control" id="rejectReason" rows="3" placeholder="Nhập lý do từ chối..."></textarea>
                            </div>
                            </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-danger" onclick="confirmRejectStockIn('${orderId}')">Từ chối</button>
                        </div>
                        </div>
                        </div>
                    </div>
                `;

        // Remove existing modal if any
        $('#rejectStockInModal').remove();
        
        // Add modal to body
        $('body').append(modalHtml);
        
        // Show modal
        $('#rejectStockInModal').modal('show');
    }

    // Confirm reject stock in order
    function confirmRejectStockIn(orderId) {
        const reason = $('#rejectReason').val().trim();
        if (!reason) {
            showNotification('Vui lòng nhập lý do từ chối!', 'warning');
            return;
        }

        const order = stockInOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        $.ajax({
            url: `/warehouse/medicines/api/stock-in/${orderId}/reject`,
            type: 'POST',
            contentType: 'application/json',
            beforeSend: function(xhr) {
                if (CSRF_TOKEN) {
                    xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                }
            },
            data: JSON.stringify({ reason: reason }),
            success: function(response) {
                console.log('API Response:', response);
                if (response.success) {
                    showNotification('Đã từ chối đơn nhập thành công! Đơn hàng đã chuyển sang trạng thái REJECTED.', 'success');
                    // Reload danh sách đơn hàng để cập nhật
                    loadStockInOrders();
                } else {
                    showNotification('Lỗi: ' + (response.message || 'Không xác định'), 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error rejecting stock in order:', error);
                console.error('Response:', xhr.responseText);
                showNotification('Lỗi khi từ chối đơn nhập!', 'error');
            }
        });

        // Close modal
        $('#rejectStockInModal').modal('hide');
    }

    // Reject stock out order function
    function rejectStockOutOrder(orderId) {
        const order = stockOutOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        // Create a modal for rejection reason
        const modalHtml = `
            <div class="modal fade" id="rejectStockOutModal" tabindex="-1" role="dialog" aria-labelledby="rejectStockOutModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="rejectStockOutModalLabel">Từ chối đơn xuất #${order.id || order.invoiceNumber}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="rejectReasonOut" class="form-label">Lý do từ chối:</label>
                                <textarea class="form-control" id="rejectReasonOut" rows="3" placeholder="Nhập lý do từ chối..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-danger" onclick="confirmRejectStockOut('${orderId}')">Từ chối</button>
                        </div>
                    </div>
                        </div>
                    </div>
                `;

        // Remove existing modal if any
        $('#rejectStockOutModal').remove();
        
        // Add modal to body
        $('body').append(modalHtml);
        
        // Show modal
        $('#rejectStockOutModal').modal('show');
    }

    // Confirm reject stock out order
    function confirmRejectStockOut(orderId) {
        const reason = $('#rejectReasonOut').val().trim();
        if (!reason) {
            showNotification('Vui lòng nhập lý do từ chối!', 'warning');
            return;
        }

        const order = stockOutOrders.find(o => o.id == orderId || o.invoiceNumber == orderId);
        if (!order) {
            showNotification('Không tìm thấy đơn hàng!', 'error');
            return;
        }

        $.ajax({
            url: `/warehouse/medicines/api/stock-out/${orderId}/reject`,
            type: 'POST',
            contentType: 'application/json',
            beforeSend: function(xhr) {
                if (CSRF_TOKEN) {
                    xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                }
            },
            data: JSON.stringify({ reason: reason }),
            success: function(response) {
                console.log('API Response:', response);
                if (response.success) {
                    showNotification('Đã từ chối đơn xuất thành công! Đơn hàng đã chuyển sang trạng thái REJECTED.', 'success');
                    // Reload danh sách đơn hàng để cập nhật
                    loadStockOutOrders();
                } else {
                    showNotification('Lỗi: ' + (response.message || 'Không xác định'), 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error rejecting stock out order:', error);
                console.error('Response:', xhr.responseText);
                showNotification('Lỗi khi từ chối đơn xuất!', 'error');
            }
        });

        // Close modal
        $('#rejectStockOutModal').modal('hide');
    }

    // Add problematic medicines to modal function
    function addProblemMedicinesToModal() {
        const problemMedicines = [];
        
        // Debug: Check medicines data
        console.log('Medicines data:', medicines);
        console.log('Total medicines count:', medicines ? medicines.length : 0);
        
        // Find medicines with low stock - using same logic as updateCounts
        if (medicines) {
        medicines.forEach(medicine => {
                const stock = medicine.stockQuantities || 0;
                const minStock = medicine.minStock || 50;
                
                // Debug: Log each medicine check
                console.log(`Checking medicine: ${medicine.name}, stock: ${stock}, minStock: ${minStock}, condition: ${stock <= minStock}`);
                
                if (stock <= minStock) {
                    console.log(`Adding ${medicine.name} to problem medicines`);
                    problemMedicines.push({
                        name: medicine.name,
                        qty: Math.max(minStock, 100),
                        price: medicine.price || 10000,
                    reason: 'Tồn kho thấp'
                });
            }
        });
        }
        
        // Debug: Log final results
        console.log('Problem medicines found:', problemMedicines);
        console.log('Problem medicines count:', problemMedicines.length);
        
        if (problemMedicines.length === 0) {
            showNotification('Không có thuốc nào có vấn đề', 'info');
            return;
        }

        showNotification(`Đã tìm thấy ${problemMedicines.length} thuốc cần nhập thêm`, 'success');
        
        // In a real application, this would populate the stock-in modal
        // console.log('Problem medicines:', problemMedicines);
    }

    // Load problem medicines into the expiry tab
    function loadProblemMedicines() {
        const problemMedicines = [];
        
        // Debug: Check medicines data
        console.log('Loading problem medicines, total medicines:', medicines ? medicines.length : 0);
        
        // Find medicines with low stock - using same logic as updateCounts
        if (medicines) {
            medicines.forEach(medicine => {
                const stock = medicine.stockQuantities || 0;
                const minStock = medicine.minStock || 50;
                
                console.log(`Checking medicine: ${medicine.name}, stock: ${stock}, minStock: ${minStock}`);
                
                if (stock <= minStock) {
                    console.log(`Adding ${medicine.name} to problem medicines - low stock`);
                    problemMedicines.push({
                        name: medicine.name,
                        status: 'Tồn kho thấp',
                        statusClass: 'bg-warning',
                        medicineId: medicine.id
                    });
                }
            });
        }
        
        console.log('Problem medicines found:', problemMedicines);
        
        // Populate the table
        const tbody = document.getElementById('expiryTableBody');
        if (!tbody) {
            console.error('expiryTableBody not found!');
            return;
        }
        
        if (problemMedicines.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted py-4">
                        <i class="ri-emotion-happy-line me-2"></i>
                        Không có thuốc nào có vấn đề
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = problemMedicines.map(medicine => `
            <tr>
                <td>${medicine.name}</td>
                <td><span class="${medicine.statusClass}">${medicine.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="createStockInForMedicine(${medicine.medicineId})" title="Tạo đơn nhập">
                        <i class="ri-add-circle-line"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="viewMedicineDetails(${medicine.medicineId})" title="Xem chi tiết">
                        <i class="ri-eye-line"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Create stock in order for a specific medicine
    function createStockInForMedicine(medicineId) {
        // Find the medicine in the medicines array
        const medicine = medicines.find(m => m.id === medicineId);
        if (!medicine) {
            showNotification('Không tìm thấy thông tin thuốc', 'error');
            return;
        }
        
        // Open the create inbound order modal and pre-fill with this medicine
        const modal = new bootstrap.Modal(document.getElementById('createInboundOrderModal'));
        
        // Clear existing items in the modal
        if (window.selectedProductsIn) {
            window.selectedProductsIn = [];
        } else {
            window.selectedProductsIn = [];
        }
        
        // Add this medicine to the selected products
        const defaultQuantity = 100; // Default quantity to add
        const defaultPrice = medicine.price || 10000; // Default price if not available
        
        window.selectedProductsIn.push({
            id: medicine.id,
            name: medicine.name,
            quantity: defaultQuantity,
            price: defaultPrice
        });
        
        // Update the items table in the modal
        updateItemsTableIn();
        
        // Show notification and modal
        showNotification(`Đã thêm ${medicine.name} vào đơn nhập mới`, 'success');
        modal.show();
    }

    // Add item to list for stock out modal
    function addItemToList() {
        const productId = document.getElementById('selectedProductId').value;
        const quantity = parseInt(document.getElementById('quantity').value);
        
        if (!productId) {
            showNotification('Vui lòng chọn một sản phẩm', 'warning');
            return;
        }

        if (quantity <= 0) {
            showNotification('Số lượng phải lớn hơn 0', 'warning');
            return;
        }
        
        // Find the product from medicines array
        const product = medicines.find(m => m.id == productId);
        if (product) {
            // Add to selected products (global variable)
            if (!window.selectedProducts) window.selectedProducts = [];
            
            const existingIndex = window.selectedProducts.findIndex(p => p.id == productId);
            if (existingIndex !== -1) {
                window.selectedProducts[existingIndex].quantity += quantity;
            } else {
                window.selectedProducts.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                });
            }
            
            // Update the table
            updateItemsTable();
            $('#addItemModal').modal('hide');
            
            showNotification('Đã thêm thuốc vào danh sách', 'success');
        } else {
            showNotification('Không tìm thấy thông tin sản phẩm', 'danger');
        }
    }

    // Add item to list for stock in modal
    function addItemToListIn() {
        const productId = document.getElementById('selectedProductIdIn').value;
        const quantity = parseInt(document.getElementById('quantityIn').value);
        
        if (!productId) {
            showNotification('Vui lòng chọn một sản phẩm', 'warning');
            return;
        }
        
        if (quantity <= 0) {
            showNotification('Số lượng phải lớn hơn 0', 'warning');
            return;
        }
        
        // Find the product from medicines array
        const product = medicines.find(m => m.id == productId);
        if (product) {
            // Add to selected products for inbound (global variable)
            if (!window.selectedProductsIn) window.selectedProductsIn = [];
            
            const existingIndex = window.selectedProductsIn.findIndex(p => p.id == productId);
            if (existingIndex !== -1) {
                window.selectedProductsIn[existingIndex].quantity += quantity;
            } else {
                window.selectedProductsIn.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                });
            }
            
            // Update the table
            updateItemsTableIn();
            $('#addItemModalIn').modal('hide');
            
            showNotification('Đã thêm thuốc vào danh sách', 'success');
        } else {
            showNotification('Không tìm thấy thông tin sản phẩm', 'danger');
        }
    }

    // Update items table for stock out
    function updateItemsTable() {
        const tbody = document.getElementById('itemsList');
        if (!tbody) return;
        
        if (!window.selectedProducts || window.selectedProducts.length === 0) {
            tbody.innerHTML = '<tr id="noItemsMessage"><td colspan="5" class="text-center">Không có thuốc nào. Vui lòng thêm thuốc vào danh sách.</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        let total = 0;
        
        window.selectedProducts.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.quantity}</td>
                <td>${formatCurrency(product.price)}</td>
                <td>${formatCurrency(product.price * product.quantity)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItemFromList(${product.id})">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            total += product.price * product.quantity;
        });
        
        // Update total
        const totalElement = document.querySelector('#totalAmount');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
        
        // Update hidden input
        const totalAmountInput = document.getElementById('totalAmountInput');
        if (totalAmountInput) {
            totalAmountInput.value = total;
        }
    }

    // Update items table for stock in
    function updateItemsTableIn() {
        const tbody = document.getElementById('itemsListIn');
        if (!tbody) return;
        
        if (!window.selectedProductsIn || window.selectedProductsIn.length === 0) {
            tbody.innerHTML = '<tr id="noItemsMessageIn"><td colspan="5" class="text-center">Không có thuốc nào. Vui lòng thêm thuốc vào danh sách.</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        let total = 0;
        
        window.selectedProductsIn.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.quantity}</td>
                <td>${formatCurrency(product.price)}</td>
                <td>${formatCurrency(product.price * product.quantity)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItemFromListIn(${product.id})">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            total += product.price * product.quantity;
        });
            
            // Update total
        const totalElement = document.querySelector('#totalAmountIn');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
        
        // Update hidden input
        const totalAmountInput = document.getElementById('totalAmountInputIn');
        if (totalAmountInput) {
            totalAmountInput.value = total;
        }
    }

    // Remove item from stock out list
    function removeItemFromList(productId) {
        if (window.selectedProducts) {
            window.selectedProducts = window.selectedProducts.filter(p => p.id != productId);
            updateItemsTable();
        }
    }

    // Remove item from stock in list
    function removeItemFromListIn(productId) {
        if (window.selectedProductsIn) {
            window.selectedProductsIn = window.selectedProductsIn.filter(p => p.id != productId);
            updateItemsTableIn();
        }
    }

    // Recalculate total for stock out
    function recalculateTotal() {
        if (!window.selectedProducts) return;
        
        let subtotal = 0;
        window.selectedProducts.forEach(product => {
            subtotal += product.price * product.quantity;
        });
        
        const taxRate = parseFloat(document.getElementById('taxAmount')?.value || 10);
        const taxValue = subtotal * (taxRate / 100);
        const shippingCost = parseFloat(document.getElementById('shippingCost')?.value || 0);
        const total = subtotal + taxValue + shippingCost;
        
        // Update UI
        const totalElement = document.querySelector('#totalAmount');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
        
        // Update hidden input for form submission
        const totalAmountInput = document.getElementById('totalAmountInput');
        if (totalAmountInput) {
            totalAmountInput.value = total;
        }
    }
    
    // Recalculate total for stock in
    function recalculateTotalIn() {
        if (!window.selectedProductsIn) return;
        
        let subtotal = 0;
        window.selectedProductsIn.forEach(product => {
            subtotal += product.price * product.quantity;
        });
        
        const taxRate = parseFloat(document.getElementById('taxAmountIn')?.value || 10);
        const taxValue = subtotal * (taxRate / 100);
        const shippingCost = parseFloat(document.getElementById('shippingCostIn')?.value || 0);
        const discountAmount = parseFloat(document.getElementById('discountAmountIn')?.value || 0);
        const total = subtotal + taxValue + shippingCost - discountAmount;
        
        // Update UI
        const totalElement = document.querySelector('#totalAmountIn');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
        
        // Update hidden input for form submission
        const totalAmountInput = document.getElementById('totalAmountInputIn');
        if (totalAmountInput) {
            totalAmountInput.value = total;
        }
    }

    // Initialize on document ready
    $(document).ready(function() {
        // Debug: Log data for troubleshooting
        // console.log('Stock In Orders data:', stockInOrders);
        // console.log('Stock Out Orders data:', stockOutOrders);
        
        // Initial load for first tab only
        loadMedicines();
        updateCounts();
        loadProblemMedicines(); // Load problem medicines tab

        // Set up event listeners for filters
        $('#searchMedicines').on('input', filterMedicines);
        $('#categoryFilter').on('change', filterMedicines);
        $('#stockFilter').on('change', filterMedicines);
        
        // Set up tab switching events
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            const target = $(e.target).attr('href');
            console.log('Tab switched to:', target);
            
            // Reload data when switching to specific tabs
            if (target === '#expiry') {
                loadProblemMedicines();
            } else if (target === '#medicines') {
                loadMedicines();
            } else if (target === '#stock-in') {
                loadStockInOrders();
            } else if (target === '#stock-out') {
                loadStockOutOrders();
            }
        });
    });

    function createStockInForProblemMedicines() {
        // Lấy danh sách thuốc có vấn đề
        const problemMedicines = getProblemMedicines();
        if (problemMedicines.length === 0) {
            showNotification('Không có thuốc nào có vấn đề để tạo đơn nhập.', 'error');
            return;
        }
        
        // Mở modal tạo đơn nhập
        $('#createInboundOrderModal').modal('show');
        
        // Xóa danh sách sản phẩm hiện tại trong modal
        stockInProducts = [];
        $('#stockInProductList').empty();
        
        // Thêm tất cả thuốc có vấn đề vào danh sách
        problemMedicines.forEach(medicine => {
            addStockInProduct(medicine.medicineId, medicine.name, medicine.unitPrice || medicine.price || 0, medicine.minStock || 50, medicine.unit || 'viên');
        });
        
        showNotification('Đã thêm ' + problemMedicines.length + ' thuốc có vấn đề vào đơn nhập.', 'success');
    }

    // Hàm chuyển đổi trạng thái sang text
    function getOrderStatusText(status) {
        const statusMap = {
            'NEED_TO_ADD': 'Cần nhập',
            'WAITING_FOR_DELIVERY': 'Chờ giao hàng',
            'RECEIVED': 'Đã nhận hàng',
            'PREPARING': 'Đang chuẩn bị',
            'PREPARE_DELIVERY': 'Chuẩn bị giao hàng',
            'DELIVERING': 'Đang giao hàng',
            'COMPLETED': 'Hoàn thành',
            'REJECTED': 'Từ chối'
        };
        return statusMap[status] || status;
    }

    function getProblemMedicines() {
        const problemMedicines = [];
        medicines.forEach(medicine => {
            const stock = medicine.stockQuantities || 0;
            const minStock = medicine.minStock || 50;
            
            // Thuốc có vấn đề nếu tồn kho thấp
            if (stock <= minStock) {
                problemMedicines.push({
                    ...medicine,
                    status: 'Tồn kho thấp',
                    statusClass: 'bg-danger stock-low'
                });
            }
            
            // Kiểm tra thuốc sắp hết hạn
            if (medicine.batches) {
                medicine.batches.forEach(batch => {
                    if (batch.expiryDate) {
                        const expDate = new Date(batch.expiryDate);
                        const today = new Date();
                        const daysToExpiry = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));

                        if (daysToExpiry <= 90) {
                            // Chỉ thêm nếu chưa có trong danh sách
                            if (!problemMedicines.some(p => p.id === medicine.id)) {
                                problemMedicines.push({
                                    ...medicine,
                                    status: daysToExpiry <= 0 ? 'Đã hết hạn' : daysToExpiry <= 30 ? 'Sắp hết hạn' : 'Gần hết hạn',
                                    statusClass: daysToExpiry <= 0 ? 'bg-danger expired' : daysToExpiry <= 30 ? 'bg-danger near-expiry' : 'bg-warning near-expiry'
                                });
                            } else {
                                // Cập nhật trạng thái nếu đã có trong danh sách
                                const existing = problemMedicines.find(p => p.id === medicine.id);
                                if (existing && existing.status !== 'Đã hết hạn' && existing.status !== 'Sắp hết hạn') {
                                    existing.status = daysToExpiry <= 0 ? 'Đã hết hạn, Tồn kho thấp' : daysToExpiry <= 30 ? 'Sắp hết hạn, Tồn kho thấp' : 'Gần hết hạn, Tồn kho thấp';
                                    existing.statusClass = daysToExpiry <= 0 ? 'bg-danger expired' : daysToExpiry <= 30 ? 'bg-danger near-expiry' : 'bg-warning near-expiry';
                                }
                            }
                        }
                    }
                });
            }
        });
        return problemMedicines;
    }
    
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Initialize supplier search
    function initSupplierSearch() {
        const supplierSearch = document.getElementById('supplierSearchIn');
        if (!supplierSearch) {
            console.log('Supplier search input not found');
            return;
        }
        
        const supplierSearchResults = document.getElementById('supplierSearchResultsIn');
        const supplierId = document.getElementById('supplierIdIn');
        const selectedSupplierInfo = document.getElementById('selectedSupplierInfoIn');
        
        if (!supplierSearchResults || !supplierId || !selectedSupplierInfo) {
            console.log('Some supplier search elements not found');
            return;
        }
        
        // Search on input
        supplierSearch.addEventListener('input', debounce(function() {
            const query = supplierSearch.value.trim();
            if (query.length < 2) {
                supplierSearchResults.classList.remove('show');
                return;
            }
            
            fetch(`/warehouse/stock-in/api/suppliers?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    supplierSearchResults.innerHTML = '';
                    
                    if (data.length === 0) {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.textContent = 'Không tìm thấy nhà cung cấp';
                        supplierSearchResults.appendChild(item);
                    } else {
                        data.forEach(supplier => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item';
                            item.href = '#';
                            item.textContent = supplier.name;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                supplierSearch.value = supplier.name;
                                supplierId.value = supplier.id;
                                selectedSupplierInfo.textContent = `ID: ${supplier.id}, Liên hệ: ${supplier.contactPerson || 'N/A'}`;
                                supplierSearchResults.classList.remove('show');
                            });
                            supplierSearchResults.appendChild(item);
                        });
                    }
                    
                    supplierSearchResults.classList.add('show');
                })
                .catch(error => {
                    console.error('Error searching suppliers:', error);
                });
        }, 500));
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (supplierSearchResults && !supplierSearch.contains(e.target) && !supplierSearchResults.contains(e.target)) {
                supplierSearchResults.classList.remove('show');
            }
        });
        
        // Modal search - check if modal elements exist
        const supplierModalSearch = document.getElementById('supplierModalSearchIn');
        const supplierModalResults = document.getElementById('supplierModalResultsIn');
        const supplierLoading = document.getElementById('supplierLoadingIn');
        
        if (!supplierModalSearch || !supplierModalResults || !supplierLoading) {
            console.log('Supplier modal elements not found, skipping modal initialization');
            return;
        }
        
        supplierModalSearch.addEventListener('input', debounce(function() {
            const query = supplierModalSearch.value.trim();
            if (query.length < 2) {
                return;
            }
            
            supplierLoading.style.display = 'block';
            
            fetch(`/warehouse/stock-in/api/suppliers?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    supplierModalResults.innerHTML = '';
                    
                    if (data.length === 0) {
                        const item = document.createElement('div');
                        item.className = 'list-group-item';
                        item.textContent = 'Không tìm thấy nhà cung cấp';
                        supplierModalResults.appendChild(item);
                    } else {
                        data.forEach(supplier => {
                            const item = document.createElement('button');
                            item.className = 'list-group-item list-group-item-action';
                            item.type = 'button';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${supplier.name}</h5>
                                    <small>ID: ${supplier.id}</small>
                                </div>
                                <p class="mb-1">${supplier.address || 'N/A'}</p>
                                <small>Liên hệ: ${supplier.contactPerson || 'N/A'}</small>
                            `;
                            item.addEventListener('click', function() {
                                try {
                                    supplierSearch.value = supplier.name;
                                    supplierId.value = supplier.id;
                                    selectedSupplierInfo.textContent = `ID: ${supplier.id}, Liên hệ: ${supplier.contactPerson || 'N/A'}`;
                                    
                                    // Use Bootstrap 5 modal hide method
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('supplierModalIn'));
                                    if (modal) {
                                        modal.hide();
                                    } else {
                                        // Fallback to jQuery if bootstrap instance not found
                                        $('#supplierModalIn').modal('hide');
                                    }
                                } catch (error) {
                                    console.error('Error hiding modal:', error);
                                }
                            });
                            supplierModalResults.appendChild(item);
                        });
                    }
                    
                    supplierLoading.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error searching suppliers:', error);
                    supplierLoading.style.display = 'none';
                });
        }, 500));
    }
    
    // Initialize product search for inbound order
    function initProductSearchIn() {
        const productSearchIn = document.getElementById('productSearchIn');
        if (!productSearchIn) {
            console.log('Product search input not found');
            return;
        }
        
        const productSearchResultsIn = document.getElementById('productSearchResultsIn');
        const selectedProductIdIn = document.getElementById('selectedProductIdIn');
        const productDetailsIn = document.getElementById('productDetailsIn');
        const productNameIn = document.getElementById('productNameIn');
        const productStockIn = document.getElementById('productStockIn');
        const productPriceIn = document.getElementById('productPriceIn');
        
        if (!productSearchResultsIn || !selectedProductIdIn || !productDetailsIn) {
            console.log('Some product search elements not found');
            return;
        }
        
        // Add event listener for product search with debounce
        productSearchIn.addEventListener('input', debounce(function() {
            const query = productSearchIn.value.trim();
            if (query.length < 2) {
                productSearchResultsIn.classList.remove('show');
                productDetailsIn.style.display = 'none';
                return;
            }
            
            // Call API to search products
            fetch(`/warehouse/stock-in/api/products?query=${encodeURIComponent(query)}&productType=MEDICINE`)
                .then(response => response.json())
                .then(data => {
                    productSearchResultsIn.innerHTML = '';
                    
                    if (data.length === 0) {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.textContent = 'Không tìm thấy thuốc';
                        productSearchResultsIn.appendChild(item);
                    } else {
                        data.slice(0, 10).forEach(product => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item';
                            item.href = '#';
                            item.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <span>${product.name}</span>
                                    <small class="text-muted">Tồn: ${product.stockQuantities || 0}</small>
                                </div>
                            `;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Set selected product
                                productSearchIn.value = product.name;
                                selectedProductIdIn.value = product.id;
                                
                                // Show product details
                                if (productNameIn) productNameIn.textContent = product.name;
                                if (productStockIn) productStockIn.textContent = product.stockQuantities || 0;
                                if (productPriceIn) productPriceIn.textContent = formatCurrency(product.price || 0);
                                productDetailsIn.style.display = 'block';
                                
                                productSearchResultsIn.classList.remove('show');
                            });
                            productSearchResultsIn.appendChild(item);
                        });
                    }
                    
                    productSearchResultsIn.classList.add('show');
                })
                .catch(error => {
                    console.error('Error searching products:', error);
                    // Fallback to local search if API fails
                    const filteredMedicines = medicines.filter(medicine => {
                        const medicineName = medicine.name || '';
                        const medicineId = medicine.id || '';
                        return medicineName.toLowerCase().includes(query.toLowerCase()) ||
                               medicineId.toString().toLowerCase().includes(query.toLowerCase());
                    });
                    
                    productSearchResultsIn.innerHTML = '';
                    
                    if (filteredMedicines.length === 0) {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.textContent = 'Không tìm thấy thuốc';
                        productSearchResultsIn.appendChild(item);
                    } else {
                        filteredMedicines.slice(0, 10).forEach(product => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item';
                            item.href = '#';
                            item.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <span>${product.name}</span>
                                    <small class="text-muted">Tồn: ${product.stockQuantities || 0}</small>
                                </div>
                            `;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Set selected product
                                productSearchIn.value = product.name;
                                selectedProductIdIn.value = product.id;
                                
                                // Show product details
                                if (productNameIn) productNameIn.textContent = product.name;
                                if (productStockIn) productStockIn.textContent = product.stockQuantities || 0;
                                if (productPriceIn) productPriceIn.textContent = formatCurrency(product.price || 0);
                                productDetailsIn.style.display = 'block';
                                
                                productSearchResultsIn.classList.remove('show');
                            });
                            productSearchResultsIn.appendChild(item);
                        });
                    }
                    
                    productSearchResultsIn.classList.add('show');
                });
            
            productSearchResultsIn.classList.add('show');
        }, 500));
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (productSearchResultsIn && !productSearchIn.contains(e.target) && !productSearchResultsIn.contains(e.target)) {
                productSearchResultsIn.classList.remove('show');
            }
        });
        
        // Clear product details when input is cleared
        productSearchIn.addEventListener('input', function() {
            if (productSearchIn.value.trim() === '') {
                productDetailsIn.style.display = 'none';
                selectedProductIdIn.value = '';
            }
        });
    }
    
    // Initialize supplier search when document is ready
    $(document).ready(function() {
        initSupplierSearch();
        initProductSearchIn();
    });
</script>

<!-- Medicine Detail Modal -->
<div class="modal fade" id="medicineDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết thuốc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-5 text-center">
                        <img id="detailImage" style="max-height: 300px; width: auto; max-width: 100%;" />
                        <div id="noImageMessage">
                            <i class="ri-image-line" style="font-size: 48px; color: #6c757d;"></i>
                            <p class="text-muted">Không có hình ảnh</p>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <h4 id="detailMedicineName"></h4>
                        <p><strong>Mã thuốc:</strong> <span id="detailMedicineCode"></span></p>
                        <p><strong>Danh mục:</strong> <span id="detailCategory"></span></p>
                        <p><strong>Số lượng tồn:</strong> <span id="detailStock"></span></p>
                        <p><strong>Đơn giá:</strong> <span id="detailPrice"></span></p>
                        <p><strong>Đơn vị:</strong> <span id="detailUnit"></span></p>
                        <p><strong>Hạn sử dụng:</strong> <span id="detailExpiry"></span></p>
                        <p><strong>Nhà sản xuất:</strong> <span id="detailManufacturer"></span></p>
                        <p><strong>Nhãn:</strong> <span id="detailLabel"></span></p>
                        <p><strong>Mô tả:</strong> <span id="detailDescription"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>
