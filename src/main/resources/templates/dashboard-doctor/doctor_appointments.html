<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Appointments Management - KiviCare</title>

    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 80px;
        }

        .appointments-header {
            background: var(--bs-primary);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .filter-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .appointment-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-confirmed {
            background: var(--bs-success);
            color: white;
        }

        .status-pending {
            background: var(--bs-warning);
            color: white;
        }

        .status-cancelled {
            background: var(--bs-danger);
            color: white;
        }

        .status-completed {
            background: var(--bs-info);
            color: white;
        }

        .time-slot {
            background: var(--bs-primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 500;
            display: inline-block;
        }

        .patient-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f8f9fa;
        }

        /* Enhanced Bootstrap button hover effects */
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            filter: brightness(110%);
        }

        .btn:active {
            transform: translateY(0);
        }


        .input-group.search-box {
            border: 2px solid #e9ecef;
            border-radius: 0;
            box-shadow: none;
            transition: border-color 0.3s;
            background: #fff;
        }

        .input-group.search-box:focus-within {
            border-color: #667eea;
            box-shadow: none;
        }

        .input-group.search-box .input-group-text {
            border: none;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
            padding-right: 0.5rem;
            position: relative;
        }

        .input-group.search-box .input-group-text::after {
            content: "";
            display: inline-block;
            width: 1px;
            height: 26px;
            background: #e9ecef;
            margin-left: 0.5rem;
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
        }

        .input-group.search-box .form-control {
            border: none;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
        }

        .input-group.search-box .form-control:focus {
            box-shadow: none;
            outline: none;
        }

        .filter-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
        }

        .appointments-stats {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .pagination {
            justify-content: center;
        }

        .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: none;
            color: #667eea;
        }

        .page-link:hover {
            background-color: #667eea;
            color: white;
        }

        .page-item.active .page-link {
            background-color: #667eea;
            border-color: #667eea;
        }
    </style>
</head>

<body>
<div class="card filter-card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="input-group search-box">
            <span class="input-group-text bg-transparent border-end-0">
                <i class="fas fa-search text-muted"></i>
            </span>
                    <input type="text" class="form-control border-start-0"
                           placeholder="Search patients..." id="searchInput">
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select filter-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="CONFIRMED">Confirmed</option>
                    <option value="PENDING">Pending</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select filter-select" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="tomorrow">Tomorrow</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Day</option>
                </select>
            </div>
            <div class="col-md-2" id="customDateCol" style="display:none;">
                <input type="date" class="form-control filter-select" id="specificDate">
            </div>
            <div class="col-md-2">
                <select class="form-select filter-select" id="sortTime">
                    <option value="asc">Sort by Time ↑</option>
                    <option value="desc">Sort by Time ↓</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-outline-secondary " onclick="resetFilters()">
                    <i class="fas fa-redo me-2"></i>Reset
                </button>
            </div>
            <div class="col-md-2">
                <select class="form-select filter-select" id="itemsPerPageSelect">
                    <option value="8">8 / page</option>
                    <option value="16">16 / page</option>
                    <option value="32">32 / page</option>
                    <option value="64">64 / page</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Appointments List -->
<div class="row" id="appointmentsList">
    <!-- Appointments will be dynamically loaded here -->
</div>

<!-- Empty State -->
<div class="empty-state" id="emptyState" style="display: none;">
    <i class="fas fa-calendar-times fa-4x mb-3"></i>
    <h4>No Appointments Found</h4>
    <p>There are no appointments matching your search criteria.</p>
</div>

<!-- Pagination -->
<nav aria-label="Appointments pagination" id="paginationContainer" style="display: none;">
    <ul class="pagination" id="pagination">
        <!-- Pagination items will be dynamically generated -->
    </ul>
</nav>
</div>

<!-- New Appointment Modal -->
<div class="modal fade" id="newAppointmentModal" tabindex="-1" aria-labelledby="newAppointmentModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newAppointmentModalLabel">
                    <i class="fas fa-plus me-2"></i>Schedule New Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newAppointmentForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="patientName" class="form-label">Patient Name</label>
                            <input type="text" class="form-control" id="patientName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="appointmentDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="appointmentDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appointmentTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="appointmentTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="duration" class="form-label">Duration (minutes)</label>
                            <select class="form-select" id="duration" required>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">60 minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="service" class="form-label">Service</label>
                        <select class="form-select" id="service" required>
                            <option value="">Select Service</option>
                            <option value="general">General Consultation</option>
                            <option value="checkup">Health Checkup</option>
                            <option value="followup">Follow-up</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" rows="3"
                                  placeholder="Additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scheduleAppointment()">Schedule
                    Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="fas fa-check-circle text-success me-2"></i>Appointment Confirmed
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                <h4>Appointment Successfully Confirmed!</h4>
                <p>You can now start the examination.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success " id="startExaminationBtn">
                    <i class="fas fa-stethoscope me-2"></i>Start Examination
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script th:src="@{/dashboard-doctor/assets/js/core/libs.min.js}"></script>
<script th:src="@{/dashboard-doctor/assets/js/core/external.min.js}"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const doctor_id = [[${doctor.id}]];
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 6; // mặc định

        // Lưu trạng thái filter/search
        let currentSearch = '';
        let currentStatus = '';
        let currentDateFilter = '';
        let currentSpecificDate = '';

        // Lắng nghe thay đổi số phần tử/trang
        document.getElementById('itemsPerPageSelect').addEventListener('change', function (e) {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            fetchAppointments(currentPage);
        });

        function fetchAppointments(page = 1) {
            const params = new URLSearchParams({
                page: page - 1,
                size: itemsPerPage,
                search: currentSearch,
                status: currentStatus,
                dateFilter: currentDateFilter,
                specificDate: currentSpecificDate
            });

            fetch(`/api/appointments/${doctor_id}?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error("Failed to fetch appointments");
                    return response.json();
                })
                .then(data => {
                    displayAppointments(data.content);
                    updatePagination(data.totalPages, page);
                    totalPages = data.totalPages;
                })
                .catch(error => {
                    console.error("Error loading appointments:", error);
                });
        }

        function displayAppointments(appointments) {
            const appointmentsList = document.getElementById("appointmentsList");
            const emptyState = document.getElementById("emptyState");

            if (!appointments || appointments.length === 0) {
                appointmentsList.innerHTML = "";
                emptyState.style.display = "block";
                return;
            }
            emptyState.style.display = "none";
            appointmentsList.innerHTML = appointments.map(appointment => createAppointmentCard(appointment)).join("");
        }

        function createAppointmentCard(appointment) {
            const statusBadgeClass = getStatusBadgeClass(appointment.appointmentStatus);
            const actionButtons = getActionButtons(appointment);

            return `
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card appointment-card" data-appointment-id="${appointment.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <img src="${appointment.patientEntityAvatarUrl || 'https://via.placeholder.com/50x50/667eea/white?text=U'}"
                                 alt="Patient" class="patient-avatar me-3">
                            <div>
                                <h6 class="mb-1 fw-bold">${appointment.patientEntityName}</h6>
                            </div>
                        </div>
                        <span class="status-badge ${statusBadgeClass}">${appointment.appointmentStatus}</span>
                    </div>

                    <div class="row mb-3">
    <div class="col-12 mb-2">
        <span class="time-slot">
            <i class="fas fa-clock me-1"></i>
            ${formatDateTime(appointment.startTime)} (${appointment.durationMinutes}min)
        </span>
    </div>

    <div class="col-12 mb-2">
        <div class="d-flex align-items-center text-muted">
            <i class="fas fa-phone me-2"></i>
            <span>${appointment.patientEntityPhoneNumber}</span>
        </div>
    </div>

    <div class="col-12 mb-2">
        <div class="d-flex align-items-center text-muted">
            <i class="fas fa-stethoscope me-2"></i>
            <span>${appointment.serviceEntityProductEntityName}</span>
        </div>
    </div>

    <div class="col-12 mb-2">
        <div class="d-flex align-items-center text-muted">
            <i class="fas fa-user-tie me-2"></i>
            <span>Coordinator: ${appointment.schedulingCoordinatorEntityName}</span>
        </div>
    </div>
</div>



                    <div class="d-flex gap-2">
                        ${actionButtons}
                    </div>
                </div>
            </div>
        </div>
    `;
        }

// Helper to format timestamp (adjust as needed)
        function formatDateTime(ts) {
            if (!ts) return '';
            const date = new Date(ts);
            return date.toLocaleString();
        }

        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'confirmed':
                    return 'status-confirmed';
                case 'pending':
                    return 'status-pending';
                case 'completed':
                    return 'status-completed';
                case 'cancelled':
                    return 'status-cancelled';
                default:
                    return 'status-pending';
            }
        }

        function getActionButtons(appointment) {
            switch (appointment.appointmentStatus.toLowerCase()) {
                case 'confirmed':
                    return `<button class="btn btn-warning  flex-fill" onclick="startExamination(${appointment.id})">
                                    <i class="fas fa-stethoscope me-2"></i>Start Exam
                                </button>`;
                case 'pending':
                    return `<button class="btn btn-success  me-2" onclick="confirmAppointment(${appointment.id})">
                                    <i class="fas fa-check me-2"></i>Confirm
                                </button>
                                <button class="btn btn-danger " onclick="rejectAppointment(${appointment.id})">
                                    <i class="fas fa-times me-2"></i>Reject
                                </button>`;
                case 'completed':
                    return `<button class="btn btn-info  flex-fill" onclick="viewResults(${appointment.id})">
                                    <i class="fas fa-eye me-2"></i>View Results
                                </button>`;
                default:
                    return `<span class="text-muted"><i class="fas fa-ban me-2"></i>No actions available</span>`;
            }
        }

        function updateStats() {
            const confirmed = allAppointments.filter(a => a.appointmentStatus === 'Confirmed').length;
            const pending = allAppointments.filter(a => a.appointmentStatus === 'Pending').length;
            const completed = allAppointments.filter(a => a.appointmentStatus === 'Completed').length;

            document.querySelector('.stat-number').textContent = allAppointments.length;
            document.querySelectorAll('.stat-number')[1].textContent = confirmed;
            document.querySelectorAll('.stat-number')[2].textContent = pending;
            document.querySelectorAll('.stat-number')[3].textContent = completed;
        }

        function updatePagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById("paginationContainer");
            const pagination = document.getElementById("pagination");
            if (totalPages <= 1) {
                paginationContainer.style.display = "none";
                return;
            }
            paginationContainer.style.display = "block";
            let paginationHTML = "";
            paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>
        `;
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
            }
            paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>
        `;
            pagination.innerHTML = paginationHTML;
        }

        window.changePage = function (page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                fetchAppointments(currentPage);
            }
        };


        window.confirmAppointment = function (id) {
            if (confirm('Are you sure you want to confirm this appointment?')) {
                // Update appointment status
                const appointment = allAppointments.find(a => a.id === id);
                if (appointment) {
                    appointment.appointmentStatus = 'Confirmed';

                    // Show confirmation modal
                    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                    modal.show();

                    document.getElementById('startExaminationBtn').onclick = function () {
                        modal.hide();
                        startExamination(id);
                    };

                    // Refresh display
                    displayAppointments();
                    updateStats();
                }
            }
        };

        window.rejectAppointment = function (id) {
            if (confirm('Are you sure you want to reject this appointment?')) {
                const appointment = allAppointments.find(a => a.id === id);
                if (appointment) {
                    appointment.appointmentStatus = 'Cancelled';
                    displayAppointments();
                    updateStats();
                }
            }
        };

        window.startExamination = function (id) {
            window.location.href = `/staff/doctor/in-progress?id=${id}`;
        };

        window.viewResults = function (id) {
            window.location.href = `staff/doctor/results?id=${id}`;
        };


        document.getElementById('searchInput').addEventListener('input', function (e) {
            currentSearch = e.target.value.trim();
            currentPage = 1;
            fetchAppointments(currentPage);
        });

        // Status filter
        document.getElementById('statusFilter').addEventListener('change', function (e) {
            currentStatus = e.target.value;
            currentPage = 1;
            fetchAppointments(currentPage);
        });

        // Date filter
        document.getElementById('dateFilter').addEventListener('change', function (e) {
            currentDateFilter = e.target.value;
            currentPage = 1;
            fetchAppointments(currentPage);
        });

        // Specific date
        document.getElementById('specificDate').addEventListener('change', function (e) {
            currentSpecificDate = e.target.value;
            currentPage = 1;
            fetchAppointments(currentPage);
        });

        // Reset filters
        window.resetFilters = function () {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('specificDate').value = '';
            currentSearch = '';
            currentStatus = '';
            currentDateFilter = '';
            currentSpecificDate = '';
            currentPage = 1;
            fetchAppointments(currentPage);
        };

        // Initial load
        fetchAppointments(currentPage);
    });
</script>
</body>

</html>