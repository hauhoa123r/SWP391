<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đăng ký tài khoản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
        }

        .auth-card {
            max-width: 700px;
            margin: 5% auto;
            padding: 2rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);
        }

        .logo-img img {
            max-width: 120px;
            height: auto;
        }

        .form-label span {
            color: red;
        }

        .text-danger {
            font-size: 0.875em;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="auth-card">
        <div class="logo-img text-center mb-4">
            <img alt="logo" onclick="window.location.href='/'" src="/assets/images/logo/logo.png">
        </div>

        <h4 class="text-center mb-4">Đăng ký tài khoản</h4>
        <form id="register-form" th:object="${userRegisterDTO}">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email <span>*</span></label>
                    <input class="form-control" placeholder="Nhập email" th:field="*{email}" type="email">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Số điện thoại <span>*</span></label>
                    <input class="form-control" placeholder="Nhập số điện thoại" th:field="*{phoneNumber}" type="text">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Mật khẩu <span>*</span></label>
                    <input class="form-control"
                           id="password"
                           name="password"
                           oninput="validatePassword(this)"
                           pattern="^[a-zA-Z0-9]{6,}$"
                           placeholder="Nhập mật khẩu"
                           required
                           type="password">
                    <small class="form-text text-danger" id="strength-text"></small>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Họ và tên <span>*</span></label>
                    <input class="form-control" placeholder="Nhập họ và tên" th:field="*{patientEntityFullName}"
                           type="text">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Địa chỉ <span>*</span></label>
                    <input class="form-control" placeholder="Nhập địa chỉ" th:field="*{patientEntityAddress}"
                           type="text">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Ngày sinh <span>*</span></label>
                    <input class="form-control" th:attr="max=${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                           th:field="*{patientEntityBirthdate}"
                           type="date"/>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Giới tính <span>*</span></label>
                    <select class="form-select" th:field="*{patientEntityGender}">
                        <option disabled selected value="">Chọn giới tính</option>
                        <option value="MALE">Nam</option>
                        <option value="FEMALE">Nữ</option>
                        <option value="OTHER">Khác</option>
                    </select>
                </div>
                <div class="d-grid mb-3">
                    <button class="btn btn-success" type="submit">Đăng ký</button>
                </div>
            </div>
        </form>

        <div class="text-center mt-3">
            <a th:href="@{/login}">Đã có tài khoản? Đăng nhập</a>
        </div>
    </div>
</div>
<script>

    function validatePassword(input) {
        const value = input.value;
        const regex = /^[a-zA-Z0-9]{6,}$/;
        const msg = document.getElementById("strength-text");
        if (value.length === 0) {
            input.style.borderColor = "";
            msg.innerText = "";
        } else if (!regex.test(value)) {
            input.style.borderColor = "red";
            msg.innerText = "Mật khẩu phải từ 6 ký tự trở lên và chỉ gồm chữ, số";
        } else {
            input.style.borderColor = "#198754";
            msg.innerText = "Mật khẩu hợp lệ";
            msg.classList.remove("text-danger");
            msg.classList.add("text-success");
        }
    }
</script>
<script th:inline="javascript" type="module">

    import toast from "/templates/shared/assets/js/plugins/toast.js";
    import {FetchingUtils} from "/templates/shared/assets/js/utils/fetching-utils.js";
    import {FormDataUtils} from "/templates/shared/assets/js/utils/form-data.js";

    document.getElementById("register-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.disabled = true;

        // Lấy dữ liệu từ các input
        const data = FormDataUtils.getObjectFromFormData(null, new FormData(form));
        console.log(data);

        const res = await FetchingUtils.fetch("/api/register", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        }, "text");

        if (res !== null) {
            toast.success("Đăng ký thành công! Vui lòng kiểm tra email hoặc đăng nhập.", {
                duration: 3000,
                icon: true,
                progress: true
            });
            setTimeout(() => window.location.href = "/login", 1000);
        }
        submitBtn.disabled = false;
    });
</script>
</body>
</html>
