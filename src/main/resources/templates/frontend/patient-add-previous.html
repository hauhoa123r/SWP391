<!doctype html>
<html class="landing-pages" data-bs-theme="light" dir="ltr" lang="vi">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Thêm Bệnh Nhân Mới - KiviCare | Phòng Khám & Quản Lý Bệnh Nhân</title>
    <link href="../frontend/assets/images/favicon.ico" rel="shortcut icon" />
    <link href="../frontend/assets/css/core/libs.min.css" rel="stylesheet" />
    <link href="../frontend/assets/vendor/flaticon/css/flaticon.css" rel="stylesheet" />
    <link href="../frontend/assets/vendor/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="../frontend/assets/vendor/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <link href="../frontend/assets/css/kivicare.min.css?v=1.4.1" rel="stylesheet" />
    <link href="../frontend/assets/css/custom.min.css?v=1.4.1" rel="stylesheet" />
    <link href="../frontend/assets/css/rtl.min.css?v=1.4.1" rel="stylesheet" />
    <link href="../frontend/assets/css/customizer.min.css?v=1.4.1" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link
            href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500&display=swap"
            rel="stylesheet" />
    <style>
        body {
            min-height: 100vh;
            font-family: 'Heebo', sans-serif;
        }

        .patient-add-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }

        .patient-add-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .patient-add-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            z-index: 1;
        }

        .patient-add-header .content {
            position: relative;
            z-index: 2;
        }

        .profile-upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .profile-upload-section:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .profile-img-edit {
            position: relative;
            margin: 0 auto 1.5rem;
            width: 150px;
            height: 150px;
        }

        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .profile-pic:hover {
            transform: scale(1.05);
        }

        .upload-icone {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .upload-icone:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .form-section {
            padding: 2rem;
        }

        .form-floating {
            margin-bottom: 1.5rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-2px);
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 1rem 3rem;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            color: white;
        }

        .social-input {
            position: relative;
        }

        .social-input .form-control {
            padding-left: 3rem;
        }

        .social-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 10;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 2rem 0;
            border: none;
        }

        .success-animation {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #28a745;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease-in-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .col-md-6 {
                width: 49%;
            }
        }
    </style>
</head>

<body class="body-bg landing-pages">
<div th:replace="frontend/fragments/header :: header"></div>
<span class="screen-darken"></span>
<!-- loader Start -->
<div id="loading">
    <div class="loader simple-loader">
        <div class="loader-body">
            <img alt="loader" class="light-loader img-fluid" src="../frontend/assets/images/loader.gif" width="200">
        </div>
    </div>
</div>
<!-- loader END -->
<main class="main-content">
    <div class="container-fluid">
        <div class="patient-add-container">
            <!-- Header Section -->
            <div class="patient-add-header">
                <div class="content">
                    <h1 class="mb-3">
                        <i class="fas fa-user-plus me-3"></i>
                        Thêm Bệnh Nhân Mới
                    </h1>
                    <p class="mb-0 opacity-90">Hoàn tất đăng ký bệnh nhân với thông tin y tế</p>
                </div>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator mt-4">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
            </div>

            <!-- Start Form -->
            <form id="patientForm">
                <!-- Avatar input file & hidden (dùng chung cho cả 2 step) -->
                <input accept="image/*" class="file-upload" id="avatarUpload" type="file" style="display:none;">
                <input id="avatarBase64" name="avatarBase64" type="hidden" value="">
                <div id="fileError" class="text-danger small mb-2"></div>
                <!-- Step 1: Profile & Basic Info -->
                <div class="form-step active" id="formStep1">
                    <div class="row">
                        <!-- Profile Upload Section (Step 1) -->
                        <div class="col-lg-4">
                            <div class="profile-upload-section">
                                <h5 class="text-center mb-4">
                                    <i class="fas fa-camera me-2"></i>
                                    Ảnh Bệnh Nhân
                                </h5>
                                <div class="profile-img-edit">
                                    <img alt="profile-pic" class="profile-pic" id="profilePreview1"
                                         src="../frontend/assets/images/01.png">
                                    <div class="upload-icone" id="uploadIcone1">
                                        <svg class="upload-button icon-20" height="20" viewBox="0 0 24 24"
                                             width="20">
                                            <path
                                                    d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"
                                                    fill="#ffffff" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="img-extension text-center">
                                    <small class="text-muted">
                                        Chỉ chấp nhận <strong>.jpg</strong>, <strong>.png</strong>, <strong>.jpeg</strong>
                                    </small>
                                </div>
                            </div>
                            <!-- Quick Stats Step 1 -->
                            <div class="mt-4 p-3 bg-light rounded-3">
                                <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Tiến Độ Đăng Ký</h6>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-gradient" id="progressBar1" role="progressbar"
                                         style="width: 50%"></div>
                                </div>
                                <small class="text-muted" id="progressText1">Hoàn thành bước 1/2</small>
                            </div>
                        </div>
                        <!-- Basic Information Form -->
                        <div class="col-lg-8">
                            <h5 class="mb-4">
                                <i class="fas fa-user me-2"></i>
                                Thông Tin Cơ Bản
                            </h5>
                            <input name="userId" type="hidden" value="1">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input class="form-control" id="fullName" name="fullName"
                                               placeholder="Nhập họ tên" required type="text">
                                        <label for="fullName"><i class="fas fa-user me-2"></i>Họ và Tên</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input class="form-control" id="email" name="email"
                                               placeholder="Nhập email" required type="email">
                                        <label for="email"><i class="fas fa-envelope me-2"></i>Địa chỉ Email</label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input class="form-control" id="phoneNumber" name="phoneNumber"
                                               placeholder="Nhập số điện thoại" required type="tel">
                                        <label for="phoneNumber"><i class="fas fa-phone me-2"></i>Số Điện Thoại</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input class="form-control" id="dateOfBirth" name="dateOfBirth" required
                                               type="date">
                                        <label for="dateOfBirth"><i class="fas fa-calendar me-2"></i>Ngày Sinh</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="gender" name="gender" required>
                                            <option value="">Chọn Giới Tính</option>
                                            <option value="male">Nam</option>
                                            <option value="female">Nữ</option>
                                            <option value="other">Khác</option>
                                        </select>
                                        <label for="gender"><i class="fas fa-venus-mars me-2"></i>Giới Tính</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input class="form-control" id="identificationNumber"
                                               name="identificationNumber" placeholder="Nhập số định danh"
                                               required type="text">
                                        <label for="identificationNumber"><i
                                                class="fas fa-user me-2"></i>Số Định Danh</label>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-floating">
                                        <input class="form-control" id="address" name="address"
                                               placeholder="Nhập địa chỉ" required type="text">
                                        <label for="address"><i
                                                class="fas fa-map-marker-alt me-2"></i>Địa Chỉ</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="familyRelationship"
                                                name="familyRelationship" required>
                                            <option value="">Chọn Mối Quan Hệ</option>
                                            <option value="self">Bản thân</option>
                                            <option value="wife">Vợ</option>
                                            <option value="father">Cha</option>
                                            <option value="mother">Mẹ</option>
                                            <option value="brother">Anh trai</option>
                                            <option value="sister">Chị gái</option>
                                            <option value="son">Con trai</option>
                                            <option value="daughter">Con gái</option>
                                            <option value="grandfather">Ông</option>
                                            <option value="grandmother">Bà</option>
                                            <option value="cousin">Anh/chị em họ</option>
                                            <option value="aunt">Cô/dì</option>
                                            <option value="uncle">Chú/bác</option>
                                            <option value="other">Khác</option>
                                        </select>
                                        <label for="familyRelationship"><i class="fas fa-users me-2"></i>Mối Quan Hệ Gia Đình</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="bloodType" name="bloodType" required>
                                            <option value="">Chọn Nhóm Máu</option>
                                            <option value="A_POSITIVE">A+</option>
                                            <option value="A_NEGATIVE">A-</option>
                                            <option value="B_POSITIVE">B+</option>
                                            <option value="B_NEGATIVE">B-</option>
                                            <option value="AB_POSITIVE">AB+</option>
                                            <option value="AB_NEGATIVE">AB-</option>
                                            <option value="O_POSITIVE">O+</option>
                                            <option value="O_NEGATIVE">O-</option>
                                        </select>
                                        <label for="bloodType"><i class="fas fa-tint me-2"></i>Nhóm Máu</label>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button class="btn btn-primary" onclick="nextStep()" type="button" id="nextBtn">
                                    Bước Tiếp Theo <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Step 1 -->

                <!-- Step 2: Profile Upload + Allergies and Chronic Diseases -->
                <div class="form-step" id="formStep2" style="display: none;">
                    <div class="row">
                        <!-- Profile Upload Section (Step 2) -->
                        <div class="col-lg-4">
                            <div class="profile-upload-section">
                                <h5 class="text-center mb-4">
                                    <i class="fas fa-camera me-2"></i>
                                    Ảnh Bệnh Nhân
                                </h5>
                                <div class="profile-img-edit">
                                    <img alt="profile-pic" class="profile-pic" id="profilePreview2"
                                         src="../frontend/assets/images/01.png">
                                    <div class="upload-icone" id="uploadIcone2">
                                        <svg class="upload-button icon-20" height="20" viewBox="0 0 24 24"
                                             width="20">
                                            <path
                                                    d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"
                                                    fill="#ffffff" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="img-extension text-center">
                                    <small class="text-muted">
                                        Chỉ chấp nhận <strong>.jpg</strong>, <strong>.png</strong>, <strong>.jpeg</strong>
                                    </small>
                                </div>
                            </div>
                            <!-- Quick Stats Step 2 -->
                            <div class="mt-4 p-3 bg-light rounded-3">
                                <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Tiến Độ Đăng Ký</h6>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-gradient" id="progressBar2" role="progressbar"
                                         style="width: 100%"></div>
                                </div>
                                <small class="text-muted" id="progressText2">Hoàn thành bước 2/2</small>
                            </div>
                        </div>
                        <!-- Allergies and Chronic Diseases -->
                        <div class="col-lg-8">
                            <h5 class="mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Thông Tin Bổ Sung
                            </h5>
                            <div class="two-col-grid">
                                <!-- Allergies Column -->
                                <div>
                                    <h6 class="mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Dị Ứng</h6>
                                    <div id="allergiesContainer">
                                        <div class="form-floating mb-2">
                                            <input class="form-control dynamic-input" id="allergyInput1"
                                                   name="allergies[]" placeholder="Nhập dị ứng" type="text">
                                            <label for="allergyInput1">1. Nhập dị ứng</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Chronic Diseases Column -->
                                <div>
                                    <h6 class="mb-3"><i class="fas fa-notes-medical me-2"></i>Bệnh Mãn Tính</h6>
                                    <div id="chronicContainer">
                                        <div class="form-floating mb-2">
                                            <input class="form-control dynamic-input" id="chronicInput1"
                                                   name="chronicDiseases[]" placeholder="Nhập bệnh mãn tính"
                                                   type="text">
                                            <label for="chronicInput1">1. Nhập bệnh mãn tính</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr class="section-divider">
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-outline-secondary" onclick="prevStep()" type="button" id="prevBtn">
                                    <i class="fas fa-arrow-left me-2"></i> Quay Lại
                                </button>
                                <button class="btn btn-submit" id="submitBtn" type="submit">
                                    <i class="fas fa-user-plus me-2"></i> Đăng Ký Bệnh Nhân
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Step 2 -->
            </form>
            <!-- End Form -->

            <!-- Success Animation -->
            <div class="success-animation" id="successAnimation">
                <div class="checkmark">
                    <i class="fas fa-check fa-2x text-white"></i>
                </div>
                <h4 class="text-success mb-3">Đăng ký bệnh nhân thành công!</h4>
                <p class="text-muted mb-4">
                    Bệnh nhân đã được thêm vào hệ thống và có thể đặt lịch hẹn.
                </p>
                <div class="d-flex gap-3 justify-content-center">
                    <button class="btn btn-primary" onclick="resetForm()" type="button">
                        <i class="fas fa-plus me-2"></i> Thêm Bệnh Nhân Khác
                    </button>
                    <button class="btn btn-outline-primary" onclick="viewPatients()" type="button">
                        <i class="fas fa-list me-2"></i> Xem Tất Cả Bệnh Nhân
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="frontend/fragments/footer :: footer"></div>
<script>
    // Bắt mọi lỗi JS để debug
    window.onerror = function (message, source, lineno, colno, error) {
        console.error('Global error:', message, 'at', source + ':' + lineno + ':' + colno);
        showErrorMessage('Đã có lỗi xảy ra, vui lòng thử lại.');
        return true;
    };

    document.addEventListener('DOMContentLoaded', () => {
        // === BIẾN CHUNG ===
        let currentStep = 1, totalSteps = 2, allergyCount = 1, chronicCount = 1;

        // === AVATAR PREVIEW ===
        const avatarInput = document.getElementById('avatarUpload');
        const preview1 = document.getElementById('profilePreview1');
        const preview2 = document.getElementById('profilePreview2');
        const uploadIcone1 = document.getElementById('uploadIcone1');
        const uploadIcone2 = document.getElementById('uploadIcone2');
        const avatarBase64 = document.getElementById('avatarBase64');
        const fileError = document.getElementById('fileError');

        // Click vào ảnh hoặc icon ở step nào cũng mở input file
        if (preview1) preview1.style.cursor = 'pointer';
        if (preview2) preview2.style.cursor = 'pointer';
        if (preview1 && avatarInput) preview1.addEventListener('click', function () { avatarInput.click(); });
        if (preview2 && avatarInput) preview2.addEventListener('click', function () { avatarInput.click(); });
        if (uploadIcone1 && avatarInput) uploadIcone1.addEventListener('click', function (e) { if (e.target !== avatarInput) avatarInput.click(); });
        if (uploadIcone2 && avatarInput) uploadIcone2.addEventListener('click', function (e) { if (e.target !== avatarInput) avatarInput.click(); });

        avatarInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            fileError.textContent = '';
            if (!file) return;
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                fileError.textContent = 'Chỉ chấp nhận file JPG, PNG, JPEG.';
                avatarInput.value = '';
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                fileError.textContent = 'Kích thước file phải nhỏ hơn 5MB.';
                avatarInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function (evt) {
                if (preview1) preview1.src = evt.target.result;
                if (preview2) preview2.src = evt.target.result;
                if (avatarBase64) avatarBase64.value = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        // === VALIDATION ===
        function showFieldError(f, msg) {
            hideFieldError(f);
            const d = document.createElement('div');
            d.className = 'invalid-feedback d-block'; d.textContent = msg;
            f.after(d);
        }
        function hideFieldError(f) {
            const nxt = f.nextElementSibling;
            if (nxt?.classList.contains('invalid-feedback')) nxt.remove();
        }
        function validateField(f) {
            try {
                let ok = true, v = f.value.trim();
                const addErr = m => { showFieldError(f, m); f.classList.add('is-invalid'); ok = false; };
                const clearErr = () => { hideFieldError(f); f.classList.remove('is-invalid'); };
                switch (f.id) {
                    case 'fullName':
                        if (!/^[A-Za-zÀ-ỹ ]+$/.test(v) || /\s{2,}/.test(f.value) || v !== f.value)
                            addErr('Họ tên không chứa ký tự đặc biệt hoặc khoảng trắng thừa.');
                        else clearErr();
                        break;
                    case 'email':
                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) addErr('Email không hợp lệ.');
                        else clearErr();
                        break;
                    case 'phoneNumber':
                        if (!/^\d{10}$/.test(v)) addErr('SĐT đúng 10 chữ số.');
                        else clearErr();
                        break;
                    case 'dateOfBirth':
                        if (!v) addErr('Chọn ngày sinh.');
                        else if (new Date(v) > new Date(new Date().toDateString())) addErr('Ngày sinh không được ở tương lai.');
                        else clearErr();
                        break;
                    case 'identificationNumber':
                        const cmnd = /^\d{9}$/;
                        const cccd = /^\d{12}$/;
                        const passport = /^[A-Z0-9]{6,20}$/i;
                        if (!cmnd.test(v) && !cccd.test(v) && !passport.test(v))
                            addErr('Mã định danh không hợp lệ (CMND/CCCD 9–12 số hoặc hộ chiếu từ 6–20 ký tự chữ/số).');
                        else clearErr();
                        break;
                    default:
                        if (f.hasAttribute('required') && !v) addErr('Không được để trống.');
                        else clearErr();
                }
                return ok;
            } catch (error) {
                console.error("Validation error:", error);
                showErrorMessage("Lỗi xác thực dữ liệu");
                return false;
            }
        }
        // Realtime
        ['fullName', 'email', 'phoneNumber', 'dateOfBirth', 'gender', 'address', 'familyRelationship', 'bloodType']
            .forEach(id => {
                const f = document.getElementById(id);
                if (!f) return;
                ['input', 'change'].forEach(evt => f.addEventListener(evt, () => validateField(f)));
            });

        // === DYNAMIC INPUTS (STEP 2) ===
        function addDynamic(container, type, label) {
            const last = container.querySelector('input.dynamic-input:last-of-type');
            if (!last || !last.value.trim()) return;
            const idx = container.querySelectorAll('input.dynamic-input').length + 1;
            const wrap = document.createElement('div');
            wrap.className = 'form-floating mt-2';
            wrap.innerHTML = `
        <input type="text" class="form-control dynamic-input"
               id="${type}${idx}" name="${type}[]" placeholder="${label} ${idx}">
        <label for="${type}${idx}">${idx}. ${label}</label>`;
            container.append(wrap);
        }
        ['allergiesContainer', 'chronicContainer'].forEach(id => {
            const cont = document.getElementById(id);
            if (!cont) return;
            const type = id === 'allergiesContainer' ? 'allergies' : 'chronicDiseases';
            const label = id === 'allergiesContainer' ? 'Dị ứng' : 'Bệnh mãn tính';
            cont.addEventListener('input', e => {
                if (!e.target.classList.contains('dynamic-input')) return;
                validateField(e.target);
                addDynamic(cont, type, label);
            });
            cont.addEventListener('blur', e => {
                if (e.target.classList.contains('dynamic-input') && !e.target.value.trim()
                    && cont.querySelectorAll('input.dynamic-input').length > 1) {
                    e.target.closest('.form-floating').remove();
                }
            }, true);
        });

        // === MULTI-STEP FORM ===
        function showStep() {
            for (let i = 1; i <= totalSteps; i++) {
                const s = document.getElementById(`formStep${i}`);
                if (!s) continue;
                s.style.display = (i === currentStep ? 'block' : 'none');
            }
            // Step indicator
            for (let i = 1; i <= totalSteps; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (!stepEl) continue;
                stepEl.classList.remove('active', 'completed');
                if (i < currentStep) stepEl.classList.add('completed');
                else if (i === currentStep) stepEl.classList.add('active');
            }
            // Progress bar
            const pb1 = document.getElementById('progressBar1');
            const pb2 = document.getElementById('progressBar2');
            const pt1 = document.getElementById('progressText1');
            const pt2 = document.getElementById('progressText2');
            if (currentStep === 1) {
                if (pb1) pb1.style.width = '50%';
                if (pt1) pt1.textContent = 'Hoàn thành bước 1/2';
                if (pb2) pb2.style.width = '0%';
                if (pt2) pt2.textContent = '';
            } else if (currentStep === 2) {
                if (pb2) pb2.style.width = '100%';
                if (pt2) pt2.textContent = 'Hoàn thành bước 2/2';
                if (pb1) pb1.style.width = '100%';
                if (pt1) pt1.textContent = 'Hoàn thành bước 2/2';
            }
        }
        window.nextStep = function () {
            const valid = Array.from(document.querySelectorAll(`#formStep${currentStep} input, #formStep${currentStep} select`))
                .every(f => validateField(f));
            if (!valid) return;
            if (currentStep < totalSteps) { currentStep++; showStep(); }
        };
        window.prevStep = function () {
            if (currentStep > 1) { currentStep--; showStep(); }
        };
        showStep();

        // === SUBMIT FORM ===
        document.getElementById('patientForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            if (!validateCurrentStep()) return;

            try {
                await handleSubmit();
            } catch (error) {
                console.error("Submit error:", error);
            }
        });

        function validateCurrentStep() {
            return Array.from(
                document.querySelectorAll(`#formStep${currentStep} input, #formStep${currentStep} select`)
            ).every(f => {
                try {
                    return validateField(f);
                } catch (e) {
                    console.error(`Validation error for field ${f.id}:`, e);
                    return false;
                }
            });
        }

        async function handleSubmit() {
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi...';
            btn.disabled = true;
            // Build payload
            const patientDTO = {
                userId: null,
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                dateOfBirth: document.getElementById('dateOfBirth').value.trim(),
                gender: document.getElementById('gender').value,
                identificationNumber: document.getElementById('identificationNumber').value.trim(),
                address: document.getElementById('address').value.trim(),
                familyRelationship: document.getElementById('familyRelationship').value.trim(),
                bloodType: document.getElementById('bloodType').value.trim(),
                avatarBase64: document.getElementById('avatarBase64').value
            };
            const allergies = Array.from(document.getElementsByName('allergies[]'))
                .map(i => i.value.trim()).filter(v => v);
            const chronicDiseases = Array.from(document.getElementsByName('chronicDiseases[]'))
                .map(i => i.value.trim()).filter(v => v);
            const medicalProfileDTO = {
                patientId: null,
                allergies: allergies,
                chronicDiseases: chronicDiseases
            };
            const payload = {
                patientDTO: patientDTO,
                medicalProfileDTO: medicalProfileDTO
            };
            try {
                const res = await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    showSuccessAnimation();
                } else {
                    const err = await res.json().catch(() => null);
                    throw new Error(err?.message || `Lỗi ${res.status}`);
                }
            } catch (err) {
                console.error(err);
                showErrorMessage(err.message);
                btn.innerHTML = '<i class="fas fa-user-plus me-2"></i>Đăng ký bệnh nhân';
                btn.disabled = false;
            }
        }

        // === HELPER: LOẠI THÔNG BÁO ===
        function showErrorMessage(msg) {
            const a = document.createElement('div');
            a.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            a.style.cssText = 'top:20px;right:20px;z-index:1050;max-width:300px';
            a.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.append(a);
            setTimeout(() => a.remove(), 5000);
        }

        function showSuccessAnimation() {
            for (let i = 1; i <= totalSteps; i++) {
                const step = document.getElementById(`formStep${i}`);
                if (step) step.style.display = 'none';
            }
            const successAnimation = document.getElementById('successAnimation');
            if (successAnimation) {
                successAnimation.style.display = 'block';
            }
        }
        window.resetForm = function () {
            const form = document.getElementById('patientForm');
            if (form) form.reset();
            if (preview1) preview1.src = '../frontend/assets/images/01.png';
            if (preview2) preview2.src = '../frontend/assets/images/01.png';
            if (avatarBase64) avatarBase64.value = '';
            currentStep = 1;
            showStep();
            const successAnimation = document.getElementById('successAnimation');
            if (successAnimation) successAnimation.style.display = 'none';
        }
        window.viewPatients = function () {
            window.location.href = '/patient/showList/1';
        }
    }); // end DOMContentLoaded
</script>

<script src="../frontend/assets/js/core/libs.min.js"></script>
<script src="../frontend/assets/vendor/flatpickr/dist/flatpickr.min.js"></script>
<script defer src="../frontend/assets/js/plugins/flatpickr.js"></script>
<script src="../frontend/assets/js/plugins/slider-tabs.js"></script>
<script defer src="../frontend/assets/js/plugins/fslightbox.js"></script>
<script defer src="../frontend/assets/js/plugins/select2.js"></script>
<script src="../frontend/assets/vendor/lodash/lodash.min.js"></script>
<script src="../frontend/assets/js/iqonic-script/utility.min.js"></script>
<script src="../frontend/assets/js/iqonic-script/setting.min.js"></script>
<script src="../frontend/assets/js/setting-init.js"></script>
<script src="../frontend/assets/js/core/external.min.js"></script>
<script defer src="../frontend/assets/js/charts/widgetcharts.js?v=1.4.1"></script>
<script defer src="../frontend/assets/js/charts/dashboard.js?v=1.4.1"></script>
<script defer src="../frontend/assets/js/kivicare.js?v=1.4.1"></script>
<script defer src="../frontend/assets/js/kivicare-advance.js?v=1.4.1"></script>
<script defer src="../frontend/assets/js/sidebar.js"></script>
</body>
</html>