<!doctype html>
<html class="landing-pages" data-bs-theme="light" dir="ltr" lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Add New Patient - KiviCare | Medical Clinic & Patient Management</title>
    <link href="../frontend/assets/images/favicon.ico" rel="shortcut icon" />
    <link href="../frontend/assets/css/core/libs.min.css" rel="stylesheet" />
    <link href="../frontend/assets/vendor/flaticon/css/flaticon.css" rel="stylesheet" />
    <link href="../frontend/assets/vendor/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="../frontend/assets/vendor/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <link href="../frontend/assets/css/kivicare.min.css?v=1.4.1" rel="stylesheet" />
    <link href="../frontend/assets/css/custom.min.css?v=1.4.1" rel="stylesheet" />
    <link href="../frontend/assets/css/rtl.min.css?v=1.4.1" rel="stylesheet" />
    <link href="../frontend/assets/css/customizer.min.css?v=1.4.1" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500&display=swap"
        rel="stylesheet" />
    <style>
        body {
            min-height: 100vh;
            font-family: 'Heebo', sans-serif;
        }
        .patient-add-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }
        .patient-add-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }
        .patient-add-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            z-index: 1;
        }
        .patient-add-header .content {
            position: relative;
            z-index: 2;
        }
        .profile-upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        .profile-upload-section:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        .profile-img-edit {
            position: relative;
            margin: 0 auto 1.5rem;
            width: 150px;
            height: 150px;
        }
        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }
        .profile-pic:hover {
            transform: scale(1.05);
        }
        .upload-icone {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        .upload-icone:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }
        .form-section {
            padding: 2rem;
        }
        .form-floating {
            margin-bottom: 1.5rem;
        }
        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-2px);
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 1rem 3rem;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            color: white;
        }
        .social-input {
            position: relative;
        }
        .social-input .form-control {
            padding-left: 3rem;
        }
        .social-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 10;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 2rem 0;
            border: none;
        }
        .success-animation {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #28a745;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease-in-out;
        }
        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }
        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
    </style>
</head>

<body class="body-bg landing-pages">
    <div th:replace="frontend/fragments/header :: header"></div>
    <span class="screen-darken"></span>
    <!-- loader Start -->
    <div id="loading">
        <div class="loader simple-loader">
            <div class="loader-body">
                <img alt="loader" class="light-loader img-fluid" src="../frontend/assets/images/loader.gif" width="200">
            </div>
        </div>
    </div>
    <!-- loader END -->
    <main class="main-content">
        <div class="container-fluid">
            <div class="patient-add-container">
                <!-- Header Section -->
                <div class="patient-add-header">
                    <div class="content">
                        <h1 class="mb-3">
                            <i class="fas fa-user-plus me-3"></i>
                            Add New Patient
                        </h1>
                        <p class="mb-0 opacity-90">Complete patient registration with medical information</p>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator mt-4">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                </div>

                <!-- Start Form -->
                <form id="patientForm">
                    <!-- Avatar input file & hidden (dùng chung cho cả 2 step) -->
                    <input accept="image/*" class="file-upload" id="avatarUpload" type="file" style="display:none;">
                    <input id="avatarBase64" name="avatarBase64" type="hidden" value="">

                    <!-- Step 1: Profile & Basic Info -->
                    <div class="form-step active" id="formStep1">
                        <div class="row">
                            <!-- Profile Upload Section (Step 1) -->
                            <div class="col-lg-4">
                                <div class="profile-upload-section">
                                    <h5 class="text-center mb-4">
                                        <i class="fas fa-camera me-2"></i>
                                        Patient Photo
                                    </h5>
                                    <div class="profile-img-edit">
                                        <img alt="profile-pic" class="profile-pic" id="profilePreview1"
                                            src="../frontend/assets/images/01.png">
                                        <div class="upload-icone" id="uploadIcone1">
                                            <svg class="upload-button icon-20" height="20" viewBox="0 0 24 24"
                                                width="20">
                                                <path
                                                    d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"
                                                    fill="#ffffff" />
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="img-extension text-center">
                                        <small class="text-muted">
                                            Only <strong>.jpg</strong>, <strong>.png</strong>, <strong>.jpeg</strong>
                                            allowed
                                        </small>
                                    </div>
                                </div>
                                <!-- Quick Stats Step 1 -->
                                <div class="mt-4 p-3 bg-light rounded-3">
                                    <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Registration Progress</h6>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progressBar1" role="progressbar"
                                            style="width: 50%"></div>
                                    </div>
                                    <small class="text-muted" id="progressText1">Step 1 of 2 completed</small>
                                </div>
                            </div>
                            <!-- Basic Information Form -->
                            <div class="col-lg-8">
                                <h5 class="mb-4">
                                    <i class="fas fa-user me-2"></i>
                                    Basic Information
                                </h5>
                                <input name="userId" type="hidden" value="1">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="fullName" name="fullName"
                                                placeholder="Enter full name" required type="text">
                                            <label for="fullName"><i class="fas fa-user me-2"></i>Full Name</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="email" name="email"
                                                placeholder="Enter email" required type="email">
                                            <label for="email"><i class="fas fa-envelope me-2"></i>Email Address</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="phoneNumber" name="phoneNumber"
                                                placeholder="Enter phone number" required type="tel">
                                            <label for="phoneNumber"><i class="fas fa-phone me-2"></i>Phone
                                                Number</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="dateOfBirth" name="dateOfBirth" required
                                                type="date">
                                            <label for="dateOfBirth"><i class="fas fa-calendar me-2"></i>Date of
                                                Birth</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="gender" name="gender" required>
                                                <option value="">Select Gender</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <label for="gender"><i class="fas fa-venus-mars me-2"></i>Gender</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="address" name="address"
                                                placeholder="Enter address" required type="text">
                                            <label for="address"><i
                                                    class="fas fa-map-marker-alt me-2"></i>Address</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="familyRelationship"
                                                name="familyRelationship" required>
                                                <option value="">Select Relationship</option>
                                                <option value="self">Self</option>
                                                <option value="wife">Wife</option>
                                                <option value="father">Father</option>
                                                <option value="mother">Mother</option>
                                                <option value="brother">Brother</option>
                                                <option value="sister">Sister</option>
                                                <option value="son">Son</option>
                                                <option value="daughter">Daughter</option>
                                                <option value="grandfather">Grandfather</option>
                                                <option value="grandmother">Grandmother</option>
                                                <option value="cousin">Cousin</option>
                                                <option value="aunt">Aunt</option>
                                                <option value="uncle">Uncle</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <label for="familyRelationship"><i class="fas fa-users me-2"></i>Family
                                                Relationship</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="bloodType" name="bloodType" required>
                                                <option value="">Select Blood Type</option>
                                                <option value="A_POSITIVE">A+</option>
                                                <option value="A_NEGATIVE">A-</option>
                                                <option value="B_POSITIVE">B+</option>
                                                <option value="B_NEGATIVE">B-</option>
                                                <option value="AB_POSITIVE">AB+</option>
                                                <option value="AB_NEGATIVE">AB-</option>
                                                <option value="O_POSITIVE">O+</option>
                                                <option value="O_NAGATIVE">O-</option>
                                            </select>
                                            <label for="bloodType"><i class="fas fa-tint me-2"></i>Blood Type</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end mt-4">
                                    <button class="btn btn-primary" onclick="nextStep()" type="button">
                                        Next Step <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Step 1 -->

                    <!-- Step 2: Profile Upload + Allergies and Chronic Diseases -->
                    <div class="form-step" id="formStep2" style="display: none;">
                        <div class="row">
                            <!-- Profile Upload Section (Step 2) -->
                            <div class="col-lg-4">
                                <div class="profile-upload-section">
                                    <h5 class="text-center mb-4">
                                        <i class="fas fa-camera me-2"></i>
                                        Patient Photo
                                    </h5>
                                    <div class="profile-img-edit">
                                        <img alt="profile-pic" class="profile-pic" id="profilePreview2"
                                            src="../frontend/assets/images/01.png">
                                        <div class="upload-icone" id="uploadIcone2">
                                            <svg class="upload-button icon-20" height="20" viewBox="0 0 24 24"
                                                width="20">
                                                <path
                                                    d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"
                                                    fill="#ffffff" />
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="img-extension text-center">
                                        <small class="text-muted">
                                            Only <strong>.jpg</strong>, <strong>.png</strong>, <strong>.jpeg</strong>
                                            allowed
                                        </small>
                                    </div>
                                </div>
                                <!-- Quick Stats Step 2 -->
                                <div class="mt-4 p-3 bg-light rounded-3">
                                    <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Registration Progress</h6>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progressBar2" role="progressbar"
                                            style="width: 100%"></div>
                                    </div>
                                    <small class="text-muted" id="progressText2">Step 2 of 2 completed</small>
                                </div>
                            </div>
                            <!-- Allergies and Chronic Diseases -->
                            <div class="col-lg-8">
                                <h5 class="mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Additional Information
                                </h5>
                                <div class="two-col-grid">
                                    <!-- Allergies Column -->
                                    <div>
                                        <h6 class="mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Allergies</h6>
                                        <div id="allergiesContainer">
                                            <div class="form-floating mb-2">
                                                <input class="form-control dynamic-input" id="allergyInput1" name="allergies[]"
                                                    placeholder="Enter allergy" type="text">
                                                <label for="allergyInput1">1. Please enter an allergy</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Chronic Diseases Column -->
                                    <div>
                                        <h6 class="mb-3"><i class="fas fa-notes-medical me-2"></i>Chronic Diseases</h6>
                                        <div id="chronicContainer">
                                            <div class="form-floating mb-2">
                                                <input class="form-control dynamic-input" id="chronicInput1"
                                                    name="chronicDiseases[]" placeholder="Enter chronic disease" type="text">
                                                <label for="chronicInput1">1. Please enter a chronic disease</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr class="section-divider">
                                <div class="d-flex justify-content-between mt-4">
                                    <button class="btn btn-outline-secondary" onclick="prevStep()" type="button">
                                        <i class="fas fa-arrow-left me-2"></i> Previous
                                    </button>
                                    <button class="btn btn-submit" id="submitBtn" type="submit">
                                        <i class="fas fa-user-plus me-2"></i> Register Patient
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Step 2 -->
                </form>
                <!-- End Form -->

                <!-- Success Animation -->
                <div class="success-animation" id="successAnimation">
                    <div class="checkmark">
                        <i class="fas fa-check fa-2x text-white"></i>
                    </div>
                    <h4 class="text-success mb-3">Patient Registered Successfully!</h4>
                    <p class="text-muted mb-4">
                        The patient has been added to the system and can now book appointments.
                    </p>
                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-primary" onclick="resetForm()" type="button">
                            <i class="fas fa-plus me-2"></i> Add Another Patient
                        </button>
                        <button class="btn btn-outline-primary" onclick="viewPatients()" type="button">
                            <i class="fas fa-list me-2"></i> View All Patients
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div th:replace="frontend/fragments/footer :: footer"></div>
    <script>
        let currentStep = 1;
        const totalSteps = 2;
        let allergyCount = 1;
        let chronicCount = 1;

        // Avatar upload logic: đồng bộ preview ở cả 2 step, chỉ dùng 1 input file và 1 input hidden
        document.addEventListener('DOMContentLoaded', function () {
            var avatarInput = document.getElementById('avatarUpload');
            var preview1 = document.getElementById('profilePreview1');
            var preview2 = document.getElementById('profilePreview2');
            var uploadIcone1 = document.getElementById('uploadIcone1');
            var uploadIcone2 = document.getElementById('uploadIcone2');
            var avatarBase64 = document.getElementById('avatarBase64');

            // Click vào ảnh hoặc icon ở step nào cũng mở input file
            if (preview1) preview1.style.cursor = 'pointer';
            if (preview2) preview2.style.cursor = 'pointer';
            if (preview1 && avatarInput) preview1.addEventListener('click', function () { avatarInput.click(); });
            if (preview2 && avatarInput) preview2.addEventListener('click', function () { avatarInput.click(); });
            if (uploadIcone1 && avatarInput) uploadIcone1.addEventListener('click', function (e) { if (e.target !== avatarInput) avatarInput.click(); });
            if (uploadIcone2 && avatarInput) uploadIcone2.addEventListener('click', function (e) { if (e.target !== avatarInput) avatarInput.click(); });

            // Khi chọn ảnh, cập nhật cả 2 preview và input hidden
            avatarInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        const base64Data = evt.target.result;
                        if (preview1) preview1.src = base64Data;
                        if (preview2) preview2.src = base64Data;
                        if (avatarBase64) avatarBase64.value = base64Data;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    hideCurrentStep();
                    currentStep++;
                    showCurrentStep();
                    updateStepIndicator();
                    updateProgressBar();
                }
            }
        }
        function prevStep() {
            if (currentStep > 1) {
                hideCurrentStep();
                currentStep--;
                showCurrentStep();
                updateStepIndicator();
                updateProgressBar();
            }
        }
        function hideCurrentStep() {
            const currentFormStep = document.getElementById(`formStep${currentStep}`);
            if (currentFormStep) {
                currentFormStep.style.display = 'none';
                currentFormStep.classList.remove('active');
            }
        }
        function showCurrentStep() {
            const newFormStep = document.getElementById(`formStep${currentStep}`);
            if (newFormStep) {
                newFormStep.style.display = 'block';
                newFormStep.classList.add('active');
            }
        }
        function updateStepIndicator() {
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    stepElement.classList.remove('active', 'completed');
                    if (i < currentStep) {
                        stepElement.classList.add('completed');
                    } else if (i === currentStep) {
                        stepElement.classList.add('active');
                    }
                }
            }
        }
        function updateProgressBar() {
            const pb1 = document.getElementById('progressBar1');
            const pb2 = document.getElementById('progressBar2');
            const pt1 = document.getElementById('progressText1');
            const pt2 = document.getElementById('progressText2');
            if (currentStep === 1) {
                if (pb1) pb1.style.width = '50%';
                if (pt1) pt1.textContent = 'Step 1 of 2 completed';
                if (pb2) pb2.style.width = '0%';
                if (pt2) pt2.textContent = '';
            } else if (currentStep === 2) {
                if (pb2) pb2.style.width = '100%';
                if (pt2) pt2.textContent = 'Step 2 of 2 completed';
                if (pb1) pb1.style.width = '100%';
                if (pt1) pt1.textContent = 'Step 2 of 2 completed';
            }
        }

        // Validate từng field riêng biệt
        function showFieldError(field, message) {
            hideFieldError(field);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback d-block';
            errorDiv.textContent = message;
            if (field.parentNode.classList.contains('form-floating')) {
                field.parentNode.appendChild(errorDiv);
            } else {
                field.after(errorDiv);
            }
        }
        function hideFieldError(field) {
            if (field.parentNode.classList.contains('form-floating')) {
                const err = field.parentNode.querySelector('.invalid-feedback');
                if (err) err.remove();
            } else {
                const next = field.nextElementSibling;
                if (next && next.classList.contains('invalid-feedback')) next.remove();
            }
        }
        function validateField(field) {
            let isValid = true;
            const val = field.value.trim();
            if (field.id === 'fullName') {
                const nameRegex = /^[A-Za-zÀ-ỹ0-9 ]+$/;
                if (
                    !val ||
                    !nameRegex.test(val) ||
                    /\s{2,}/.test(field.value) ||
                    field.value.startsWith(' ') ||
                    field.value.endsWith(' ')
                ) {
                    showFieldError(field, 'Full name must not contain special characters, leading/trailing/multiple spaces.');
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    hideFieldError(field);
                    field.classList.remove('is-invalid');
                }
            }
            if (field.id === 'email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!val || !emailRegex.test(val)) {
                    showFieldError(field, 'Please enter a valid email address.');
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    hideFieldError(field);
                    field.classList.remove('is-invalid');
                }
            }
            if (field.id === 'phoneNumber') {
                const phoneRegex = /^\d{10}$/;
                if (!val || !phoneRegex.test(val)) {
                    showFieldError(field, 'Phone number must be exactly 10 digits and contain only numbers.');
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    hideFieldError(field);
                    field.classList.remove('is-invalid');
                }
            }
            if (field.id === 'dateOfBirth') {
                if (!val) {
                    showFieldError(field, 'Please select date of birth.');
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    const today = new Date();
                    const inputDate = new Date(val);
                    today.setHours(0, 0, 0, 0);
                    if (inputDate > today) {
                        showFieldError(field, 'Date of birth cannot be in the future.');
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        hideFieldError(field);
                        field.classList.remove('is-invalid');
                    }
                }
            }
            if ((field.tagName === 'SELECT' || field.type === 'select-one') && field.hasAttribute('required')) {
                if (!val) {
                    showFieldError(field, 'This field is required.');
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    hideFieldError(field);
                    field.classList.remove('is-invalid');
                }
            }
            if (field.hasAttribute('required') && !val && !['select-one', 'date'].includes(field.type)) {
                showFieldError(field, 'This field is required.');
                field.classList.add('is-invalid');
                isValid = false;
            }
            return isValid;
        }
        function setupRealtimeValidation() {
            ['fullName', 'email', 'phoneNumber', 'dateOfBirth', 'gender', 'address', 'familyRelationship', 'bloodType'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', function () {
                        validateField(field);
                    });
                    field.addEventListener('change', function () {
                        validateField(field);
                    });
                }
            });
        }
        function validateCurrentStep() {
            const currentFormStep = document.getElementById(`formStep${currentStep}`);
            if (!currentFormStep) return false;
            let isValid = true;
            ['fullName', 'email', 'phoneNumber', 'dateOfBirth', 'gender', 'address', 'familyRelationship', 'bloodType'].forEach(id => {
                const field = currentFormStep.querySelector('#' + id);
                if (field && !validateField(field)) isValid = false;
            });
            return isValid;
        }
        document.addEventListener('DOMContentLoaded', function () {
            setupRealtimeValidation();
        });

        // Dynamic Inputs for Step 2
        function addDynamicInput(container, typePrefix, count, labelText) {
            const inputs = container.querySelectorAll('input');
            if (inputs[inputs.length - 1].value.trim() === '') return;
            const div = document.createElement('div');
            div.className = 'form-floating';
            div.style.marginTop = '10px';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control dynamic-input';
            input.id = `${typePrefix}Input${count}`;
            input.name = `${typePrefix}Diseases[]`;
            input.placeholder = `Enter ${typePrefix === 'allergy' ? 'allergy' : 'chronic disease'}`;
            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.innerHTML = `${count}. ${labelText}`;
            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        }
        function initializeBlurEvent(container, typePrefix, labelText) {
            container.addEventListener('blur', function (e) {
                if (e.target && e.target.classList.contains('dynamic-input')) {
                    const inputs = container.querySelectorAll('input.dynamic-input');
                    if (e.target.value.trim() === "" && inputs.length > 1) {
                        e.target.parentElement.remove();
                        updateInputNumbers(container, typePrefix, labelText);
                        if (typePrefix === 'allergy') {
                            allergyCount = container.querySelectorAll('input.dynamic-input').length;
                        } else if (typePrefix === 'chronic') {
                            chronicCount = container.querySelectorAll('input.dynamic-input').length;
                        }
                    }
                }
            }, true);
        }
        function updateInputNumbers(container, typePrefix, labelText) {
            const inputs = container.querySelectorAll('input.dynamic-input');
            inputs.forEach((input, index) => {
                const newCount = index + 1;
                input.id = `${typePrefix}Input${newCount}`;
                const label = input.parentElement.querySelector('label');
                if (label) {
                    label.htmlFor = input.id;
                    label.innerHTML = `${newCount}. ${labelText}`;
                }
            });
        }
        function initializeDynamicInputs() {
            const allergiesContainer = document.getElementById('allergiesContainer');
            allergiesContainer.addEventListener('input', function (e) {
                if (e.target && e.target.classList.contains('dynamic-input')) {
                    const inputs = allergiesContainer.querySelectorAll('input');
                    const lastInput = inputs[inputs.length - 1];
                    if (lastInput.value.trim() !== '') {
                        addDynamicInput(allergiesContainer, 'allergy', ++allergyCount, 'Please enter an allergy');
                    }
                }
            });
            initializeBlurEvent(allergiesContainer, 'allergy', 'Please enter an allergy');
            const chronicContainer = document.getElementById('chronicContainer');
            chronicContainer.addEventListener('input', function (e) {
                if (e.target && e.target.classList.contains('dynamic-input')) {
                    const inputs = chronicContainer.querySelectorAll('input');
                    const lastInput = inputs[inputs.length - 1];
                    if (lastInput.value.trim() !== '') {
                        addDynamicInput(chronicContainer, 'chronic', ++chronicCount, 'Please enter a chronic disease');
                    }
                }
            });
            initializeBlurEvent(chronicContainer, 'chronic', 'Please enter a chronic disease');
        }
        document.addEventListener('DOMContentLoaded', function () {
            initializeDynamicInputs();
        });

        // Submit logic
        document.getElementById('patientForm').addEventListener('submit', function (e) {
            e.preventDefault();
            if (!validateCurrentStep()) return;
            submitForm();
        });

        function submitForm() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registering...';
            submitBtn.disabled = true;
            const patientDTO = {
                userId: document.querySelector('input[name="userId"]').value.trim(),
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                dateOfBirth: document.getElementById('dateOfBirth').value.trim(),
                gender: document.getElementById('gender').value.trim(),
                address: document.getElementById('address').value.trim(),
                familyRelationship: document.getElementById('familyRelationship').value.trim(),
                bloodType: document.getElementById('bloodType').value.trim(),
                avatarBase64: document.getElementById('avatarBase64').value
            };
            const allergiesInputs = document.querySelectorAll('input[name="allergies[]"]');
            const allergies = [];
            allergiesInputs.forEach(input => {
                const val = input.value.trim();
                if (val) allergies.push(val);
            });
            const chronicInputs = document.querySelectorAll('input[name="chronicDiseases[]"]');
            const chronicDiseases = [];
            chronicInputs.forEach(input => {
                const val = input.value.trim();
                if (val) chronicDiseases.push(val);
            });
            const medicalProfileDTO = {
                patientId: null,
                allergies: allergies,
                chronicDiseases: chronicDiseases
            };
            const payload = {
                patientDTO: patientDTO,
                medicalProfileDTO: medicalProfileDTO
            };
            fetch('/api/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/patient/showList/1';
                    } else {
                        return response.text().then(msg => {
                            throw new Error(msg);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('Failed to register patient. Please try again.');
                    resetSubmitButton();
                });
        }
        function showSuccessAnimation() {
            for (let i = 1; i <= totalSteps; i++) {
                const step = document.getElementById(`formStep${i}`);
                if (step) step.style.display = 'none';
            }
            const successAnimation = document.getElementById('successAnimation');
            if (successAnimation) {
                successAnimation.style.display = 'block';
            }
        }
        function showErrorMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
            alert.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> ${message}
                                 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alert);
            setTimeout(() => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            }, 5000);
        }
        function resetSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>Register Patient';
                submitBtn.disabled = false;
            }
        }
        function resetForm() {
            const form = document.getElementById('patientForm');
            if (form) form.reset();
            const preview1 = document.getElementById('profilePreview1');
            const preview2 = document.getElementById('profilePreview2');
            const avatarBase64 = document.getElementById('avatarBase64');
            if (preview1) preview1.src = '../frontend/assets/images/01.png';
            if (preview2) preview2.src = '../frontend/assets/images/01.png';
            if (avatarBase64) avatarBase64.value = '';
            currentStep = 1;
            showCurrentStep();
            updateStepIndicator();
            updateProgressBar();
            const successAnimation = document.getElementById('successAnimation');
            if (successAnimation) successAnimation.style.display = 'none';
        }
        function viewPatients() {
            window.location.href = '/patients';
        }
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.target.matches('textarea')) {
                e.preventDefault();
                if (currentStep < totalSteps) {
                    nextStep();
                } else {
                    document.getElementById('patientForm').dispatchEvent(new Event('submit'));
                }
            }
        });
    </script>
    <script src="../frontend/assets/js/core/libs.min.js"></script>
    <script src="../frontend/assets/vendor/flatpickr/dist/flatpickr.min.js"></script>
    <script defer src="../frontend/assets/js/plugins/flatpickr.js"></script>
    <script src="../frontend/assets/js/plugins/slider-tabs.js"></script>
    <script defer src="../frontend/assets/js/plugins/fslightbox.js"></script>
    <script defer src="../frontend/assets/js/plugins/select2.js"></script>
    <script src="../frontend/assets/vendor/lodash/lodash.min.js"></script>
    <script src="../frontend/assets/js/iqonic-script/utility.min.js"></script>
    <script src="../frontend/assets/js/iqonic-script/setting.min.js"></script>
    <script src="../frontend/assets/js/setting-init.js"></script>
    <script src="../frontend/assets/js/core/external.min.js"></script>
    <script defer src="../frontend/assets/js/charts/widgetcharts.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/charts/dashboard.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/kivicare.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/kivicare-advance.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/sidebar.js"></script>