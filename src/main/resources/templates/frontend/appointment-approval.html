<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống duyệt đơn khám bệnh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --primary-dark: #1d4ed8;
            --secondary: #475569;
            --success: #16a34a;
            --success-light: #dcfce7;
            --warning: #ea580c;
            --warning-light: #ffedd5;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --gray-light: #f8fafc;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f1f5f9; color: var(--text); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary), #1e40af); color: white; padding: 25px 30px; position: relative; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 28px; font-weight: 700; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: #93c5fd; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        .stats-container { display: flex; gap: 20px; margin-top: 15px; }
        .stat-card { background: rgba(255, 255, 255, 0.15); border-radius: 10px; padding: 15px 20px; flex: 1; backdrop-filter: blur(4px); }
        .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .content { padding: 25px 30px; }
        .filters { display: flex; justify-content: space-between; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        .search-box { display: flex; align-items: center; background: var(--gray-light); border-radius: 8px; padding: 0 15px; flex: 1; max-width: 400px; }
        .search-box i { color: var(--text-light); }
        .search-box input { background: transparent; border: none; padding: 12px 15px; width: 100%; font-size: 15px; outline: none; }
        .filter-group { display: flex; gap: 15px; }
        .filter-btn { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 10px 20px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .filter-btn:hover { background: var(--gray-light); border-color: var(--primary); }
        .filter-btn i { font-size: 14px; }
        .conflict-alert { background: var(--warning-light); border: 1px solid var(--warning); border-radius: 8px; padding: 15px 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .conflict-alert i { color: var(--warning); font-size: 24px; }
        .conflict-alert-content h3 { color: var(--warning); margin-bottom: 5px; }
        .conflict-alert-content p { color: var(--text); font-size: 15px; }
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        thead { background: var(--gray-light); }
        th { padding: 16px 15px; text-align: left; font-weight: 600; color: var(--text-light); border-bottom: 1px solid var(--border); font-size: 14px; }
        td { padding: 16px 15px; border-bottom: 1px solid var(--border); font-size: 15px; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background: rgba(241, 245, 249, 0.4); }
        .status-cell { display: flex; align-items: center; gap: 8px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 500; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-conflict { background: #ffedd5; color: #ea580c; }
        .status-accepted { background: #dcfce7; color: #16a34a; }
        .status-cancelled { background: #fee2e2; color: #dc2626; }
        .avatar { width: 40px; height: 40px; border-radius: 8px; background: #e0f2fe; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #0c4a6e; }
        .name-cell { display: flex; align-items: center; gap: 12px; }
        .name-info { display: flex; flex-direction: column; }
        .name-info .name { font-weight: 600; margin-bottom: 3px; }
        .name-info .email { font-size: 13px; color: var(--text-light); }
        .conflict-info { display: flex; align-items: center; gap: 8px; color: var(--warning); font-weight: 500; font-size: 14px; }
        .conflict-info i { font-size: 18px; }
        .date-time { display: flex; flex-direction: column; }
        .date-time .date { font-weight: 500; margin-bottom: 3px; }
        .date-time .time { background: var(--primary-light); color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 13px; font-weight: 500; display: inline-block; width: fit-content; }
        .action-cell { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 500; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #c2410c; }
        .btn-outline { background: transparent; border: 1px solid var(--border); }
        .btn-outline:hover { background: var(--gray-light); }
        .btn-call { background: #10b981; color: white; }
        .btn-call:hover { background: #059669; }
        .btn-sms { background: #8b5cf6; color: white; }
        .btn-sms:hover { background: #7c3aed; }
        .processing-notice { background: #f0f9ff; border: 1px solid #bae6fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #0c4a6e; margin-top: 8px; display: flex; align-items: center; gap: 6px; }
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding: 15px 0; }
        .entries-info { color: var(--text-light); font-size: 14px; }
        .pagination-controls { display: flex; gap: 8px; }
        .pagination-btn { padding: 8px 14px; border-radius: 6px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .pagination-btn:hover { background: var(--gray-light); border-color: var(--primary); }
        .pagination-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-pages { display: flex; gap: 5px; }
        .page-number { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; font-weight: 500; }
        .page-number:hover, .page-number.active { background: var(--primary); color: white; border-color: var(--primary); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.3s; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .modal.active .modal-content { transform: translateY(0); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 12px 12px 0 0; }
        .modal-title { font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .modal-title i { color: var(--warning); }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); transition: color 0.2s; }
        .modal-close:hover { color: var(--danger); }
        .modal-body { padding: 25px; }
        .conflict-patients { display: flex; gap: 20px; margin-bottom: 30px; }
        .patient-card { flex: 1; border: 2px solid var(--border); border-radius: 10px; padding: 20px; background: white; transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden; }
        .patient-card.selected { border: 3px solid var(--primary); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.15); transform: translateY(-5px); }
        .patient-card.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 10px; right: 10px; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .patient-card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .patient-info h3 { margin-bottom: 5px; }
        .patient-info p { color: var(--text-light); font-size: 14px; }
        .contact-actions { display: flex; gap: 10px; margin-top: 15px; }
        .appointment-info { margin-top: 15px; }
        .info-item { display: flex; margin-bottom: 10px; }
        .info-label { width: 120px; color: var(--text-light); font-size: 14px; }
        .info-value { flex: 1; font-weight: 500; }
        .resolve-section { background: #fffbeb; border-radius: 8px; padding: 20px; margin-top: 20px; border: 1px solid #fde68a; }
        .resolve-section h3 { margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: #b45309; }
        .time-suggestion { display: flex; gap: 15px; margin-bottom: 20px; }
        .btn-choose-time.selected, .suggestion-card.selected {
            border: 2px solid var(--primary) !important;
            background: var(--primary-light) !important;
            color: var(--primary) !important;
            font-weight: 600;
        }
        .suggestion-card { border: 1px solid var(--border); border-radius: 8px; padding: 15px; flex: 1; cursor: pointer; transition: all 0.2s; background: white; }
        .suggestion-card:hover { border-color: var(--primary); background: var(--primary-light); }
        .suggestion-card.selected { border: 2px solid var(--primary); background: var(--primary-light); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        .suggestion-time { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
        .suggestion-doctor { color: var(--text-light); font-size: 14px; }
        .resolve-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        .instruction-box { background: #dbeafe; border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 20px; border-radius: 0 6px 6px 0; }
        .instruction-box p { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .instruction-box i { color: var(--primary); min-width: 20px; }
        .selected-patient-info { background: #e0f2fe; padding: 12px 15px; border-radius: 8px; margin-top: 15px; display: none; }
        .selected-patient-info.active { display: block; }
        .highlight { background: #fffbeb; border: 1px dashed #f59e0b; padding: 3px 6px; border-radius: 4px; font-weight: 500; }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="title">Hệ thống duyệt đơn đăng ký khám bệnh</div>
                <div class="user-info">
                    <div class="user-avatar">NV</div>
                    <div>
                        <div class="user-name">Nguyễn Văn A</div>
                        <div class="user-role">Nhân viên duyệt đơn</div>
                    </div>
                </div>
            </div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">Đơn chờ duyệt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="conflictCount">0</div>
                    <div class="stat-label">Đơn có xung đột</div>
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="content">
            <!-- Filters -->
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm bệnh nhân, số điện thoại...">
                </div>
                <div class="filter-group">
                    <div class="filter-btn">
                        <i class="fas fa-filter"></i> Lọc theo trạng thái
                    </div>
                    <div class="filter-btn">
                        <i class="fas fa-calendar"></i> Chọn ngày
                    </div>
                    <div class="filter-btn">
                        <i class="fas fa-user-md"></i> Lọc theo bác sĩ
                    </div>
                </div>
            </div>
            <!-- Conflict Alert -->
            <div class="conflict-alert" id="conflictAlert" style="display:none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="conflict-alert-content">
                    <h3 id="conflictAlertTitle"></h3>
                    <p>Hệ thống đã phát hiện các đơn đăng ký bị xung đột về thời gian và bác sĩ. Vui lòng giải quyết các
                        xung đột này trước khi duyệt đơn.</p>
                </div>
            </div>
            <!-- Appointments Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Bệnh nhân</th>
                            <th>Ngày & Giờ</th>
                            <th>Bác sĩ</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="appointment-tbody">
                        <!-- JS sẽ render -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div class="pagination">
                <div class="entries-info" id="entriesInfo"></div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevPageBtn">
                        <i class="fas fa-chevron-left"></i> Trước
                    </button>
                    <div class="pagination-pages" id="paginationPages"></div>
                    <button class="pagination-btn" id="nextPageBtn">
                        Sau <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Conflict Resolution Modal -->
    <div class="modal" id="conflictModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-handshake"></i>
                    Giải quyết xung đột lịch hẹn
                </div>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="conflictModalBody">
                <!-- JS sẽ render -->
            </div>
        </div>
    </div>
    <!-- Thymeleaf data to JS -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        let allAppointments = /*[[${pendingAppointments}]]*/[];
        let staffId = /*[[${staffId}]]*/0;
        /*]]>*/
    </script>
    <script>
        const API_BASE = `${window.location.origin}/api`;
        const PAGE_SIZE = 10;
        let currentPage = 1;
        let appointments = allAppointments || [];
        let filteredAppointments = appointments;
        let searchValue = "";
        let selectedSuggestion = null;
        let selectedPatientIdx = null;

        function renderTable() {
            const tbody = document.getElementById('appointment-tbody');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * PAGE_SIZE;
            const pageData = filteredAppointments.slice(start, start + PAGE_SIZE);

            pageData.forEach((a, idx) => {
                const isConflict = a.status === 'Conflict' || (a.appointmentConflictIds?.length > 0);
                let conflictInfo = '';
                if (isConflict && a.appointmentConflictIds?.length) {
                    conflictInfo = `<div class="conflict-info">
                          <i class="fas fa-exclamation-circle"></i>
                          Xung đột với đơn #${a.appointmentConflictIds.join(', #')}
                        </div>`;
                }
                tbody.innerHTML += `
        <tr>
          <td>${start + idx + 1}</td>
          <td>
            <div class="name-cell">
              <div class="avatar">
                ${a.patientAvatarBase64
                        ? `<img src="data:image/png;base64,${a.patientAvatarBase64}"
                         alt="avatar" style="width:40px;height:40px;border-radius:8px;object-fit:cover;">`
                        : (a.patientName
                            ? a.patientName.split(' ')
                                .map(x => x[0]).join('').toUpperCase().slice(0, 2)
                            : '')
                    }
              </div>
              <div class="name-info">
                <div class="name">${a.patientName || ''}</div>
                <div class="email">${a.patientEmail || ''}</div>
                <div class="phone">${a.patientPhoneNumber || ''}</div>
              </div>
            </div>
            ${conflictInfo}
          </td>
          <td>
            <div class="date-time">
              <div class="date">${a.date || ''}</div>
              <div class="time">${a.startTime || ''}</div>
            </div>
          </td>
          <td>${a.doctorName || ''}</td>
          <td>
            <div class="status-cell">
              <div class="status-badge ${isConflict ? 'status-conflict' : 'status-pending'}">
                ${isConflict ? 'Xung đột' : 'Chờ duyệt'}
              </div>
            </div>
          </td>
          <td>
            <div class="action-cell">
              ${isConflict
                        ? `<button class="btn btn-warning btn-sm btn-resolve" data-id="${a.appointmentId}">
                     <i class="fas fa-handshake"></i> Giải quyết
                   </button>`
                        : `<button class="btn btn-success btn-sm btn-confirm" data-id="${a.appointmentId}">
                     <i class="fas fa-check"></i> Duyệt
                   </button>
                   <button class="btn btn-danger btn-sm btn-cancel" data-id="${a.appointmentId}">
                     <i class="fas fa-times"></i> Từ chối
                   </button>`
                    }
            </div>
          </td>
        </tr>`;
            });

            document.querySelectorAll('.btn-confirm').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm('Bạn có chắc chắn muốn duyệt đơn này?')) return;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang duyệt...';
                    try {
                        const res = await fetch(`${API_BASE}/appointment/confirm/${btn.dataset.id}?scheduleCoordinatorId=${staffId}`, {
                            method: 'PATCH'
                        });
                        if (res.ok) window.location.reload();
                        else alert('Lỗi: ' + await res.text());
                    } catch {
                        alert('Có lỗi xảy ra khi duyệt đơn!');
                    }
                };
            });
            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm('Bạn có chắc chắn muốn từ chối đơn này?')) return;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang từ chối...';
                    try {
                        const res = await fetch(`${API_BASE}/appointment/cancel/${btn.dataset.id}?scheduleCoordinatorId=381`, {
                            method: 'PATCH'
                        });
                        if (res.ok) window.location.reload();
                        else alert('Lỗi: ' + await res.text());
                    } catch {
                        alert('Có lỗi xảy ra khi từ chối đơn!');
                    }
                };
            });
            document.querySelectorAll('.btn-resolve').forEach(btn => {
                btn.onclick = function () {
                    const id = btn.getAttribute('data-id');
                    openConflictModal(parseInt(id));
                };
            });
        }

        function renderPagination() {
            const total = filteredAppointments.length;
            const pages = Math.ceil(total / PAGE_SIZE);
            const wrap = document.getElementById('paginationPages');
            wrap.innerHTML = '';
            for (let i = 1; i <= pages; i++) {
                const div = document.createElement('div');
                div.className = 'page-number' + (i === currentPage ? ' active' : '');
                div.textContent = i;
                div.onclick = () => {
                    currentPage = i;
                    renderTable();
                    renderPagination();
                    renderEntriesInfo();
                };
                wrap.appendChild(div);
            }
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === pages || pages === 0;
        }
        function renderEntriesInfo() {
            const total = filteredAppointments.length;
            const start = total === 0 ? 0 : (currentPage - 1) * PAGE_SIZE + 1;
            const end = Math.min(currentPage * PAGE_SIZE, total);
            document.getElementById('entriesInfo')
                .textContent = `Hiển thị ${start} đến ${end} của ${total} đơn`;
        }
        function renderStats() {
            document.getElementById('pendingCount').textContent = appointments.length;
        }
        function renderConflictAlert() {
            const count = appointments.filter(a =>
                a.status === 'Conflict' || (a.appointmentConflictIds?.length > 0)
            ).length;
            const alertDiv = document.getElementById('conflictAlert');
            if (count > 0) {
                alertDiv.style.display = '';
                document.getElementById('conflictAlertTitle')
                    .textContent = `Phát hiện ${count} đơn đăng ký bị trùng lịch`;
            } else {
                alertDiv.style.display = 'none';
            }
            document.getElementById('conflictCount').textContent = count;
        }

        // --- OPEN CONFLICT MODAL ---
        async function openConflictModal(appointmentId) {
            const main = appointments.find(a => a.appointmentId === appointmentId);
            if (!main?.appointmentConflictIds?.length) return;

            let html = `
      <div class="instruction-box">
        <p><i class="fas fa-info-circle"></i> <strong>Hướng dẫn giải quyết xung đột:</strong></p>
        <p><i class="fas fa-arrow-right"></i> Chọn 1 bệnh nhân để điều chỉnh lịch hẹn (bệnh nhân này sẽ được gọi điện để thương lượng)</p>
        <p><i class="fas fa-arrow-right"></i> Chọn khung giờ mới đề xuất cho bệnh nhân</p>
        <p><i class="fas fa-arrow-right"></i> Xác nhận thay đổi hoặc hủy bỏ đơn khi cần thiết</p>
      </div>
      <div class="conflict-patients">`;

            const conflictList = [main, ...appointments.filter(a => main.appointmentConflictIds.includes(a.appointmentId))];
            conflictList.forEach((a, idx) => {
                html += `
        <div class="patient-card" id="modal-patient${idx}"
             data-patient-id="${a.patientId}"
             data-doctor-id="${a.doctorId}"
             data-date="${a.date}"
             data-appointment-id="${a.appointmentId}">
          <input type="hidden" class="doctor-id-input" value="${a.doctorId}">
          <div class="patient-card-header">
            <div class="avatar">
              ${a.patientAvatarBase64
                        ? `<img src="data:image/png;base64,${a.patientAvatarBase64}"
                       alt="avatar" style="width:40px;height:40px;border-radius:8px;object-fit:cover;">`
                        : (a.patientName
                            ? a.patientName.split(' ')
                                .map(x => x[0]).join('').toUpperCase().slice(0, 2)
                            : '')
                    }
            </div>
            <div class="patient-info">
              <h3>${a.patientName || ''}</h3>
              <p>${a.patientEmail || ''}</p>
              <p>${a.patientPhoneNumber || ''}</p>
            </div>
          </div>
          <div class="appointment-info">
            <div class="info-item">
              <div class="info-label">Ngày giờ:</div>
              <div class="info-value">${a.date || ''}, ${a.startTime || ''}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Bác sĩ:</div>
              <div class="info-value doctor-name">${a.doctorName || ''}</div>
            </div>
          </div>
          <div class="contact-actions">
            <button class="btn btn-call btn-sm"><i class="fas fa-phone"></i> Gọi điện</button>
            <button class="btn btn-sms btn-sm"><i class="fas fa-comment-sms"></i> Nhắn tin</button>
          </div>
        </div>`;
            });

            html += `</div>
      <div class="selected-patient-info" id="selectedPatientInfo" style="display:none;">
        Bạn đang chọn điều chỉnh lịch hẹn cho: <span class="highlight" id="selectedPatientName"></span>
      </div>
      <div class="resolve-section">
        <h3><i class="fas fa-calendar-check"></i> Đề xuất lịch mới cho bệnh nhân được chọn</h3>
        <div class="time-suggestion" id="suggestionCardsContainer"></div>
        <div class="resolve-actions">
          <button class="btn btn-outline" id="cancelBtn"><i class="fas fa-times"></i> Hủy bỏ</button>
          <button class="btn btn-danger" id="rejectBtn"><i class="fas fa-ban"></i> Từ chối đơn</button>
          <button class="btn btn-primary" id="confirmBtn"><i class="fas fa-check"></i> Xác nhận thay đổi</button>
        </div>
      </div>
    `;
            document.getElementById('conflictModalBody').innerHTML = html;
            document.getElementById('conflictModal').classList.add('active');

            document.querySelectorAll('.patient-card').forEach((card, idx) => {
                card.onclick = async () => {
                    document.querySelectorAll('.patient-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedPatientIdx = idx;
                    const name = card.querySelector('h3').textContent;
                    document.getElementById('selectedPatientName').textContent = name;
                    document.getElementById('selectedPatientInfo').style.display = '';

                    const doctorId = card.dataset.doctorId;
                    const patientId = card.dataset.patientId;
                    let date = card.dataset.date;

                    if (!doctorId || !patientId || !date) {
                        document.getElementById('suggestionCardsContainer')
                            .innerHTML = '<div class="text-danger">Không đủ thông tin để lấy lịch trống.</div>';
                        return;
                    }

                    let availableDate = date.includes('T') ? date : `${date}T00:00:00`;
                    const encodedDate = encodeURIComponent(availableDate);
                    const url = `${API_BASE}/schedule/staff/${doctorId}/patient/${patientId}/date/${encodedDate}`;
                    const ctn = document.getElementById('suggestionCardsContainer');
                    ctn.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> Đang tải lịch trống...</div>';

                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
                        });
                        if (!res.ok) {
                            const txt = await res.text();
                            throw new Error(`API lỗi ${res.status}: ${txt}`);
                        }
                        const data = await res.json();
                        const doc = data.availableTimes;
                        if (!doc.availableTimes.length) {
                            ctn.innerHTML = '<div class="text-warning">Không có khung giờ trống phù hợp.</div>';
                            return;
                        }
                        ctn.innerHTML = `
            <div class="doctor-available-card">
              <div class="doctor-name"><i class="fas fa-user-md"></i> ${doc.staffName}</div>
              <div class="doctor-times" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                ${doc.availableTimes.map(ts => {
                            const d = new Date(ts);
                            return `<button class="btn btn-outline btn-sm btn-choose-time"
                    data-doctor-id="${doc.staffId}"
                    data-doctor-name="${doc.staffName}"
                    data-available-time="${d.toISOString()}"
                    style="transition: border 0.2s;">
                      ${d.toLocaleDateString('vi-VN')}, ${d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}
                   </button>`;
                        }).join('')}
              </div>
            </div>`;
                        document.querySelectorAll('.btn-choose-time').forEach(btn => {
                            btn.onclick = () => {
                                document.querySelectorAll('.btn-choose-time').forEach(c => c.classList.remove('selected'));
                                btn.classList.add('selected');
                                selectedSuggestion = {
                                    doctorId: btn.dataset.doctorId,
                                    doctorName: btn.dataset.doctorName,
                                    availableTime: btn.dataset.availableTime
                                };
                            };
                        });
                    } catch (err) {
                        ctn.innerHTML = `<div class="text-danger">
            <i class="fas fa-exclamation-triangle"></i> Lỗi khi tải lịch trống: ${err.message}
          </div>`;
                    }
                };
            });

            const first = document.querySelector('.patient-card');
            if (first) first.click();

            document.getElementById('confirmBtn').onclick = async () => {
                if (selectedPatientIdx === null) {
                    alert('Vui lòng chọn một bệnh nhân để điều chỉnh lịch');
                    return;
                }
                if (!selectedSuggestion) {
                    alert('Vui lòng chọn khung giờ đề xuất');
                    return;
                }
                const appointmentId = conflictList[selectedPatientIdx]?.appointmentId;
                if (!appointmentId) {
                    alert('Không tìm thấy mã đơn để đổi lịch.');
                    return;
                }
                function formatDateTime(isoString) {
                    const d = new Date(isoString);
                    const pad = n => n.toString().padStart(2, '0');
                    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
                }
                const changeAppointmentDTO = {
                    appointmentId: appointmentId,
                    staffScheduleId: 381,
                    doctorId: selectedSuggestion.doctorId,
                    appointmentDate: formatDateTime(selectedSuggestion.availableTime),
                    appointmentStatus: "CONFIRMED"
                };
                try {
                    const res = await fetch(`${API_BASE}/appointment/change`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(changeAppointmentDTO)
                    });
                    if (res.ok) {
                        alert('Đã xác nhận thay đổi lịch thành công!');
                        window.location.reload();
                    } else {
                        alert('Lỗi: ' + await res.text());
                    }
                } catch (e) {
                    alert('Có lỗi xảy ra khi đổi lịch!');
                }
                document.getElementById('conflictModal').classList.remove('active');
            };
            document.getElementById('rejectBtn').onclick = async () => {
                if (selectedPatientIdx === null) {
                    alert('Vui lòng chọn một bệnh nhân để từ chối');
                    return;
                }
                const selectedCard = document.querySelectorAll('.patient-card')[selectedPatientIdx];
                if (!selectedCard) {
                    alert('Không tìm thấy thông tin bệnh nhân.');
                    return;
                }
                const appointmentId = selectedCard.getAttribute('data-appointment-id');
                if (!appointmentId) {
                    alert('Không tìm thấy mã đơn để từ chối.');
                    return;
                }
                if (confirm(`Bạn có chắc chắn muốn từ chối đơn đăng ký của ${document.getElementById('selectedPatientName').textContent}?`)) {
                    try {
                        const res = await fetch(`${API_BASE}/appointment/cancel/${appointmentId}?scheduleCoordinatorId=381`, {
                            method: 'PATCH'
                        });
                        if (res.ok) {
                            alert('Đã từ chối đơn đăng ký thành công!');
                            window.location.reload();
                        } else {
                            alert('Lỗi: ' + await res.text());
                        }
                    } catch (e) {
                        alert('Có lỗi xảy ra khi từ chối đơn!');
                    }
                    document.getElementById('conflictModal').classList.remove('active');
                }
            };
            document.getElementById('cancelBtn').onclick = () => {
                document.getElementById('conflictModal').classList.remove('active');
            };
        }

        document.getElementById('searchInput').addEventListener('input', function () {
            searchValue = this.value.trim().toLowerCase();
            filteredAppointments = appointments.filter(a =>
                (a.patientName && a.patientName.toLowerCase().includes(searchValue)) ||
                (a.patientPhoneNumber && a.patientPhoneNumber.toLowerCase().includes(searchValue)) ||
                (a.patientEmail && a.patientEmail.toLowerCase().includes(searchValue))
            );
            currentPage = 1;
            renderTable();
            renderPagination();
            renderEntriesInfo();
        });

        document.getElementById('prevPageBtn').onclick = function () {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                renderPagination();
                renderEntriesInfo();
            }
        };
        document.getElementById('nextPageBtn').onclick = function () {
            const pageCount = Math.ceil(filteredAppointments.length / PAGE_SIZE);
            if (currentPage < pageCount) {
                currentPage++;
                renderTable();
                renderPagination();
                renderEntriesInfo();
            }
        };

        function init() {
            filteredAppointments = appointments;
            renderStats();
            renderConflictAlert();
            renderTable();
            renderPagination();
            renderEntriesInfo();
        }
        window.onload = init;
        document.getElementById('closeModalBtn').onclick = () =>
            document.getElementById('conflictModal').classList.remove('active');
        window.addEventListener('click', e => {
            if (e.target === document.getElementById('conflictModal'))
                document.getElementById('conflictModal').classList.remove('active');
        });
    </script>
</body>
</html>