<!DOCTYPE html>
<html layout:decorate="~{/frontend/layouts/main-layout}"
      th:with="navActive = ${'manage'}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản Lý Cuộc Hẹn</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="section-padding">
        <div class="container">
            <!-- Bộ lọc trạng thái -->
            <div class="bg-white shadow-sm rounded-4 p-3 d-flex align-items-center gap-3">
                <label class="mb-0 fw-bold" for="status-filter">Lọc theo trạng thái:</label>
                <select id="status-filter" class="form-select w-auto">
                    <option value="">Tất cả</option>
                    <option value="PENDING" th:selected="${currentStatus == 'PENDING'}">Chờ duyệt</option>
                    <option value="CONFIRMED" th:selected="${currentStatus == 'CONFIRMED'}">Đã xác nhận</option>
                    <option value="CANCELLED" th:selected="${currentStatus == 'CANCELLED'}">Đã hủy</option>
                    <option value="IN_PROGRESS" th:selected="${currentStatus == 'IN_PROGRESS'}">Đang khám</option>
                    <option value="COMPLETED" th:selected="${currentStatus == 'COMPLETED'}">Đã hoàn thành</option>
                    <option value="CONFLICTED" th:selected="${currentStatus == 'CONFLICTED'}">Xung đột lịch</option>
                </select>
            </div>
            <!-- Bảng danh sách lịch hẹn -->
            <div class="row">
                <div class="col-12">
                    <div class="bg-white shadow-sm rounded-4 p-0">
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th>STT</th>
                                    <th>Tên bệnh nhân</th>
                                    <th>Quan hệ</th>
                                    <th>Bác sĩ</th>
                                    <th>Dịch vụ</th>
                                    <th>Thời gian bắt đầu</th>
                                    <th>Trạng thái</th>
                                    <th>Kết quả</th>
                                    <th>Hành động</th>
                                </tr>
                                </thead>
                                <tbody id="appointment-table-body">
                                <tr th:each="appointment, iterStat : ${appointments}">
                                    <td th:text="${iterStat.index + 1}">1</td>
                                    <td th:text="${appointment.patientName}">Courtney Henry</td>
                                    <td th:text="${appointment.relationship}">Bản thân</td>
                                    <td th:text="${appointment.doctorName}">BS. Nguyễn Văn A</td>
                                    <td th:text="${appointment.serviceName}">Khám tổng quát</td>
                                    <td th:text="${appointment.startTime}">24/05/2023 10:00 SA</td>
                                    <td>
                                        <span th:switch="${appointment.status}">
                                            <span th:case="'PENDING'" class="badge bg-warning text-dark">Chờ duyệt</span>
                                            <span th:case="'CONFIRMED'" class="badge bg-primary">Đã xác nhận</span>
                                            <span th:case="'CANCELLED'" class="badge bg-secondary">Đã hủy</span>
                                            <span th:case="'IN_PROGRESS'" class="badge bg-info text-dark">Đang khám</span>
                                            <span th:case="'COMPLETED'" class="badge bg-success">Đã hoàn thành</span>
                                            <span th:case="'CONFLICTED'" class="badge bg-danger">Xung đột lịch</span>
                                            <span th:case="*">Không xác định</span>
                                        </span>
                                    </td>
                                    <td>
                                        <a th:if="${appointment.resultUrl != null}"
                                           th:href="${appointment.resultUrl}"
                                           class="btn btn-link p-0">Xem kết quả</a>
                                        <span th:unless="${appointment.resultUrl != null}"
                                              class="text-muted">Chưa có</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm"
                                                th:onclick="'cancelAppointment(' + ${appointment.id} + ')'">Hủy
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Phân trang -->
            <div class="row mt-4">
                <div class="col-12 d-flex justify-content-center">
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item" th:classappend="${pageIndex == 0} ? 'disabled'">
                                <button class="page-link" id="prev-page">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            </li>
                            <th:block th:each="i : ${#numbers.sequence(0, totalPages-1)}">
                                <li class="page-item" th:classappend="${i == pageIndex} ? 'active'">
                                    <button class="page-link"
                                            th:onclick="'changePage(' + ${i} + ')'"
                                            th:text="${i+1}">1
                                    </button>
                                </li>
                            </th:block>
                            <li class="page-item" th:classappend="${pageIndex == totalPages-1} ? 'disabled'">
                                <button class="page-link" id="next-page">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="custom-js">
    <script>
        // Hiển thị loading
        function showLoading() {
            $("#loading").show();
        }

        // Ẩn loading
        function hideLoading() {
            $("#loading").hide();
        }

        // Hàm tải lại bảng bằng AJAX
        function loadAppointments(pageIndex, status) {
            showLoading();

            $.ajax({
                url: "/patient/list-appointment",
                type: "GET",
                data: {
                    pageIndex: pageIndex,
                    status: status
                },
                success: function (data) {
                    // Cập nhật nội dung bảng
                    $("#appointment-table-body").html($(data).find("#appointment-table-body").html());

                    // Cập nhật phân trang
                    $(".pagination").html($(data).find(".pagination").html());

                    // Cập nhật số lượng cuộc hẹn
                    $(".appointment-count").text($(data).find(".appointment-count").text());

                    hideLoading();
                },
                error: function () {
                    alert("Đã xảy ra lỗi khi tải dữ liệu");
                    hideLoading();
                }
            });
        }

        // Lọc theo trạng thái
        $("#status-filter").change(function () {
            const status = $(this).val();
            loadAppointments(0, status);
        });

        // Chuyển trang
        function changePage(pageIndex) {
            const status = $("#status-filter").val();
            loadAppointments(pageIndex, status);
        }

        // Nút trang trước
        $("#prev-page").click(function () {
            const currentPage = [[${pageIndex}]];
            if (currentPage > 0) {
                changePage(currentPage - 1);
            }
        });

        // Nút trang sau
        $("#next-page").click(function () {
            const currentPage = [[${pageIndex}]];
            const totalPages = [[${totalPages}]];
            if (currentPage < totalPages - 1) {
                changePage(currentPage + 1);
            }
        });

        // Hủy cuộc hẹn
        function cancelAppointment(appointmentId) {
            if (confirm("Bạn có chắc chắn muốn hủy cuộc hẹn này?")) {
                // Gọi API hủy cuộc hẹn
                $.ajax({
                    url: "/api/patient/cancel-appointment/" + appointmentId,
                    type: "PATCH",
                    success: function () {
                        alert("Hủy cuộc hẹn thành công!");
                        // Tải lại dữ liệu
                        const status = $("#status-filter").val();
                        const currentPage = [[${pageIndex}]];
                        loadAppointments(currentPage, status);
                    },
                    error: function () {
                        alert("Đã xảy ra lỗi khi hủy cuộc hẹn");
                    }
                });
            }
        }

        // Khởi tạo giá trị filter từ server
        $(document).ready(function () {
            const currentStatus = "[[${currentStatus}]]";
            if (currentStatus) {
                $("#status-filter").val(currentStatus);
            }
        });
    </script>
</th:block>
</body>
</html>